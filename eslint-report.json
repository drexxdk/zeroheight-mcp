[{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\check-database-types.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":104,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":104,"endColumn":37}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\nimport { readFileSync, writeFileSync } from \"fs\";\r\nimport { join } from \"path\";\r\n\r\n// This script regenerates `src/database.types.ts` in-memory and compares it\r\n// with the on-disk file. Exit code 0 if identical, 1 if different.\r\n\r\nfunction extractTableNames(): string[] {\r\n  const schemaPath = join(process.cwd(), \"src\", \"database.schema.ts\");\r\n  const content = readFileSync(schemaPath, \"utf-8\");\r\n\r\n  const tablesStart = content.indexOf(\"Tables: {\");\r\n  if (tablesStart === -1) return [];\r\n\r\n  let braceCount = 0;\r\n  let endIndex = tablesStart + 9;\r\n  for (let i = endIndex; i < content.length; i++) {\r\n    if (content[i] === \"{\") braceCount++;\r\n    if (content[i] === \"}\") {\r\n      braceCount--;\r\n      if (braceCount === -1) {\r\n        endIndex = i;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  const tablesContent = content.substring(tablesStart + 9, endIndex);\r\n  const tableNames: string[] = [];\r\n  const lines = tablesContent.split(\"\\n\");\r\n  for (const line of lines) {\r\n    const trimmed = line.trim();\r\n    if (trimmed && !trimmed.startsWith(\"//\") && trimmed.includes(\": {\")) {\r\n      const tableName = trimmed.split(\":\")[0].trim();\r\n      if (\r\n        tableName &&\r\n        tableName !== \"Row\" &&\r\n        tableName !== \"Insert\" &&\r\n        tableName !== \"Update\"\r\n      ) {\r\n        tableNames.push(tableName);\r\n      }\r\n    }\r\n  }\r\n  return tableNames;\r\n}\r\n\r\nfunction mapTypeToZod(tsType: string): string {\r\n  if (tsType.includes(\" | null\")) {\r\n    const baseType = tsType.replace(\" | null\", \"\");\r\n    return `${mapTypeToZod(baseType)}.nullable()`;\r\n  }\r\n  switch (tsType) {\r\n    case \"string\":\r\n      return \"z.string()\";\r\n    case \"number\":\r\n      return \"z.number()\";\r\n    case \"boolean\":\r\n      return \"z.boolean()\";\r\n    default:\r\n      return \"z.any()\";\r\n  }\r\n}\r\n\r\nfunction parseTableRow(\r\n  tableName: string,\r\n  content: string,\r\n): Record<string, string> {\r\n  const tableRegex = new RegExp(\r\n    `${tableName}:\\\\s*{([\\\\s\\\\S]*?)}\\\\s*},?\\\\s*(?=\\\\w+:|$)`,\r\n    \"i\",\r\n  );\r\n  const tableMatch = content.match(tableRegex);\r\n  if (!tableMatch) return {};\r\n  const tableContent = tableMatch[1];\r\n  const rowRegex = /Row:\\s*{([^{}]*(?:{[^{}]*}[^{}]*)*)}/;\r\n  const rowMatch = tableContent.match(rowRegex);\r\n  if (!rowMatch) return {};\r\n  const rowContent = rowMatch[1];\r\n  const fields: Record<string, string> = {};\r\n  const fieldRegex = /(\\w+):\\s*([^;\\n]+)/g;\r\n  let match;\r\n  while ((match = fieldRegex.exec(rowContent)) !== null) {\r\n    const fieldName = match[1];\r\n    const fieldType = match[2].trim();\r\n    fields[fieldName] = fieldType;\r\n  }\r\n  return fields;\r\n}\r\n\r\nfunction generateZodSchema(tableName: string): string {\r\n  const schemaPath = join(process.cwd(), \"src\", \"database.schema.ts\");\r\n  const content = readFileSync(schemaPath, \"utf-8\");\r\n  const fields = parseTableRow(tableName, content);\r\n  if (Object.keys(fields).length === 0) {\r\n    return `z.object({\\n  id: z.number(),\\n  // Could not parse table schema\\n})`;\r\n  }\r\n  const fieldDefs = Object.entries(fields)\r\n    .map(([field, type]) => `  ${field}: ${mapTypeToZod(type)},`)\r\n    .join(\"\\n\");\r\n  return `z.object({\\n${fieldDefs}\\n})`;\r\n}\r\n\r\nfunction generateSchemasFromDatabase() {\r\n  const tableNames = extractTableNames();\r\n  const schemas: string[] = [];\r\n  const types: string[] = [];\r\n  tableNames.forEach((tableName) => {\r\n    const schemaName = `public${tableName.charAt(0).toUpperCase() + tableName.slice(1)}Schema`;\r\n    const typeName = `${tableName.charAt(0).toUpperCase() + tableName.slice(1)}Type`;\r\n    schemas.push(\r\n      `export const ${schemaName} = ${generateZodSchema(tableName)};`,\r\n    );\r\n    types.push(`export type ${typeName} = z.infer<typeof ${schemaName}>;`);\r\n  });\r\n  return { schemas, types };\r\n}\r\n\r\nconst { schemas, types } = generateSchemasFromDatabase();\r\nconst schemasContent = `import { z } from 'zod';\r\nimport type { Database } from './database.schema';\r\n\r\n// Auto-generated Zod schemas based on database.schema.ts\r\n\r\n${schemas.join(\"\\n\\n\")}\r\n\r\n// Export inferred types\r\n${types.join(\"\\n\")}\r\n\r\n// Database type for reference\r\nexport type SupabaseDatabase = Database;\r\n`;\r\n\r\nconst outputPath = join(process.cwd(), \"src\", \"database.types.ts\");\r\nconst current = readFileSync(outputPath, \"utf-8\");\r\nif (current !== schemasContent) {\r\n  console.error(\r\n    \"src/database.types.ts is out of date. Run 'npx tsx scripts/generate-database-types.ts' to regenerate.\",\r\n  );\r\n  // Write a diagnostics file to help debugging\r\n  const tmpDir = join(process.cwd(), \"tmp\");\r\n  try {\r\n    // ensure tmp directory exists\r\n    await (async () => {\r\n      const { mkdirSync } = await import(\"fs\");\r\n      mkdirSync(tmpDir, { recursive: true });\r\n    })();\r\n  } catch {\r\n    // ignore\r\n  }\r\n  writeFileSync(\r\n    join(process.cwd(), \"tmp\", \"expected-database.types.ts\"),\r\n    schemasContent,\r\n    \"utf-8\",\r\n  );\r\n  process.exit(1);\r\n}\r\n\r\nconsole.log(\"src/database.types.ts is up to date.\");\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\clear-data.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":17,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":17,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Test script to call the `clear-database` MCP tool on the local server.\r\n * Usage: npx tsx src/e2e/maintenance-clear-data.test.ts\r\n */\r\nimport { config } from \"dotenv\";\r\n\r\n// Load environment variables before importing app code that reads them\r\nconfig({ path: \".env.local\" });\r\n\r\n// Import config after dotenv has been loaded so `src/lib/config.ts`\r\n// reads the environment correctly at module initialization.\r\nconst { ZEROHEIGHT_MCP_ACCESS_TOKEN, MCP_URL } =\r\n  await import(\"../src/utils/config\");\r\n\r\nasync function main() {\r\n  if (!ZEROHEIGHT_MCP_ACCESS_TOKEN) {\r\n    console.error(\r\n      \"‚ùå Error: ZEROHEIGHT_MCP_ACCESS_TOKEN environment variable not set\",\r\n    );\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log(`Calling clear-database (destructive) ...`);\r\n\r\n  const body = JSON.stringify({\r\n    jsonrpc: \"2.0\",\r\n    id: 1,\r\n    method: \"tools/call\",\r\n    params: {\r\n      name: \"clear-database\",\r\n      arguments: { apiKey: ZEROHEIGHT_MCP_ACCESS_TOKEN },\r\n    },\r\n  });\r\n\r\n  try {\r\n    const res = await fetch(MCP_URL, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"X-API-Key\": ZEROHEIGHT_MCP_ACCESS_TOKEN,\r\n        Accept: \"application/json, text/event-stream\",\r\n      },\r\n      body,\r\n    });\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);\r\n    const text = await res.text();\r\n    try {\r\n      const parsed = JSON.parse(text);\r\n      console.log(JSON.stringify(parsed, null, 2));\r\n    } catch {\r\n      console.log(\"Response:\\n\", text);\r\n    }\r\n  } catch (e) {\r\n    console.error(\r\n      \"Request failed:\",\r\n      e instanceof Error ? e.message : String(e),\r\n    );\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\codemods\\guard-record-casts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\debug\\probe-image.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":5,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":5,"endColumn":20},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":18,"column":5,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":18,"endColumn":20}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nexport {};\r\n\r\nasync function main() {\r\n  const argv = process.argv.slice(2);\r\n  if (argv.length === 0) {\r\n    console.error(\"Usage: npx tsx scripts/debug/probe-image.ts <url>\");\r\n    process.exit(1);\r\n  }\r\n  const url = argv[0];\r\n  try {\r\n    const res = await fetch(url);\r\n    console.error(\"HTTP\", res.status, res.statusText);\r\n    const cl = res.headers.get(\"content-length\");\r\n    console.error(\"Content-Length:\", cl);\r\n    const buf = new Uint8Array(await res.arrayBuffer());\r\n    function readBE(bytes: Uint8Array, off: number) {\r\n      return (\r\n        ((bytes[off] << 24) |\r\n          (bytes[off + 1] << 16) |\r\n          (bytes[off + 2] << 8) |\r\n          bytes[off + 3]) >>>\r\n        0\r\n      );\r\n    }\r\n    if (\r\n      buf.length >= 24 &&\r\n      buf[0] === 0x89 &&\r\n      buf[1] === 0x50 &&\r\n      buf[2] === 0x4e &&\r\n      buf[3] === 0x47\r\n    ) {\r\n      const width = readBE(buf, 16);\r\n      const height = readBE(buf, 20);\r\n      console.log(\"format: PNG\");\r\n      console.log(\"intrinsic:\", `${width}x${height}`);\r\n      console.log(\"bytes:\", buf.length);\r\n      return;\r\n    }\r\n    if (buf.length >= 4 && buf[0] === 0xff && buf[1] === 0xd8) {\r\n      // JPEG: scan for SOF markers\r\n      let i = 2;\r\n      let found = false;\r\n      while (i + 9 < buf.length) {\r\n        if (buf[i] !== 0xff) {\r\n          i++;\r\n          continue;\r\n        }\r\n        const marker = buf[i + 1];\r\n        const len = (buf[i + 2] << 8) | buf[i + 3];\r\n        if (marker >= 0xc0 && marker <= 0xc3) {\r\n          const height = (buf[i + 5] << 8) | buf[i + 6];\r\n          const width = (buf[i + 7] << 8) | buf[i + 8];\r\n          console.log(\"format: JPEG\");\r\n          console.log(\"intrinsic:\", `${width}x${height}`);\r\n          console.log(\"bytes:\", buf.length);\r\n          found = true;\r\n          break;\r\n        }\r\n        i += 2 + len;\r\n      }\r\n      if (!found)\r\n        console.log(\r\n          \"format: JPEG (dimensions not found in scanned bytes)\",\r\n          \"bytes:\",\r\n          buf.length,\r\n        );\r\n      return;\r\n    }\r\n    console.log(\"unknown format - first bytes:\", buf.slice(0, 16));\r\n    console.log(\"bytes:\", buf.length);\r\n  } catch (e) {\r\n    console.error(\"fetch failed:\", e instanceof Error ? e.message : e);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\debug\\puppeteer-inspect.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":26,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":26,"endColumn":23},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":36,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":36,"endColumn":20}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport { config as dotenvConfig } from \"dotenv\";\r\ndotenvConfig({ path: \".env.local\" });\r\n\r\nimport { HTTPRequest, HTTPResponse } from \"puppeteer\";\r\nimport {\r\n  launchBrowser as sharedLaunchBrowser,\r\n  attachDefaultInterception,\r\n} from \"../../src/tools/scraper/utils/puppeteer\";\r\n\r\ntype ReqRecord = {\r\n  id: number;\r\n  url: string;\r\n  method: string;\r\n  resourceType: string;\r\n  status?: number | null;\r\n  failure?: string | null;\r\n  headers?: Record<string, string | string[]>;\r\n  responseSize?: number | null;\r\n  timestamp: number;\r\n};\r\n\r\nfunction parseBlockArg(arg?: string) {\r\n  if (!arg) return new Set<string>();\r\n  return new Set(\r\n    arg\r\n      .split(\",\")\r\n      .map((s) => s.trim().toLowerCase())\r\n      .filter(Boolean),\r\n  );\r\n}\r\n\r\nasync function main() {\r\n  const argv = process.argv.slice(2);\r\n  if (argv.length === 0) {\r\n    console.error(\r\n      \"Usage: npx tsx scripts/debug/puppeteer-inspect.ts <url> [--block=resourceTypes]\",\r\n    );\r\n    process.exit(1);\r\n  }\r\n\r\n  const url = argv[0];\r\n  const blockArg = argv.find((a) => a.startsWith(\"--block=\"));\r\n  const blockSet = parseBlockArg(blockArg?.split(\"=\")[1]);\r\n  const allowArg = argv.find((a) => a.startsWith(\"--allow=\"));\r\n  const allowSet = parseBlockArg(allowArg?.split(\"=\")[1]);\r\n\r\n  const outDir = path.join(process.cwd(), \"logs\", \"puppeteer-inspect\");\r\n  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });\r\n  const runTimestamp = new Date().toISOString().replace(/[:.]/g, \"-\");\r\n  const reportPath = path.join(outDir, `report-${runTimestamp}.json`);\r\n  const screenshotPath = path.join(outDir, `screenshot-${runTimestamp}.png`);\r\n\r\n  const browser = await sharedLaunchBrowser();\r\n  const page = await browser.newPage();\r\n\r\n  const records: ReqRecord[] = [];\r\n  let counter = 0;\r\n  let blockedCount = 0;\r\n  let totalBytes = 0;\r\n\r\n  // Use the shared interception helper and record decisions via onRequest\r\n  await attachDefaultInterception(page, {\r\n    allow: allowSet,\r\n    block: blockSet,\r\n    onRequest: (\r\n      req: HTTPRequest,\r\n      decision: \"blocked\" | \"continued\",\r\n      reason?: string,\r\n    ) => {\r\n      const id = ++counter;\r\n      const reqUrl = req.url();\r\n      const rec: ReqRecord = {\r\n        id,\r\n        url: reqUrl,\r\n        method: req.method(),\r\n        resourceType: req.resourceType(),\r\n        timestamp: Date.now(),\r\n      };\r\n      if (decision === \"blocked\") {\r\n        blockedCount += 1;\r\n        rec.failure = reason ?? \"blocked\";\r\n      }\r\n      records.push(rec);\r\n    },\r\n  });\r\n\r\n  page.on(\"requestfailed\", (req: HTTPRequest) => {\r\n    const rec = records.find((r) => r.url === req.url());\r\n    if (rec) rec.failure = req.failure()?.errorText ?? \"failed\";\r\n  });\r\n\r\n  page.on(\"response\", async (res: HTTPResponse) => {\r\n    try {\r\n      const req = res.request();\r\n      const rec = records.find((r) => r.url === req.url());\r\n      if (!rec) return;\r\n      rec.status = res.status();\r\n      rec.headers = res.headers();\r\n      const len = res.headers()[\"content-length\"];\r\n      if (len) {\r\n        let n = NaN;\r\n        if (typeof len === \"string\") n = parseInt(len, 10);\r\n        else if (typeof len === \"number\") n = Math.floor(len);\r\n        if (!Number.isNaN(n)) {\r\n          rec.responseSize = n;\r\n          totalBytes += n;\r\n        }\r\n      } else {\r\n        // attempt to fetch buffer size for same-origin responses\r\n        try {\r\n          const buffer = await res.buffer();\r\n          rec.responseSize = buffer.length;\r\n          totalBytes += buffer.length;\r\n        } catch {\r\n          rec.responseSize = null;\r\n        }\r\n      }\r\n    } catch {\r\n      // ignore\r\n    }\r\n  });\r\n\r\n  console.log(\r\n    `Navigating to ${url} (blocking: ${[...blockSet].join(\",\") || \"none\"})`,\r\n  );\r\n\r\n  try {\r\n    await page.goto(url, { waitUntil: \"networkidle2\", timeout: 60000 });\r\n    // Attempt to login using project password if available\r\n    try {\r\n      const cfg = await import(\"../../src/utils/config\");\r\n      const { tryLogin } =\r\n        await import(\"../../src/utils/common/scraperHelpers\");\r\n      const password =\r\n        typeof cfg.ZEROHEIGHT_PROJECT_PASSWORD === \"string\"\r\n          ? cfg.ZEROHEIGHT_PROJECT_PASSWORD\r\n          : undefined;\r\n      if (password) {\r\n        await tryLogin({ page, password });\r\n        console.log(\"Login attempt complete (inspector)\");\r\n      }\r\n    } catch (e) {\r\n      // Non-fatal: continue even if login helper isn't available\r\n      console.warn(\r\n        \"Login attempt skipped or failed:\",\r\n        e instanceof Error ? e.message : e,\r\n      );\r\n    }\r\n  } catch (e) {\r\n    console.error(\"Navigation failed:\", e instanceof Error ? e.message : e);\r\n  }\r\n\r\n  // give a short grace period for late responses\r\n  await new Promise((res) => setTimeout(res, 1000));\r\n\r\n  const summary = {\r\n    url,\r\n    blocked: blockedCount,\r\n    totalRequests: records.length,\r\n    totalBytes,\r\n    blockedTypes: [...blockSet],\r\n    records,\r\n  };\r\n\r\n  fs.writeFileSync(reportPath, JSON.stringify(summary, null, 2), \"utf8\");\r\n  await page\r\n    .screenshot({ path: screenshotPath, fullPage: true })\r\n    .catch(() => {});\r\n\r\n  console.log(`Report written: ${reportPath}`);\r\n  console.log(`Screenshot written: ${screenshotPath}`);\r\n  console.log(\r\n    `Requests: ${records.length}, blocked: ${blockedCount}, bytes: ${totalBytes}`,\r\n  );\r\n\r\n  await browser.close();\r\n}\r\n\r\nmain().catch((e) => {\r\n  console.error(e instanceof Error ? e.message : e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\api-mcp.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":9,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":9,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Test script for Zeroheight MCP API Query functionality\r\n * This tests the Query Zeroheight Data tool (assumes data was already scraped)\r\n * Run with: npx tsx src/e2e/api-mcp.test.ts\r\n */\r\n\r\nasync function testApi() {\r\n  // load env and config dynamically so TS path aliases resolve at runtime\r\n  await import(\"dotenv/config\");\r\n  const { ZEROHEIGHT_MCP_ACCESS_TOKEN, MCP_URL } =\r\n    await import(\"@/utils/config\");\r\n\r\n  if (!ZEROHEIGHT_MCP_ACCESS_TOKEN) {\r\n    console.error(\r\n      \"‚ùå Error: ZEROHEIGHT_MCP_ACCESS_TOKEN environment variable not set\",\r\n    );\r\n    console.log(\"\");\r\n    console.log(\"Set it with:\");\r\n    console.log('  export ZEROHEIGHT_MCP_ACCESS_TOKEN=\"your-api-key-here\"');\r\n    console.log(\"  # or in PowerShell:\");\r\n    console.log('  $env:ZEROHEIGHT_MCP_ACCESS_TOKEN = \"your-api-key-here\"');\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log(\"üß™ Testing Zeroheight MCP API...\");\r\n  console.log(`üìç API URL: ${MCP_URL}`);\r\n  console.log(\r\n    `üîë API Key: ${ZEROHEIGHT_MCP_ACCESS_TOKEN ? ZEROHEIGHT_MCP_ACCESS_TOKEN.substring(0, 8) + \"...\" : \"NOT SET\"}`,\r\n  );\r\n  console.log(\"\");\r\n\r\n  try {\r\n    // Test: Query Zeroheight Data (assumes data was already scraped)\r\n    console.log(\"üîç Testing Query Zeroheight Data...\");\r\n    const queryResponse = await fetch(MCP_URL, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"X-API-Key\": ZEROHEIGHT_MCP_ACCESS_TOKEN,\r\n        Accept: \"application/json, text/event-stream\",\r\n      },\r\n      body: JSON.stringify({\r\n        jsonrpc: \"2.0\",\r\n        id: 1,\r\n        method: \"tools/call\",\r\n        params: {\r\n          name: \"Query Zeroheight Data\",\r\n          arguments: {\r\n            search: \"color\",\r\n            includeImages: true,\r\n            limit: 5,\r\n          },\r\n        },\r\n      }),\r\n    });\r\n\r\n    if (!queryResponse.ok) {\r\n      throw new Error(\r\n        `HTTP ${queryResponse.status}: ${queryResponse.statusText}`,\r\n      );\r\n    }\r\n\r\n    const queryResult = await queryResponse.text();\r\n    console.log(\"‚úÖ Query request successful\");\r\n    console.log(\"üìÑ Response preview:\", queryResult.substring(0, 500) + \"...\");\r\n    console.log(\"\");\r\n\r\n    console.log(\"üéâ API test passed! The server is responding correctly.\");\r\n    console.log(\"üí° Note: This test assumes data has already been scraped.\");\r\n    console.log(\r\n      \"   To scrape data, use the MCP client or call the Scrape tool directly.\",\r\n    );\r\n  } catch (error) {\r\n    console.error(\r\n      \"‚ùå Test failed:\",\r\n      error instanceof Error ? error.message : String(error),\r\n    );\r\n    console.log(\"\");\r\n    console.log(\"üí° Troubleshooting:\");\r\n    console.log(\"- Make sure the server is running: npm run dev\");\r\n    console.log(\"- Check that ZEROHEIGHT_MCP_ACCESS_TOKEN is set correctly\");\r\n    console.log(\"- Verify the API URL is accessible\");\r\n    console.log(\r\n      \"- Ensure data has been scraped previously (this test only queries)\",\r\n    );\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\ntestApi();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\jobs-cancel-job.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":13,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":13,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Test script to call the `cancel-job` MCP tool on the local server.\r\n * Usage: npx tsx src/e2e/jobs-cancel-job.test.ts <jobId>\r\n */\r\n\r\nimport { config as dotenvConfig } from \"dotenv\";\r\ndotenvConfig({ path: \".env.local\" });\r\n\r\nconst jobId = process.argv[2];\r\n\r\nasync function runCancel() {\r\n  const { ZEROHEIGHT_MCP_ACCESS_TOKEN, MCP_URL } =\r\n    await import(\"@/utils/config\");\r\n\r\n  if (!ZEROHEIGHT_MCP_ACCESS_TOKEN) {\r\n    console.error(\r\n      \"‚ùå Error: ZEROHEIGHT_MCP_ACCESS_TOKEN environment variable not set\",\r\n    );\r\n    process.exit(1);\r\n  }\r\n\r\n  if (!jobId) {\r\n    console.error(\"Usage: npx tsx src/e2e/jobs-cancel-job.test.ts <jobId>\");\r\n    process.exit(2);\r\n  }\r\n\r\n  console.log(`Calling cancel-job for id=${jobId}...`);\r\n\r\n  const body = JSON.stringify({\r\n    jsonrpc: \"2.0\",\r\n    id: 1,\r\n    method: \"tools/call\",\r\n    params: {\r\n      name: \"cancel-job\",\r\n      arguments: { jobId },\r\n    },\r\n  });\r\n\r\n  try {\r\n    const res = await fetch(MCP_URL, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"X-API-Key\": ZEROHEIGHT_MCP_ACCESS_TOKEN,\r\n        Accept: \"application/json, text/event-stream\",\r\n      },\r\n      body,\r\n    });\r\n\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);\r\n    const text = await res.text();\r\n    console.log(\"Response:\\n\", text);\r\n  } catch (e) {\r\n    console.error(\r\n      \"Request failed:\",\r\n      e instanceof Error ? e.message : String(e),\r\n    );\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nrunCancel();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\jobs-full-flow.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":15,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":15,"endColumn":15},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":19,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":19,"endColumn":19}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\nimport dotenv from \"dotenv\";\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nimport {\r\n  createTestJobInDb,\r\n  claimJobById,\r\n  appendJobLog,\r\n  finishJob,\r\n  getJobFromDb,\r\n  markJobCancelledInDb,\r\n  deleteJobInDb,\r\n} from \"@/tools/tasks/utils/jobStore\";\r\n\r\nfunction sleep(ms: number) {\r\n  return new Promise((r) => setTimeout(r, ms));\r\n}\r\n\r\nasync function run() {\r\n  console.log(\"Creating test job...\");\r\n  const id = await createTestJobInDb({\r\n    name: \"test-job-full-flow\",\r\n    args: { foo: \"bar\" },\r\n  });\r\n  if (!id) {\r\n    console.error(\"Failed to create job\");\r\n    process.exit(1);\r\n  }\r\n  console.log(\"Created job id:\", id);\r\n\r\n  // Verify initial state is `working` per SEP-1686\r\n  const before = await getJobFromDb({ jobId: id });\r\n  if (!before) {\r\n    console.error(\"Failed to read job after creation\");\r\n    process.exit(4);\r\n  }\r\n  if (before.status !== \"working\") {\r\n    console.error(\r\n      \"Expected job to be 'working' after creation, got:\",\r\n      before.status,\r\n    );\r\n    process.exit(5);\r\n  }\r\n\r\n  // Start a background \"worker\" that will claim and run the job.\r\n  const worker = (async () => {\r\n    console.log(\"Worker: claiming job by id...\");\r\n    const claimed = await claimJobById({ jobId: id });\r\n    if (!claimed) {\r\n      console.error(\"Worker: no job claimed\");\r\n      return;\r\n    }\r\n    console.log(\"Worker: claimed\", claimed.id);\r\n\r\n    // Simulate work and periodically check DB for cancellation\r\n    for (let i = 0; i < 30; i++) {\r\n      await appendJobLog({ jobId: claimed.id, line: `worker log ${i}` });\r\n      const job = await getJobFromDb({ jobId: claimed.id });\r\n      if (job && job.status === \"cancelled\") {\r\n        console.log(\"Worker: detected cancellation\");\r\n        await appendJobLog({\r\n          jobId: claimed.id,\r\n          line: \"worker detected cancellation\",\r\n        });\r\n        await finishJob({\r\n          jobId: claimed.id,\r\n          success: false,\r\n          result: undefined,\r\n          errorMsg: \"cancelled by test\",\r\n        });\r\n        return;\r\n      }\r\n      await sleep(200);\r\n    }\r\n\r\n    // Completed normally\r\n    console.log(\"Worker: finished normally\");\r\n    await finishJob({ jobId: claimed.id, success: true });\r\n  })();\r\n\r\n  // Give the worker a moment to start and write a couple logs\r\n  await sleep(500);\r\n\r\n  console.log(\"Main: reading job (pre-cancel)...\");\r\n  const pre = await getJobFromDb({ jobId: id });\r\n  console.log(JSON.stringify(pre, null, 2));\r\n  if (!pre) {\r\n    console.error(\"Failed to read job before cancel\");\r\n    process.exit(6);\r\n  }\r\n  if (pre.status !== \"running\" && pre.status !== \"working\") {\r\n    console.error(\r\n      \"Expected job to be 'running' or 'working' before cancel, got:\",\r\n      pre.status,\r\n    );\r\n    process.exit(7);\r\n  }\r\n  if (!pre.started_at) {\r\n    console.error(\"Expected job to have 'started_at' set before cancel\");\r\n    process.exit(8);\r\n  }\r\n\r\n  // Cancel the job\r\n  console.log(\"Main: cancelling job...\");\r\n  await markJobCancelledInDb({ jobId: id });\r\n\r\n  // Wait for worker to observe cancellation and finish\r\n  await worker;\r\n\r\n  console.log(\"Main: fetching final job record...\");\r\n  const final = await getJobFromDb({ jobId: id });\r\n  console.log(JSON.stringify(final, null, 2));\r\n\r\n  if (!final) process.exit(2);\r\n  if (final.status !== \"cancelled\") {\r\n    console.error(\"Expected job to be cancelled, got:\", final.status);\r\n    process.exit(3);\r\n  }\r\n\r\n  console.log(\r\n    \"Test successful: job was claimed, cancelled, and worker respected cancellation.\",\r\n  );\r\n\r\n  // cleanup test job\r\n  try {\r\n    await deleteJobInDb({ jobId: id });\r\n    console.log(\"Cleaned up test job\", id);\r\n  } catch (e) {\r\n    console.warn(\"Cleanup failed:\", e instanceof Error ? e.message : e);\r\n  }\r\n}\r\n\r\nrun().catch((e) => {\r\n  console.error(e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\jobs-inspect-job.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":25,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":25,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\nimport dotenv from \"dotenv\";\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n// Supabase config will be loaded dynamically after dotenv\r\n\r\nconst jobId = process.argv[2];\r\nif (!jobId) {\r\n  console.error(\"Usage: npx tsx src/e2e/jobs-inspect-job.test.ts <jobId>\");\r\n  process.exit(2);\r\n}\r\n\r\nconst cfg = await import(\"@/utils/config\");\r\nconst SUPABASE_URL = cfg.NEXT_PUBLIC_SUPABASE_URL;\r\nconst SUPABASE_KEY = cfg.SUPABASE_SERVICE_ROLE_KEY || cfg.SUPABASE_ACCESS_TOKEN;\r\n\r\nif (!SUPABASE_URL || !SUPABASE_KEY) {\r\n  console.error(\"Missing Supabase config in .env.local\");\r\n  process.exit(2);\r\n}\r\n\r\nconst supabase = createClient(SUPABASE_URL, SUPABASE_KEY);\r\n\r\nasync function inspect() {\r\n  const { data, error } = await supabase\r\n    .from(\"tasks\")\r\n    .select(\"*\")\r\n    .eq(\"id\", jobId)\r\n    .limit(1);\r\n\r\n  if (error) {\r\n    console.error(\"Supabase error:\", error.message || error);\r\n    process.exit(2);\r\n  }\r\n\r\n  if (!data || data.length === 0) {\r\n    console.log(`No job found with id=${jobId}`);\r\n    return;\r\n  }\r\n\r\n  console.log(JSON.stringify(data[0], null, 2));\r\n}\r\n\r\ninspect().catch((e) => {\r\n  console.error(e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\jobs-job-lifecycle.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":14,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":14,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\nimport dotenv from \"dotenv\";\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nimport {\r\n  createTestJobInDb,\r\n  claimJobById,\r\n  appendJobLog,\r\n  finishJob,\r\n  getJobFromDb,\r\n  deleteJobInDb,\r\n} from \"@/tools/tasks/utils/jobStore\";\r\n\r\nasync function run() {\r\n  try {\r\n    console.log(\"Creating test job...\");\r\n    const id = await createTestJobInDb({\r\n      name: \"test-job-run\",\r\n      args: { foo: \"bar\" },\r\n    });\r\n    if (!id) {\r\n      console.error(\"Failed to create job in DB\");\r\n      process.exit(1);\r\n    }\r\n    console.log(\"Created job id:\", id);\r\n\r\n    console.log(\"Claiming job by id...\");\r\n    const claimed = await claimJobById({ jobId: id });\r\n    console.log(\"Claimed:\", claimed ? claimed.id : null);\r\n\r\n    console.log(\"Appending log...\");\r\n    await appendJobLog({ jobId: id, line: \"first log line from test\" });\r\n\r\n    console.log(\"Finishing job...\");\r\n    await finishJob({ jobId: id, success: true });\r\n\r\n    console.log(\"Fetching job...\");\r\n    const job = await getJobFromDb({ jobId: id });\r\n    console.log(JSON.stringify(job, null, 2));\r\n\r\n    // cleanup\r\n    await deleteJobInDb({ jobId: id });\r\n  } catch (e) {\r\n    console.error(\r\n      \"Error during job lifecycle test:\",\r\n      e instanceof Error ? e.message : e,\r\n    );\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nrun().catch((e) => {\r\n  console.error(e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\jobs-tail-job.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":31,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":31,"endColumn":21},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":37,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":37,"endColumn":25},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":92,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":92,"endColumn":23}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\nimport dotenv from \"dotenv\";\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n// Supabase config will be imported dynamically below so env is loaded first\r\n\r\nconst jobId = process.argv[2];\r\nconst intervalArgIndex = process.argv.findIndex((s) => s === \"--interval\");\r\nconst interval =\r\n  intervalArgIndex >= 0 ? Number(process.argv[intervalArgIndex + 1]) : 5;\r\n\r\nif (!jobId) {\r\n  console.error(\r\n    \"Usage: npx tsx src/e2e/jobs-tail-job.test.ts <jobId> [--interval N]\",\r\n  );\r\n  process.exit(2);\r\n}\r\n\r\nconst cfg = await import(\"@/utils/config\");\r\nconst SUPABASE_URL = cfg.NEXT_PUBLIC_SUPABASE_URL;\r\nconst SUPABASE_KEY = cfg.SUPABASE_SERVICE_ROLE_KEY || cfg.SUPABASE_ACCESS_TOKEN;\r\n\r\nif (!SUPABASE_URL || !SUPABASE_KEY) {\r\n  console.error(\"Missing Supabase config in .env.local\");\r\n  process.exit(2);\r\n}\r\n\r\nconst supabase = createClient(SUPABASE_URL, SUPABASE_KEY);\r\n\r\nasync function sleep(ms: number) {\r\n  return new Promise((r) => setTimeout(r, ms));\r\n}\r\n\r\nlet lastLogs = \"\";\r\n\r\nasync function fetchOnce() {\r\n  const { data, error } = await supabase\r\n    .from(\"tasks\")\r\n    .select(\"id, status, logs, started_at, finished_at, error\")\r\n    .eq(\"id\", jobId)\r\n    .limit(1)\r\n    .maybeSingle();\r\n\r\n  if (error) {\r\n    console.error(\"Supabase error:\", error.message || error);\r\n    return { finished: false };\r\n  }\r\n\r\n  if (!data) {\r\n    console.log(`No job found with id=${jobId}`);\r\n    return { finished: true };\r\n  }\r\n\r\n  type JobRow = {\r\n    id: string;\r\n    status: string;\r\n    logs: string | null;\r\n    started_at: string | null;\r\n    finished_at: string | null;\r\n    error: string | null;\r\n  };\r\n\r\n  const {\r\n    status,\r\n    logs = \"\",\r\n    started_at,\r\n    finished_at,\r\n    error: err,\r\n  } = data as JobRow;\r\n\r\n  const safeLogs = logs ?? \"\";\r\n\r\n  if (safeLogs !== lastLogs) {\r\n    const newPart = safeLogs.startsWith(lastLogs)\r\n      ? safeLogs.slice(lastLogs.length)\r\n      : safeLogs;\r\n    process.stdout.write(newPart);\r\n    lastLogs = safeLogs;\r\n  }\r\n\r\n  console.log(\r\n    `\\n[status=${status} started=${started_at} finished=${finished_at} error=${err}]\\n`,\r\n  );\r\n\r\n  return {\r\n    finished:\r\n      status === \"completed\" || status === \"failed\" || status === \"cancelled\",\r\n  };\r\n}\r\n\r\nasync function runTail() {\r\n  console.log(`Tailing job ${jobId} every ${interval}s...`);\r\n  while (true) {\r\n    try {\r\n      const { finished } = await fetchOnce();\r\n      if (finished) {\r\n        console.log(\"Job finished; stopping tail.\");\r\n        process.exit(0);\r\n      }\r\n    } catch (e) {\r\n      console.error(\"Tail error:\", e instanceof Error ? e.message : String(e));\r\n    }\r\n    await sleep(interval * 1000);\r\n  }\r\n}\r\n\r\nrunTail();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\query-images.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":4,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":4,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import \"dotenv/config\";\r\nimport { getClient } from \"@/utils/common/supabaseClients\";\r\n\r\nasync function main() {\r\n  const { client: supabase } = getClient();\r\n  if (!supabase) {\r\n    console.error(\"Supabase client not configured\");\r\n    process.exit(1);\r\n  }\r\n\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"images\")\r\n      .select(\"id, original_url, storage_path, page_id\")\r\n      .order(\"id\", { ascending: false })\r\n      .limit(50);\r\n\r\n    if (error) {\r\n      console.error(\"Error querying images table:\", error);\r\n      process.exit(1);\r\n    }\r\n\r\n    console.log(\"Images rows (most recent first):\");\r\n    console.log(JSON.stringify(data, null, 2));\r\n  } catch (e) {\r\n    console.error(\"Unexpected error:\", e);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\scraper-enqueue-scrape.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":14,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":14,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Test script to enqueue a scrape via the MCP `scrape` tool.\r\n * Usage: npx tsx src/e2e/scraper-enqueue-scrape.test.ts [pageUrl1 pageUrl2 ...]\r\n */\r\n\r\nimport { config as dotenvConfig } from \"dotenv\";\r\ndotenvConfig({ path: \".env.local\" });\r\n\r\nconst args = process.argv.slice(2);\r\nconst pageUrls = args.length > 0 ? args : undefined;\r\n\r\nasync function runEnqueue() {\r\n  const { ZEROHEIGHT_MCP_ACCESS_TOKEN, MCP_URL } =\r\n    await import(\"@/utils/config\");\r\n  if (!ZEROHEIGHT_MCP_ACCESS_TOKEN) {\r\n    console.error(\r\n      \"‚ùå Error: ZEROHEIGHT_MCP_ACCESS_TOKEN environment variable not set\",\r\n    );\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log(`Enqueueing scrape (pageUrls=${pageUrls ? pageUrls.length : 0})`);\r\n\r\n  const body = JSON.stringify({\r\n    jsonrpc: \"2.0\",\r\n    id: 1,\r\n    method: \"tools/call\",\r\n    params: {\r\n      name: \"scrape\",\r\n      arguments: { pageUrls },\r\n    },\r\n  });\r\n\r\n  try {\r\n    const res = await fetch(MCP_URL, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"X-API-Key\": ZEROHEIGHT_MCP_ACCESS_TOKEN,\r\n        Accept: \"application/json, text/event-stream\",\r\n      },\r\n      body,\r\n    });\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);\r\n    const text = await res.text();\r\n    console.log(\"Response:\\n\", text);\r\n  } catch (e) {\r\n    console.error(\r\n      \"Request failed:\",\r\n      e instanceof Error ? e.message : String(e),\r\n    );\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nrunEnqueue();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\scraper-v2.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":3,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":3,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { scrape } from \"@/tools/scraper/scrape\";\r\nimport { isRecord } from \"@/utils/common/typeGuards\";\r\nasync function run() {\r\n  const { SCRAPE_TEST_PAGE_URLS } = await import(\"@/utils/config\");\r\n  const raw = SCRAPE_TEST_PAGE_URLS || \"\";\r\n  if (!raw) {\r\n    console.log(\r\n      \"SKIP: SCRAPE_TEST_PAGE_URLS not set - provide comma-separated URLs to run\",\r\n    );\r\n    process.exit(0);\r\n  }\r\n\r\n  const pageUrls = raw\r\n    .split(\",\")\r\n    .map((s) => s.trim())\r\n    .filter(Boolean);\r\n  if (pageUrls.length === 0) {\r\n    console.log(\"SKIP: no valid URLs provided\");\r\n    process.exit(0);\r\n  }\r\n\r\n  console.log(`Running scrape-v2 on ${pageUrls.length} pages...`);\r\n\r\n  const res = await scrape({\r\n    rootUrl: pageUrls[0],\r\n    password: undefined,\r\n    pageUrls,\r\n    logger: (s) => console.log(s),\r\n  });\r\n\r\n  try {\r\n    const extractProgress = (v: unknown): unknown => {\r\n      if (isRecord(v) && \"progress\" in v) {\r\n        return v[\"progress\"];\r\n      }\r\n      if (isRecord(v) && \"content\" in v) {\r\n        const content = v[\"content\"];\r\n        if (Array.isArray(content) && content.length > 0) {\r\n          const first = content[0];\r\n          if (isRecord(first) && \"text\" in first) {\r\n            const text = String(first[\"text\"] ?? \"\");\r\n            try {\r\n              return JSON.parse(text).progress;\r\n            } catch {\r\n              return undefined;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      return undefined;\r\n    };\r\n\r\n    const progress = extractProgress(res);\r\n    if (!progress) {\r\n      console.error(\"FAIL: response missing progress field\");\r\n      console.error(res);\r\n      process.exit(2);\r\n    }\r\n\r\n    console.log(\"Progress from v2:\", progress);\r\n\r\n    if (\r\n      isRecord(progress) &&\r\n      typeof progress[\"current\"] === \"number\" &&\r\n      typeof progress[\"total\"] === \"number\"\r\n    ) {\r\n      if (progress[\"current\"] === progress[\"total\"]) {\r\n        console.log(\"PASS: progress.current === progress.total\");\r\n        process.exit(0);\r\n      }\r\n      console.error(\r\n        `FAIL: progress mismatch final current=${progress[\"current\"]} total=${progress[\"total\"]}`,\r\n      );\r\n      process.exit(1);\r\n    }\r\n    console.error(\"FAIL: progress object malformed\", progress);\r\n    process.exit(2);\r\n  } catch (e) {\r\n    console.error(\"FAIL: could not parse tool response\", e);\r\n    process.exit(3);\r\n  }\r\n}\r\n\r\nrun().catch((e) => {\r\n  console.error(e);\r\n  process.exit(4);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\storage-image-upload.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":7,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":7,"endColumn":28},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":16,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":16,"endColumn":33},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":73,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":73,"endColumn":19}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { config as dotenvConfig } from \"dotenv\";\r\nimport { getSupabaseClient } from \"@/utils/common\";\r\nimport { isRecord } from \"../../src/utils/common/typeGuards\";\r\n\r\ndotenvConfig({ path: \".env.local\" });\r\n\r\nfunction extFromContentType(ct: string | null) {\r\n  if (!ct) return \"png\";\r\n  if (ct.includes(\"jpeg\")) return \"jpg\";\r\n  if (ct.includes(\"png\")) return \"png\";\r\n  if (ct.includes(\"webp\")) return \"webp\";\r\n  if (ct.includes(\"svg\")) return \"svg\";\r\n  return \"bin\";\r\n}\r\n\r\nasync function downloadAndUpload(\r\n  url: string,\r\n  BUCKET: string,\r\n  TEST_BUCKET: string,\r\n) {\r\n  const client = getSupabaseClient();\r\n  if (!client) throw new Error(\"Supabase client not configured\");\r\n\r\n  const resp = await fetch(url);\r\n  if (!resp.ok) throw new Error(`Fetch failed: ${resp.status}`);\r\n  const buffer = Buffer.from(await resp.arrayBuffer());\r\n  const contentType =\r\n    resp.headers.get(\"content-type\") || \"application/octet-stream\";\r\n  const ext = extFromContentType(contentType);\r\n\r\n  // Prefer a test bucket to avoid touching production images.\r\n  const listResult = await client.storage.listBuckets();\r\n  const buckets = listResult.data;\r\n  const targetBucket = buckets?.some((b) => b.name === TEST_BUCKET)\r\n    ? TEST_BUCKET\r\n    : null;\r\n\r\n  if (!targetBucket) {\r\n    console.log(\r\n      `Test bucket ${TEST_BUCKET} not found; skipping upload to avoid touching production bucket ${BUCKET}`,\r\n    );\r\n    return null as { path: string; publicUrl: string } | null;\r\n  }\r\n\r\n  const uploader = client;\r\n  const filename = `test_image_${Date.now()}_${Math.floor(Math.random() * 1e6)}.${ext}`;\r\n\r\n  const result = await uploader.storage\r\n    .from(targetBucket)\r\n    .upload(filename, buffer, {\r\n      upsert: false,\r\n      contentType,\r\n    });\r\n\r\n  const uploadError = isRecord(result) ? result.error : undefined;\r\n  const uploadData =\r\n    isRecord(result) && isRecord(result.data) ? result.data : undefined;\r\n\r\n  if (uploadError) {\r\n    if (uploadError instanceof Error) throw uploadError;\r\n    throw new Error(String(uploadError));\r\n  }\r\n\r\n  const storagePath = uploadData?.path;\r\n  if (!storagePath) throw new Error(\"Upload did not return a storage path\");\r\n\r\n  const { data: urlData } = client.storage\r\n    .from(BUCKET)\r\n    .getPublicUrl(storagePath);\r\n  return { path: storagePath, publicUrl: urlData.publicUrl };\r\n}\r\n\r\nasync function run() {\r\n  const { IMAGE_BUCKET } = await import(\"@/utils/config\");\r\n  const BUCKET = IMAGE_BUCKET;\r\n  const TEST_BUCKET = `${BUCKET}_test`;\r\n  try {\r\n    const testUrls = [\r\n      \"https://httpbin.org/image/png\",\r\n      \"https://picsum.photos/200/200\",\r\n    ];\r\n    for (const url of testUrls) {\r\n      console.log(\"Trying:\", url);\r\n      try {\r\n        const res = await downloadAndUpload(url, BUCKET, TEST_BUCKET);\r\n        if (res) {\r\n          console.log(\"Uploaded:\", res.path);\r\n          console.log(\"Public URL:\", res.publicUrl);\r\n          return;\r\n        }\r\n        console.log(\"Upload skipped (no test bucket or upload returned null)\");\r\n      } catch (err) {\r\n        console.error(\r\n          \"Attempt failed:\",\r\n          err instanceof Error ? err.message : err,\r\n        );\r\n      }\r\n    }\r\n    console.error(\"All test uploads failed\");\r\n  } catch (err) {\r\n    console.error(\"Runner failed:\", err);\r\n    process.exitCode = 1;\r\n  }\r\n}\r\n\r\nrun().catch((e) => {\r\n  console.error(e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\test-task-ttl.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":9,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":9,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\nimport { config } from \"dotenv\";\r\n// Ensure dotenv runs before importing any app modules that read env at module-evaluation time.\r\nconfig({ path: \".env.local\" });\r\nimport { isRecord } from \"../../src/utils/common/typeGuards\";\r\nimport type { ZodTypeAny } from \"zod\";\r\n\r\nasync function main() {\r\n  const { ZEROHEIGHT_MCP_ACCESS_TOKEN, MCP_URL } =\r\n    await import(\"@/utils/config\");\r\n  if (!ZEROHEIGHT_MCP_ACCESS_TOKEN) {\r\n    console.error(\"ZEROHEIGHT_MCP_ACCESS_TOKEN not set\");\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log(\"Starting TTL propagation e2e test...\");\r\n\r\n  // 1) Start a test task via MCP\r\n  const startRes = await fetch(MCP_URL, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      \"X-API-Key\": ZEROHEIGHT_MCP_ACCESS_TOKEN,\r\n      Accept: \"application/json, text/event-stream\",\r\n    },\r\n    body: JSON.stringify({\r\n      jsonrpc: \"2.0\",\r\n      id: 1,\r\n      method: \"tools/call\",\r\n      params: { name: \"test-task\", arguments: {} },\r\n    }),\r\n  });\r\n  if (!startRes.ok) throw new Error(`Start task HTTP ${startRes.status}`);\r\n  const startText = await startRes.text();\r\n  console.log(\"startText:\", startText);\r\n  let startJson: unknown = null;\r\n  try {\r\n    startJson = JSON.parse(startText);\r\n  } catch {\r\n    // maybe SSE event-stream; try to extract last 'data: ' JSON\r\n    const parts = startText.split(/\\r?\\n/).filter(Boolean);\r\n    const dataLines = parts.filter((l) => l.startsWith(\"data:\"));\r\n    if (dataLines.length > 0) {\r\n      const last = dataLines[dataLines.length - 1].slice(\"data:\".length).trim();\r\n      startJson = JSON.parse(last);\r\n    }\r\n  }\r\n  if (!isRecord(startJson)) throw new Error(\"No JSON returned from testtask\");\r\n  const sj = startJson;\r\n  if (sj.error) throw new Error(JSON.stringify(sj.error));\r\n\r\n  // helper to extract string content safely\r\n  const extractContent = (obj: Record<string, unknown>): string | undefined => {\r\n    const res = obj[\"result\"];\r\n    if (isRecord(res)) {\r\n      const content = res[\"content\"];\r\n      if (Array.isArray(content) && content.length > 0) {\r\n        const first = content[0];\r\n        const t = first[\"text\"];\r\n        if (typeof t === \"string\") return t;\r\n        const d = first[\"data\"];\r\n        if (typeof d === \"string\") return d;\r\n      }\r\n      const rt = res[\"text\"];\r\n      if (typeof rt === \"string\") return rt;\r\n    }\r\n    const direct = obj[\"result\"];\r\n    if (typeof direct === \"string\") return direct;\r\n    const topText = obj[\"text\"];\r\n    if (typeof topText === \"string\") return topText;\r\n    return undefined;\r\n  };\r\n\r\n  const content = extractContent(sj);\r\n  if (!content) throw new Error(\"No content returned from testtask\");\r\n  let parsed: Record<string, unknown>;\r\n  if (typeof content === \"string\") {\r\n    try {\r\n      parsed = JSON.parse(content);\r\n    } catch {\r\n      throw new Error(\r\n        `Failed to parse JSON from testtask content. Raw content: ${content}`,\r\n      );\r\n    }\r\n  } else {\r\n    if (isRecord(content)) parsed = content;\r\n    else throw new Error(\"Parsed content is not an object\");\r\n  }\r\n  const jobId =\r\n    (typeof parsed[\"jobId\"] === \"string\" && parsed[\"jobId\"]) ||\r\n    (typeof parsed[\"id\"] === \"string\" && parsed[\"id\"]);\r\n  if (!jobId) throw new Error(\"Could not extract jobId from testtask response\");\r\n  console.log(\"Started test task with jobId:\", jobId);\r\n\r\n  // 2) Call tasks/get via MCP with params.task.ttl and verify response includes ttl\r\n  const requestedTtl = 5000;\r\n  const getRes = await fetch(MCP_URL, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      \"X-API-Key\": ZEROHEIGHT_MCP_ACCESS_TOKEN,\r\n      Accept: \"application/json, text/event-stream\",\r\n    },\r\n    body: JSON.stringify({\r\n      jsonrpc: \"2.0\",\r\n      id: 2,\r\n      method: \"tools/call\",\r\n      params: {\r\n        name: \"tasks-get\",\r\n        arguments: { taskId: jobId },\r\n        task: { ttl: requestedTtl },\r\n      },\r\n    }),\r\n  });\r\n  if (!getRes.ok) throw new Error(`tasks/get HTTP ${getRes.status}`);\r\n  const getText = await getRes.text();\r\n  let getJson: unknown = null;\r\n  try {\r\n    getJson = JSON.parse(getText);\r\n  } catch {\r\n    // try SSE data: lines\r\n    const parts = getText.split(/\\r?\\n/).filter(Boolean);\r\n    const dataLines = parts.filter((l) => l.startsWith(\"data:\"));\r\n    if (dataLines.length > 0) {\r\n      const last = dataLines[dataLines.length - 1].slice(\"data:\".length).trim();\r\n      try {\r\n        getJson = JSON.parse(last);\r\n      } catch {\r\n        // fallthrough\r\n      }\r\n    }\r\n  }\r\n  if (!isRecord(getJson))\r\n    throw new Error(`tasks/get did not return JSON. Raw response: ${getText}`);\r\n  const gj = getJson;\r\n  if (isRecord(gj) && gj.error) {\r\n    // If the server refuses tools/call with task metadata, fall back to calling the tool handler directly for verification.\r\n    const errObj = isRecord(gj.error) ? gj.error : undefined;\r\n    let msg = \"\";\r\n    if (errObj && typeof errObj[\"message\"] === \"string\")\r\n      msg = String(errObj[\"message\"]);\r\n    if (msg.includes(\"Server does not support task creation\")) {\r\n      console.warn(\r\n        \"Server rejected task-aware tools/call. Falling back to direct tool call for verification.\",\r\n      );\r\n      const { tasksGetTool } = await import(\"@/tools/tasks/get\");\r\n      const direct = await tasksGetTool.handler({\r\n        taskId: jobId,\r\n        requestedTtlMs: requestedTtl,\r\n      });\r\n\r\n      // If the tool exposes an outputSchema, validate the direct handler\r\n      // response against it so tests exercise the same runtime checks.\r\n      const outputSchema = (\r\n        tasksGetTool as unknown as { outputSchema?: ZodTypeAny }\r\n      ).outputSchema as ZodTypeAny | undefined;\r\n      let directRec: Record<string, unknown> | undefined;\r\n      if (outputSchema) {\r\n        const parsed = outputSchema.safeParse(direct);\r\n        if (!parsed.success) {\r\n          throw new Error(\r\n            `Direct tool output failed validation: ${JSON.stringify(parsed.error.format())}`,\r\n          );\r\n        }\r\n        directRec = isRecord(parsed.data) ? parsed.data : undefined;\r\n      } else {\r\n        const directAny: unknown = direct;\r\n        directRec = isRecord(directAny) ? directAny : undefined;\r\n      }\r\n\r\n      if (directRec && isRecord(directRec.error))\r\n        throw new Error(JSON.stringify(directRec.error));\r\n      const taskNode =\r\n        directRec && isRecord(directRec.task) ? directRec.task : undefined;\r\n      const dirTtl = taskNode ? taskNode[\"ttl\"] : undefined;\r\n      console.log(\"tasks/get (direct) response ttl:\", dirTtl);\r\n      if (typeof dirTtl !== \"number\")\r\n        throw new Error(\"TTL not present in direct tasks/get result\");\r\n      if (dirTtl !== requestedTtl)\r\n        throw new Error(\r\n          `TTL mismatch: expected ${requestedTtl}, got ${dirTtl}`,\r\n        );\r\n      console.log(\r\n        \"‚úÖ TTL propagation test passed (verified via direct tool call)\",\r\n      );\r\n      return;\r\n    }\r\n    throw new Error(JSON.stringify(gj.error));\r\n  }\r\n  // Unwrap ToolResponse wrapper if present: result.content[0].text may contain the real JSON\r\n  let actualResult: unknown = gj[\"result\"];\r\n  if (isRecord(actualResult) && Array.isArray(actualResult.content)) {\r\n    const content = (() => {\r\n      const __tmp = actualResult.content;\r\n      return isRecord(__tmp)\r\n        ? (__tmp as Array<Record<string, unknown>>)\r\n        : __tmp;\r\n    })();\r\n    const first = content[0];\r\n    const inner = first?.text;\r\n    if (typeof inner === \"string\") {\r\n      try {\r\n        actualResult = JSON.parse(inner);\r\n      } catch {\r\n        // leave actualResult as-is\r\n      }\r\n    }\r\n  }\r\n  const resultObj = isRecord(actualResult) ? actualResult : undefined;\r\n  const taskNode =\r\n    resultObj && isRecord(resultObj[\"task\"]) ? resultObj[\"task\"] : undefined;\r\n  const ttl = taskNode ? taskNode[\"ttl\"] : undefined;\r\n  console.log(\"tasks/get response ttl:\", ttl);\r\n  if (typeof ttl !== \"number\")\r\n    throw new Error(\"TTL not present in tasks/get result\");\r\n  if (ttl !== requestedTtl)\r\n    throw new Error(`TTL mismatch: expected ${requestedTtl}, got ${ttl}`);\r\n\r\n  console.log(\"‚úÖ TTL propagation test passed\");\r\n}\r\n\r\nmain().catch((e) => {\r\n  console.error(\"Test failed:\", e instanceof Error ? e.message : e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\e2e\\verify-progress.test.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { scrape } from \"@/tools/scraper/scrape\";\r\nimport { isRecord } from \"@/utils/common/typeGuards\";\r\n\r\n// load env and config dynamically inside `run` so path aliases resolve\r\n\r\nasync function run() {\r\n  await import(\"dotenv/config\");\r\n  const { SCRAPE_TEST_PAGE_URLS } = await import(\"@/utils/config\");\r\n  const raw = SCRAPE_TEST_PAGE_URLS || \"\";\r\n  if (!raw) {\r\n    console.log(\r\n      \"SKIP: SCRAPE_TEST_PAGE_URLS not set - provide comma-separated URLs to run\",\r\n    );\r\n    process.exit(0);\r\n  }\r\n\r\n  const pageUrls = raw\r\n    .split(\",\")\r\n    .map((s) => s.trim())\r\n    .filter(Boolean);\r\n  if (pageUrls.length === 0) {\r\n    console.log(\"SKIP: no valid URLs provided\");\r\n    process.exit(0);\r\n  }\r\n\r\n  console.log(`Running scrape on ${pageUrls.length} pages...`);\r\n\r\n  const res = await scrape({\r\n    rootUrl: pageUrls[0],\r\n    password: undefined,\r\n    pageUrls,\r\n    logger: (s) => console.log(s),\r\n  });\r\n\r\n  try {\r\n    const extractProgress = (v: unknown): unknown => {\r\n      if (isRecord(v) && \"progress\" in v) {\r\n        return v[\"progress\"];\r\n      }\r\n      if (isRecord(v) && \"content\" in v) {\r\n        const content = v[\"content\"];\r\n        if (Array.isArray(content) && content.length > 0) {\r\n          const first = content[0];\r\n          if (isRecord(first) && \"text\" in first) {\r\n            const text = String(first[\"text\"] ?? \"\");\r\n            try {\r\n              return JSON.parse(text).progress;\r\n            } catch {\r\n              return undefined;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      return undefined;\r\n    };\r\n\r\n    const progress = extractProgress(res);\r\n    if (!progress) {\r\n      console.error(\"FAIL: response missing progress field\");\r\n      console.error(res);\r\n      process.exit(2);\r\n    }\r\n\r\n    console.log(\"Progress from tool:\", progress);\r\n\r\n    if (\r\n      isRecord(progress) &&\r\n      typeof progress[\"current\"] === \"number\" &&\r\n      typeof progress[\"total\"] === \"number\"\r\n    ) {\r\n      if (progress[\"current\"] === progress[\"total\"]) {\r\n        console.log(\"PASS: progress.current === progress.total\");\r\n        process.exit(0);\r\n      }\r\n      console.error(\r\n        `FAIL: progress mismatch final current=${progress[\"current\"]} total=${progress[\"total\"]}`,\r\n      );\r\n      process.exit(1);\r\n    }\r\n    console.error(\"FAIL: progress object malformed\", progress);\r\n    process.exit(2);\r\n  } catch (e) {\r\n    console.error(\"FAIL: could not parse tool response\", e);\r\n    process.exit(3);\r\n  }\r\n}\r\n\r\nrun().catch((e) => {\r\n  console.error(e);\r\n  process.exit(4);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\generate-database-types.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":137,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":137,"endColumn":37}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n// Run with: npx tsx scripts/generate-database-types.ts\r\nimport { readFileSync, writeFileSync } from \"fs\";\r\nimport { join } from \"path\";\r\n\r\n// This script generates Zod schemas based on the generated lib/database.schema.ts\r\n// Run with: npm run generate-database-types (which runs generate-database-schema first)\r\n\r\n// Function to extract table names from the generated Database type\r\nfunction extractTableNames(): string[] {\r\n  const schemaPath = join(process.cwd(), \"src\", \"database.schema.ts\");\r\n  const content = readFileSync(schemaPath, \"utf-8\");\r\n\r\n  // Find the Tables section\r\n  const tablesStart = content.indexOf(\"Tables: {\");\r\n  if (tablesStart === -1) return [];\r\n\r\n  // Find the end of Tables (look for the closing } at the same level)\r\n  let braceCount = 0;\r\n  let endIndex = tablesStart + 9; // after 'Tables: {'\r\n  for (let i = endIndex; i < content.length; i++) {\r\n    if (content[i] === \"{\") braceCount++;\r\n    if (content[i] === \"}\") {\r\n      braceCount--;\r\n      if (braceCount === -1) {\r\n        // back to the Tables level\r\n        endIndex = i;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  const tablesContent = content.substring(tablesStart + 9, endIndex);\r\n\r\n  // Extract table names - look for top-level keys before ': {'\r\n  const tableNames: string[] = [];\r\n  const lines = tablesContent.split(\"\\n\");\r\n  for (const line of lines) {\r\n    const trimmed = line.trim();\r\n    if (trimmed && !trimmed.startsWith(\"//\") && trimmed.includes(\": {\")) {\r\n      const tableName = trimmed.split(\":\")[0].trim();\r\n      if (\r\n        tableName &&\r\n        tableName !== \"Row\" &&\r\n        tableName !== \"Insert\" &&\r\n        tableName !== \"Update\"\r\n      ) {\r\n        tableNames.push(tableName);\r\n      }\r\n    }\r\n  }\r\n\r\n  return tableNames;\r\n}\r\n\r\n// Function to map TypeScript types to Zod validators\r\nfunction mapTypeToZod(tsType: string): string {\r\n  // Handle nullable types\r\n  if (tsType.includes(\" | null\")) {\r\n    const baseType = tsType.replace(\" | null\", \"\");\r\n    return `${mapTypeToZod(baseType)}.nullable()`;\r\n  }\r\n\r\n  // Basic type mappings\r\n  switch (tsType) {\r\n    case \"string\":\r\n      return \"z.string()\";\r\n    case \"number\":\r\n      return \"z.number()\";\r\n    case \"boolean\":\r\n      return \"z.boolean()\";\r\n    default:\r\n      // For complex types, default to any\r\n      return \"z.any()\";\r\n  }\r\n}\r\n\r\n// Function to parse Row type for a table\r\nfunction parseTableRow(\r\n  tableName: string,\r\n  content: string,\r\n): Record<string, string> {\r\n  // Find the table section\r\n  const tableRegex = new RegExp(\r\n    `${tableName}:\\\\s*{([\\\\s\\\\S]*?)}\\\\s*},?\\\\s*(?=\\\\w+:|$)`,\r\n    \"i\",\r\n  );\r\n  const tableMatch = content.match(tableRegex);\r\n  if (!tableMatch) return {};\r\n\r\n  const tableContent = tableMatch[1];\r\n\r\n  // Find the Row section\r\n  const rowRegex = /Row:\\s*{([^{}]*(?:{[^{}]*}[^{}]*)*)}/;\r\n  const rowMatch = tableContent.match(rowRegex);\r\n  if (!rowMatch) return {};\r\n\r\n  const rowContent = rowMatch[1];\r\n\r\n  // Parse fields\r\n  const fields: Record<string, string> = {};\r\n  const fieldRegex = /(\\w+):\\s*([^;\\n]+)/g;\r\n  let match;\r\n  while ((match = fieldRegex.exec(rowContent)) !== null) {\r\n    const fieldName = match[1];\r\n    const fieldType = match[2].trim();\r\n    fields[fieldName] = fieldType;\r\n  }\r\n\r\n  return fields;\r\n}\r\n\r\n// Function to generate Zod schema for a table by parsing the Database type\r\nfunction generateZodSchema(tableName: string): string {\r\n  const schemaPath = join(process.cwd(), \"src\", \"database.schema.ts\");\r\n  const content = readFileSync(schemaPath, \"utf-8\");\r\n\r\n  const fields = parseTableRow(tableName, content);\r\n\r\n  if (Object.keys(fields).length === 0) {\r\n    // Fallback if parsing fails\r\n    return `z.object({\r\n  id: z.number(),\r\n  // Could not parse table schema\r\n})`;\r\n  }\r\n\r\n  // Generate Zod object\r\n  const fieldDefs = Object.entries(fields)\r\n    .map(([field, type]) => `  ${field}: ${mapTypeToZod(type)},`)\r\n    .join(\"\\n\");\r\n\r\n  return `z.object({\\n${fieldDefs}\\n})`;\r\n}\r\n\r\n// Generate schemas dynamically from extracted table names\r\nfunction generateSchemasFromDatabase() {\r\n  const tableNames = extractTableNames();\r\n  const schemas: string[] = [];\r\n  const types: string[] = [];\r\n\r\n  tableNames.forEach((tableName) => {\r\n    const schemaName = `public${tableName.charAt(0).toUpperCase() + tableName.slice(1)}Schema`;\r\n    const typeName = `${tableName.charAt(0).toUpperCase() + tableName.slice(1)}Type`;\r\n\r\n    schemas.push(\r\n      `export const ${schemaName} = ${generateZodSchema(tableName)};`,\r\n    );\r\n    types.push(`export type ${typeName} = z.infer<typeof ${schemaName}>;`);\r\n  });\r\n\r\n  return { schemas, types };\r\n}\r\n\r\nconst { schemas, types } = generateSchemasFromDatabase();\r\n\r\n// Generate the schemas.ts content\r\nconst schemasContent = `import { z } from 'zod';\r\nimport type { Database } from './database.schema';\r\n\r\n// Auto-generated Zod schemas based on database.schema.ts\r\n\r\n${schemas.join(\"\\n\\n\")}\r\n\r\n// Export inferred types\r\n${types.join(\"\\n\")}\r\n\r\n// Database type for reference\r\nexport type SupabaseDatabase = Database;\r\n`;\r\n\r\n// Write to src/schemas.ts\r\nconst outputPath = join(process.cwd(), \"src\", \"database.types.ts\");\r\nwriteFileSync(outputPath, schemasContent, \"utf-8\");\r\n\r\nconsole.log(\r\n  \"Schemas and types generated dynamically from database.schema.ts! Written to src/database.types.ts\",\r\n);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\print-bulk-box.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":11,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":11,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n// Run with: npx tsx scripts/print-bulk-box.ts\r\n\r\n// Lightweight script to render the same boxed summary used by bulkUpsert\r\nimport \"dotenv/config\";\r\nimport {\r\n  formatSummaryBox,\r\n  SummaryParams,\r\n} from \"../src/tools/scraper/utils/bulkUpsert\";\r\n\r\nasync function main() {\r\n  const params: SummaryParams = {\r\n    providedCount: 2,\r\n    pagesAnalyzed: 2,\r\n    insertedCount: 0,\r\n    updatedCount: 2,\r\n    skippedCount: 0,\r\n    pagesFailed: 0,\r\n    uniqueTotalImages: 9,\r\n    uniqueUnsupported: 2,\r\n    uniqueAllowed: 7,\r\n    imagesUploadedCount: 0,\r\n    uniqueSkipped: 7,\r\n    imagesFailed: 0,\r\n    imagesDbInsertedCount: 0,\r\n    imagesAlreadyAssociatedCount: 7,\r\n  };\r\n\r\n  const lines = formatSummaryBox({ p: params });\r\n  console.log(lines.join(\"\\n\"));\r\n}\r\n\r\nmain().catch((err) => {\r\n  console.error(err);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\run-tools-list.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport { config as dotenvConfig } from \"dotenv\";\r\ndotenvConfig({ path: \".env.local\" });\r\n\r\nasync function main() {\r\n  // dynamically import config to ensure environment is loaded and paths resolve\r\n  const cfg = await import(\"@/utils/config\");\r\n  const url: string = cfg.MCP_URL;\r\n  const key: string = cfg.ZEROHEIGHT_MCP_ACCESS_TOKEN;\r\n\r\n  if (!url) throw new Error(\"MCP_URL is not configured\");\r\n  if (!key) throw new Error(\"ZEROHEIGHT_MCP_ACCESS_TOKEN is not configured\");\r\n\r\n  const res = await fetch(url, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      Accept: \"application/json\",\r\n      Authorization: `Bearer ${key}`,\r\n      \"X-API-Key\": key,\r\n    },\r\n    body: JSON.stringify({\r\n      jsonrpc: \"2.0\",\r\n      method: \"tools/list\",\r\n      params: {},\r\n      id: 1,\r\n    }),\r\n  });\r\n\r\n  console.log(\"STATUS\", res.status);\r\n  const text = await res.text();\r\n  try {\r\n    console.log(JSON.stringify(JSON.parse(text), null, 2));\r\n  } catch {\r\n    console.log(text);\r\n  }\r\n}\r\n\r\nmain().catch((err) => {\r\n  console.error(err);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\cancel-task.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":5,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":5,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport { runTool } from \"./start-task\";\r\n\r\nasync function main() {\r\n  const ids = process.argv.slice(2);\r\n  if (ids.length === 0) {\r\n    console.error(\r\n      \"Usage: npx tsx scripts/tasks/cancel-task.ts <taskId> [<taskId> ...]\",\r\n    );\r\n    process.exit(2);\r\n  }\r\n\r\n  try {\r\n    for (const id of ids) {\r\n      const res = await runTool(\r\n        \"../../src/tools/tasks/cancel\",\r\n        \"tasksCancelTool\",\r\n        {\r\n          taskId: id,\r\n        },\r\n      );\r\n      console.log(JSON.stringify(res, null, 2));\r\n    }\r\n  } catch (e) {\r\n    console.error(\"Cancel task failed:\", e instanceof Error ? e.message : e);\r\n    process.exit(3);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\check-task-status.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport dotenv from \"dotenv\";\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nasync function main() {\r\n  const ids = process.argv.slice(2);\r\n  if (ids.length === 0) {\r\n    console.error(\"Usage: npx tsx scripts/tasks/check-task-status.ts <taskId>\");\r\n    process.exit(2);\r\n  }\r\n  const { getJobFromDb } = await import(\"../../src/tools/tasks/utils/jobStore\");\r\n  for (const jobId of ids) {\r\n    console.log(`Checking status for jobId=${jobId}...`);\r\n    const job = await getJobFromDb({ jobId });\r\n    console.log(JSON.stringify(job, null, 2));\r\n  }\r\n}\r\n\r\nmain().catch((e) => {\r\n  console.error(e instanceof Error ? e.message : e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\check-task.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":5,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":5,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport { runTool } from \"./start-task\";\r\n\r\nasync function main() {\r\n  const taskId = process.argv[2];\r\n  if (!taskId) {\r\n    console.error(\"Usage: npx tsx scripts/tasks/check-task.ts <taskId>\");\r\n    process.exit(1);\r\n  }\r\n\r\n  try {\r\n    const res = await runTool(\"../../src/tools/tasks/get\", \"tasksGetTool\", {\r\n      taskId,\r\n    });\r\n    console.log(JSON.stringify(res, null, 2));\r\n  } catch (e) {\r\n    console.error(\"Check task failed:\", e instanceof Error ? e.message : e);\r\n    process.exit(2);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\start-scrape-pages.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport { runTool } from \"./start-task\";\r\nimport { ZEROHEIGHT_PROJECT_PASSWORD } from \"../../src/utils/config\";\r\n\r\nasync function main() {\r\n  const urls = [\r\n    \"https://designsystem.lruddannelse.dk/10548dffa/p/51380f-graph-patterns-wip\",\r\n    \"https://designsystem.lruddannelse.dk/10548dffa/p/3441e1-lindhardt-og-ringhof-uddannelse-design-system\",\r\n  ];\r\n\r\n  const password = ZEROHEIGHT_PROJECT_PASSWORD || undefined;\r\n  await runTool(\"../../src/tools/scraper/scrape\", \"scrapeTool\", {\r\n    pageUrls: urls,\r\n    password,\r\n  });\r\n}\r\n\r\nmain().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\start-scrape-project.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport { runTool } from \"./start-task\";\r\nimport { ZEROHEIGHT_PROJECT_PASSWORD } from \"../../src/utils/config\";\r\n\r\nasync function main() {\r\n  // Start the scraper as a background task via the registered tool\r\n  const password = ZEROHEIGHT_PROJECT_PASSWORD || undefined;\r\n  await runTool(\"../../src/tools/scraper/scrape\", \"scrapeTool\", {\r\n    password,\r\n  });\r\n}\r\n\r\nmain().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\start-task.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":10,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":10,"endColumn":30},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":10,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":10,"endColumn":30}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport { config } from \"dotenv\";\r\nimport { isRecord, getProp } from \"@/utils/common/typeGuards\";\r\nimport type { ZodTypeAny } from \"zod\";\r\nimport type { ToolResponse } from \"@/utils/toolResponses\";\r\nimport { normalizeToToolResponse } from \"@/utils/toolResponses\";\r\nconfig({ path: \".env.local\" });\r\n\r\nexport async function runTool(\r\n  modulePath: string,\r\n  exportName: string,\r\n  args?: Record<string, unknown> | undefined,\r\n) {\r\n  const mod = await import(modulePath);\r\n  if (!isRecord(mod)) throw new Error(`Invalid module loaded: ${modulePath}`);\r\n  const toolCandidate = mod[exportName];\r\n  if (\r\n    !isRecord(toolCandidate) ||\r\n    typeof getProp(toolCandidate, \"handler\") !== \"function\"\r\n  ) {\r\n    throw new Error(`Tool ${exportName} not found in module ${modulePath}`);\r\n  }\r\n  const handler = getProp(toolCandidate, \"handler\") as (\r\n    a?: unknown,\r\n  ) => Promise<unknown>;\r\n  console.log(\r\n    `Invoking tool ${exportName} from ${modulePath} with args:`,\r\n    args,\r\n  );\r\n  const raw = await handler(args ?? {});\r\n  // If the tool provides an outputSchema, validate and print structured\r\n  // output. Otherwise fall back to the legacy ToolResponse normalization.\r\n  const outputSchema = getProp(toolCandidate, \"outputSchema\") as\r\n    | ZodTypeAny\r\n    | undefined;\r\n  if (outputSchema && typeof outputSchema.safeParse === \"function\") {\r\n    const parsed = outputSchema.safeParse(raw);\r\n    if (!parsed.success) {\r\n      console.error(\"Tool output failed validation:\", parsed.error.format());\r\n      const res = normalizeToToolResponse(raw);\r\n      console.log(\"Normalized ToolResponse:\", JSON.stringify(res, null, 2));\r\n      return res;\r\n    }\r\n    console.log(\"Structured result:\", JSON.stringify(parsed.data, null, 2));\r\n    return parsed.data as unknown;\r\n  }\r\n\r\n  const res: ToolResponse = normalizeToToolResponse(raw);\r\n  console.log(\"Tool response:\", JSON.stringify(res, null, 2));\r\n  return res;\r\n}\r\n\r\nexport default runTool;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\start-test-task.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport dotenv from \"dotenv\";\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nasync function main() {\r\n  // Simple positional arg style (like tail-job-admin.ts). Optional first\r\n  // positional argument is treated as minutes. Default to 5 minutes.\r\n  const arg = process.argv[2];\r\n  let durationMinutes = arg ? Number(arg) : 5;\r\n  if (Number.isNaN(durationMinutes) || durationMinutes <= 0) {\r\n    console.warn(\r\n      `Invalid duration provided (${String(arg)}). Falling back to default 5 minutes.`,\r\n    );\r\n    durationMinutes = 5;\r\n  }\r\n\r\n  // Reuse start-task helper for consistent behavior with other scripts\r\n  const { runTool } = await import(\"./start-task\");\r\n\r\n  const res = await runTool(\r\n    \"../../src/tools/scraper/testTask\",\r\n    \"testTaskTool\",\r\n    {\r\n      durationMinutes,\r\n    },\r\n  );\r\n  console.log(\"Tool returned:\", JSON.stringify(res, null, 2));\r\n}\r\n\r\nmain().catch((e) => {\r\n  console.error(\"Error running test task:\", e instanceof Error ? e.message : e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\tail-job-admin.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport dotenv from \"dotenv\";\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nasync function main() {\r\n  const { getSupabaseAdminClient } = await import(\"../../src/utils/common\");\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) {\r\n    console.error(\"Admin supabase client not configured\");\r\n    process.exit(1);\r\n  }\r\n  const jobId = process.argv[2];\r\n  if (!jobId) {\r\n    console.error(\"Usage: npx tsx scripts/tasks/tail-job-admin.ts <taskId>\");\r\n    process.exit(2);\r\n  }\r\n  console.log(\"Fetching job via admin client:\", jobId);\r\n  const { data, error } = await supabase\r\n    .from(\"tasks\")\r\n    .select(\"id, status, logs, started_at, finished_at\")\r\n    .eq(\"id\", jobId)\r\n    .maybeSingle();\r\n  if (error) {\r\n    console.error(\"Supabase error:\", error);\r\n    process.exit(1);\r\n  }\r\n  if (!data) {\r\n    console.log(\"No job found with id=\", jobId);\r\n    return;\r\n  }\r\n  console.log(JSON.stringify(data, null, 2));\r\n}\r\n\r\nmain().catch((e) => {\r\n  console.error(e instanceof Error ? e.message : e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\tail-job-long.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":9,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":9,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport dotenv from \"dotenv\";\r\ndotenv.config({ path: \".env.local\" });\r\nimport type { ToolResponse } from \"@/utils/toolResponses\";\r\nimport { normalizeToToolResponse } from \"@/utils/toolResponses\";\r\nimport type { ZodTypeAny } from \"zod\";\r\n\r\nasync function main() {\r\n  const ids = process.argv.slice(2);\r\n  if (ids.length === 0) {\r\n    console.error(\r\n      \"Usage: npx tsx scripts/tasks/tail-job-long.ts <taskId> [timeoutMs]\",\r\n    );\r\n    process.exit(2);\r\n  }\r\n  const timeoutMsArg = Number(process.argv[3] ?? \"300000\"); // default 5 minutes\r\n  const timeoutMs = Number.isFinite(timeoutMsArg) ? timeoutMsArg : 300000;\r\n\r\n  const { tasksResultTool } = await import(\"../../src/tools/tasks\");\r\n  for (const jobId of ids) {\r\n    console.log(\r\n      \"Querying task result (long wait):\",\r\n      jobId,\r\n      `timeoutMs=${timeoutMs}`,\r\n    );\r\n    const raw = await tasksResultTool.handler({\r\n      taskId: jobId,\r\n      timeoutMs,\r\n    });\r\n    const outputSchema = tasksResultTool.outputSchema as ZodTypeAny | undefined;\r\n    if (outputSchema) {\r\n      const parsed = outputSchema.safeParse(raw);\r\n      if (!parsed.success) {\r\n        console.error(\r\n          \"Validation failed for tasksResultTool:\",\r\n          parsed.error.format(),\r\n        );\r\n        const res = normalizeToToolResponse(raw);\r\n        console.log(JSON.stringify(res, null, 2));\r\n      } else {\r\n        console.log(JSON.stringify(parsed.data, null, 2));\r\n      }\r\n    } else {\r\n      const res: ToolResponse = normalizeToToolResponse(raw);\r\n      console.log(JSON.stringify(res, null, 2));\r\n    }\r\n  }\r\n}\r\n\r\nmain().catch((e) => {\r\n  console.error(\"Error tailing job:\", e instanceof Error ? e.message : e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\tasks\\tail-job.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":9,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":9,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n\r\nimport dotenv from \"dotenv\";\r\ndotenv.config({ path: \".env.local\" });\r\nimport type { ToolResponse } from \"@/utils/toolResponses\";\r\nimport { normalizeToToolResponse } from \"@/utils/toolResponses\";\r\nimport type { ZodTypeAny } from \"zod\";\r\n\r\nasync function main() {\r\n  const ids = process.argv.slice(2);\r\n  if (ids.length === 0) {\r\n    console.error(\"Usage: npx tsx scripts/tasks/tail-job.ts <taskId>\");\r\n    process.exit(2);\r\n  }\r\n  const { tasksResultTool } = await import(\"../../src/tools/tasks\");\r\n  for (const jobId of ids) {\r\n    console.log(\"Querying task result:\", jobId);\r\n    const raw = await tasksResultTool.handler({\r\n      taskId: jobId,\r\n      timeoutMs: 10000,\r\n    });\r\n    const outputSchema = tasksResultTool.outputSchema as ZodTypeAny | undefined;\r\n    if (outputSchema) {\r\n      const parsed = outputSchema.safeParse(raw);\r\n      if (!parsed.success) {\r\n        console.error(\r\n          \"Validation failed for tasksResultTool:\",\r\n          parsed.error.format(),\r\n        );\r\n        const res = normalizeToToolResponse(raw);\r\n        console.log(JSON.stringify(res, null, 2));\r\n      } else {\r\n        console.log(JSON.stringify(parsed.data, null, 2));\r\n      }\r\n    } else {\r\n      const res: ToolResponse = normalizeToToolResponse(raw);\r\n      console.log(JSON.stringify(res, null, 2));\r\n    }\r\n  }\r\n}\r\n\r\nmain().catch((e) => {\r\n  console.error(\"Error tailing job:\", e instanceof Error ? e.message : e);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\test-mcp-list-4000.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n// This script uses dynamic imports and expects to be run with `tsx` (npx tsx)\r\nimport { config as dotenvConfig } from \"dotenv\";\r\ndotenvConfig({ path: \".env.local\" });\r\n\r\nasync function main() {\r\n  // dynamically import config to ensure environment is loaded and aliases work\r\n  const cfg = await import(\"@/utils/config\");\r\n  const url: string = cfg.MCP_URL;\r\n  const key: string = cfg.ZEROHEIGHT_MCP_ACCESS_TOKEN;\r\n\r\n  if (!url) throw new Error(\"MCP_URL is not configured\");\r\n  if (!key) throw new Error(\"ZEROHEIGHT_MCP_ACCESS_TOKEN is not configured\");\r\n\r\n  const res = await fetch(url, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      Accept: \"application/json\",\r\n      Authorization: `Bearer ${key}`,\r\n      \"X-API-Key\": key,\r\n    },\r\n    body: JSON.stringify({\r\n      jsonrpc: \"2.0\",\r\n      method: \"tools/list\",\r\n      params: {},\r\n      id: 1,\r\n    }),\r\n  });\r\n\r\n  const text = await res.text();\r\n  console.log(\"STATUS\", res.status);\r\n  try {\r\n    const parsed = JSON.parse(text);\r\n    console.log(JSON.stringify(parsed, null, 2));\r\n  } catch {\r\n    console.log(text);\r\n  }\r\n}\r\n\r\nmain().catch((err) => {\r\n  console.error(err);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\scripts\\test-mcp-list.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\r\n// This script uses dynamic imports and expects to be run with `tsx` (npx tsx)\r\nimport { config as dotenvConfig } from \"dotenv\";\r\ndotenvConfig({ path: \".env.local\" });\r\n\r\nasync function main() {\r\n  // dynamically import config so env is loaded and TS path aliases resolve\r\n  const cfg = await import(\"@/utils/config\");\r\n  const url: string = cfg.MCP_URL;\r\n  const key: string = cfg.ZEROHEIGHT_MCP_ACCESS_TOKEN;\r\n\r\n  if (!url) throw new Error(\"MCP_URL is not configured\");\r\n  if (!key) throw new Error(\"ZEROHEIGHT_MCP_ACCESS_TOKEN is not configured\");\r\n\r\n  const res = await fetch(url, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      Accept: \"application/json\",\r\n      Authorization: `Bearer ${key}`,\r\n      \"X-API-Key\": key,\r\n    },\r\n    body: JSON.stringify({\r\n      jsonrpc: \"2.0\",\r\n      method: \"tools/list\",\r\n      params: {},\r\n      id: 1,\r\n    }),\r\n  });\r\n\r\n  const text = await res.text();\r\n  console.log(\"STATUS\", res.status);\r\n  console.log(\"HEADERS\", Object.fromEntries(res.headers.entries()));\r\n  try {\r\n    const parsed = JSON.parse(text);\r\n    console.log(JSON.stringify(parsed, null, 2));\r\n  } catch {\r\n    console.log(text);\r\n  }\r\n}\r\n\r\nmain().catch((err) => {\r\n  console.error(err);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\.well-known\\[...slug]\\route.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":4,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":4,"endColumn":22},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":11,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":11,"endColumn":26},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":11,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":11,"endColumn":26},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":40,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":40,"endColumn":27},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":40,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":40,"endColumn":27},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":44,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":44,"endColumn":30},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":44,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":44,"endColumn":30},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":48,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":48,"endColumn":27},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":48,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":48,"endColumn":27}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Provide minimal OpenID Connect discovery and JWKS endpoints for local dev.\r\n// mcp-remote expects valid discovery metadata at /.well-known/openid-configuration.\r\n\r\nfunction jsonResponse(obj: unknown, status = 200) {\r\n  return new Response(JSON.stringify(obj), {\r\n    status,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n  });\r\n}\r\n\r\nexport async function GET(request: Request) {\r\n  try {\r\n    const url = new URL(request.url);\r\n    const pathname = url.pathname;\r\n\r\n    if (pathname.endsWith(\"/openid-configuration\")) {\r\n      const origin = `${url.protocol}//${url.host}`;\r\n      return jsonResponse({\r\n        issuer: origin,\r\n        authorization_endpoint: `${origin}/api/auth/authorize`,\r\n        token_endpoint: `${origin}/api/auth/token`,\r\n        jwks_uri: `${origin}/.well-known/jwks.json`,\r\n        response_types_supported: [\"code\", \"token\", \"id_token\"],\r\n        subject_types_supported: [\"public\"],\r\n        id_token_signing_alg_values_supported: [\"RS256\"],\r\n      });\r\n    }\r\n\r\n    if (pathname.endsWith(\"/jwks.json\") || pathname.endsWith(\"/jwks\")) {\r\n      return jsonResponse({ keys: [] });\r\n    }\r\n\r\n    // Default: return a simple JSON object for other well-known paths\r\n    return jsonResponse({});\r\n  } catch (e) {\r\n    return jsonResponse({ error: String(e) }, 500);\r\n  }\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  return GET(request);\r\n}\r\n\r\nexport async function OPTIONS(request: Request) {\r\n  return GET(request);\r\n}\r\n\r\nexport async function HEAD(request: Request) {\r\n  return GET(request);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\api\\[transport]\\route.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":214,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":214,"endColumn":36},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":214,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":214,"endColumn":36}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createMcpHandler } from \"mcp-handler\";\r\nimport { NextRequest } from \"next/server\";\r\nimport { authenticateRequest } from \"@/utils/auth\";\r\n// database tool exports trimmed; only specific tools imported below\r\nimport {\r\n  getDatabaseSchemaTool,\r\n  getDatabaseTypesTool,\r\n} from \"@/tools/development\";\r\nimport { scrapeTool } from \"@/tools/scraper\";\r\nimport { clearDatabaseTool, queryDatatabaseTool } from \"@/tools/database\";\r\nimport {\r\n  tasksGetTool,\r\n  tasksResultTool,\r\n  tasksListTool,\r\n  tasksCancelTool,\r\n  testTaskTool,\r\n  tasksTailTool,\r\n} from \"@/tools/tasks\";\r\nimport type { ToolResponse } from \"@/utils/toolResponses\";\r\nimport {\r\n  normalizeToToolResponse,\r\n  createErrorResponse,\r\n} from \"@/utils/toolResponses\";\r\nimport { isRecord } from \"../../../utils/common/typeGuards\";\r\n\r\nconst handler = createMcpHandler(\r\n  async (server) => {\r\n    // Register MCP tools. Task/job tools persist status/logs to the DB via\r\n    // the jobStore; inspector/tailer tools are registered where needed.\r\n\r\n    // SEP-1686: Task tools\r\n    // Wrap a tool handler and coerce its result into a `ToolResponse` so the\r\n    // MCP server receives a consistent shape regardless of the handler's raw\r\n    // return value.\r\n    const wrapTool = <T>(tool: {\r\n      handler: (a: T) => Promise<unknown>;\r\n      outputSchema?: import(\"zod\").ZodTypeAny;\r\n    }) => {\r\n      return async (args: unknown): Promise<ToolResponse> => {\r\n        const res = await tool.handler(args as T);\r\n        // If the tool provided an outputSchema, validate the result before\r\n        // normalization. If validation fails, return an error ToolResponse.\r\n        try {\r\n          if (tool.outputSchema) {\r\n            const parsed = tool.outputSchema.safeParse(res);\r\n            if (!parsed.success) {\r\n              console.error(\r\n                \"Tool output validation failed:\",\r\n                parsed.error.format(),\r\n              );\r\n              return createErrorResponse({\r\n                message: \"Tool output failed validation\",\r\n              });\r\n            }\r\n          }\r\n        } catch (e) {\r\n          console.error(\"Error validating tool output:\", e);\r\n          return createErrorResponse({\r\n            message: \"Tool output validation error\",\r\n          });\r\n        }\r\n\r\n        return normalizeToToolResponse(res);\r\n      };\r\n    };\r\n    server.registerTool(\r\n      tasksGetTool.title,\r\n      {\r\n        title: tasksGetTool.title,\r\n        description: tasksGetTool.description,\r\n        inputSchema: tasksGetTool.inputSchema,\r\n      },\r\n      wrapTool(tasksGetTool),\r\n    );\r\n\r\n    server.registerTool(\r\n      tasksResultTool.title,\r\n      {\r\n        title: tasksResultTool.title,\r\n        description: tasksResultTool.description,\r\n        inputSchema: tasksResultTool.inputSchema,\r\n      },\r\n      wrapTool(tasksResultTool),\r\n    );\r\n\r\n    server.registerTool(\r\n      tasksListTool.title,\r\n      {\r\n        title: tasksListTool.title,\r\n        description: tasksListTool.description,\r\n        inputSchema: tasksListTool.inputSchema,\r\n      },\r\n      wrapTool(tasksListTool),\r\n    );\r\n\r\n    server.registerTool(\r\n      tasksCancelTool.title,\r\n      {\r\n        title: tasksCancelTool.title,\r\n        description: tasksCancelTool.description,\r\n        inputSchema: tasksCancelTool.inputSchema,\r\n      },\r\n      wrapTool(tasksCancelTool),\r\n    );\r\n\r\n    // Test tool to create short-lived demo tasks\r\n    server.registerTool(\r\n      testTaskTool.title,\r\n      {\r\n        title: testTaskTool.title,\r\n        description: testTaskTool.description,\r\n        inputSchema: testTaskTool.inputSchema,\r\n      },\r\n      wrapTool(testTaskTool),\r\n    );\r\n\r\n    server.registerTool(\r\n      tasksTailTool.title,\r\n      {\r\n        title: tasksTailTool.title,\r\n        description: tasksTailTool.description,\r\n        inputSchema: tasksTailTool.inputSchema,\r\n      },\r\n      wrapTool(tasksTailTool),\r\n    );\r\n\r\n    // Database Inspection & Management Tools\r\n    // Database inspection/management tools removed: execute-sql, get-logs, list-migrations, list-tables\r\n\r\n    // Development & Deployment Tools\r\n    // Example: { \"method\": \"tools/call\", \"params\": { \"name\": \"Get Database Schema\", \"arguments\": {} } }\r\n    server.registerTool(\r\n      getDatabaseSchemaTool.title,\r\n      {\r\n        title: getDatabaseSchemaTool.title,\r\n        description: getDatabaseSchemaTool.description,\r\n        inputSchema: getDatabaseSchemaTool.inputSchema,\r\n      },\r\n      wrapTool(getDatabaseSchemaTool),\r\n    );\r\n\r\n    // (Removed) get-project-url and get-publishable-api-keys tools ‚Äî not needed\r\n\r\n    // Example: { \"method\": \"tools/call\", \"params\": { \"name\": \"Get Database Types\", \"arguments\": {} } }\r\n    server.registerTool(\r\n      getDatabaseTypesTool.title,\r\n      {\r\n        title: getDatabaseTypesTool.title,\r\n        description: getDatabaseTypesTool.description,\r\n        inputSchema: getDatabaseTypesTool.inputSchema,\r\n      },\r\n      wrapTool(getDatabaseTypesTool),\r\n    );\r\n    // Scraper-related tools\r\n    server.registerTool(\r\n      clearDatabaseTool.title,\r\n      {\r\n        title: clearDatabaseTool.title,\r\n        description: clearDatabaseTool.description,\r\n        inputSchema: clearDatabaseTool.inputSchema,\r\n      },\r\n      wrapTool(clearDatabaseTool),\r\n    );\r\n\r\n    server.registerTool(\r\n      scrapeTool.title,\r\n      {\r\n        title: scrapeTool.title,\r\n        description: scrapeTool.description,\r\n        inputSchema: scrapeTool.inputSchema,\r\n      },\r\n      wrapTool(scrapeTool),\r\n    );\r\n\r\n    server.registerTool(\r\n      queryDatatabaseTool.title,\r\n      {\r\n        title: queryDatatabaseTool.title,\r\n        description: queryDatatabaseTool.description,\r\n        inputSchema: queryDatatabaseTool.inputSchema,\r\n      },\r\n      wrapTool(queryDatatabaseTool),\r\n    );\r\n  },\r\n  {},\r\n  {\r\n    basePath: \"/api\",\r\n    maxDuration: 300, // 5 minutes for scraping\r\n    verboseLogs: true,\r\n    sseEndpoint: \"/mcp\",\r\n  },\r\n);\r\n// Widen the handler type to accept plain `Request` objects in addition to\r\n// `NextRequest`. We perform a single, centralized cast here so call-sites\r\n// can forward `Request` instances without repeating unsafe casts.\r\nconst permissiveHandler = handler as (req: Request) => Promise<Response>;\r\n\r\n// The MCP handler expects a `NextRequest` in some environments, but we\r\n// sometimes need to forward plain `Request` instances (constructed above).\r\n// Create a small adapter typed for `Request` so call-sites can pass a\r\n// `Request` without repeated casts.\r\ntype HandlerForRequest = (req: Request) => Promise<Response>;\r\nconst handlerForRequest: HandlerForRequest = async (req) => {\r\n  return await permissiveHandler(req);\r\n};\r\n\r\n// Export the underlying MCP handler for reuse by the JSON wrapper route.\r\nexport const mcpHandler = handler;\r\n\r\n// Authenticate the incoming request. For simple JSON-RPC `tools/call` calls\r\n// that target lightweight task tools we shortcut and call the tool handler\r\n// directly (avoids a full MCP roundtrip). Otherwise the request is forwarded\r\n// to the MCP handler.\r\nasync function authenticatedHandler(request: NextRequest) {\r\n  const auth = authenticateRequest({ request });\r\n\r\n  if (!auth.isValid) {\r\n    return new Response(\r\n      JSON.stringify({\r\n        jsonrpc: \"2.0\",\r\n        error: { code: -32600, message: auth.error },\r\n        id: null,\r\n      }),\r\n      { status: 401, headers: { \"Content-Type\": \"application/json\" } },\r\n    );\r\n  }\r\n\r\n  // Read the request body once (text) so it can be reused when forwarding.\r\n  let bodyText: string | null = null;\r\n  try {\r\n    bodyText = await request.text();\r\n  } catch {\r\n    bodyText = null;\r\n  }\r\n\r\n  const contentType = request.headers.get(\"content-type\") || \"\";\r\n  let parsed: Record<string, unknown> | null = null;\r\n  if (contentType.includes(\"application/json\") && bodyText) {\r\n    try {\r\n      const p = JSON.parse(bodyText);\r\n      if (isRecord(p)) parsed = p;\r\n    } catch {\r\n      parsed = null;\r\n    }\r\n  }\r\n\r\n  // If this is a single JSON-RPC `tools/call` targeting a task tool, handle it\r\n  // directly here and return a JSON-RPC response. This keeps the fast-path\r\n  // small and predictable.\r\n  if (parsed && parsed[\"method\"] === \"tools/call\") {\r\n    const params = isRecord(parsed?.[\"params\"]) ? parsed![\"params\"] : undefined;\r\n    const toolName =\r\n      typeof params?.[\"name\"] === \"string\" ? params![\"name\"] : undefined;\r\n    const args = isRecord(params?.[\"arguments\"]) ? params![\"arguments\"] : {};\r\n\r\n    const taskTools = new Set([\r\n      tasksGetTool.title,\r\n      tasksResultTool.title,\r\n      tasksListTool.title,\r\n      tasksCancelTool.title,\r\n      testTaskTool.title,\r\n      tasksTailTool.title,\r\n    ]);\r\n\r\n    if (toolName && taskTools.has(toolName)) {\r\n      try {\r\n        const wrapHandler = <T>(h: (a: T) => Promise<unknown>) => {\r\n          return async (a?: unknown): Promise<unknown> => h(a as T);\r\n        };\r\n\r\n        const toolMap: Record<string, (a?: unknown) => Promise<unknown>> = {\r\n          [tasksGetTool.title]: wrapHandler(tasksGetTool.handler),\r\n          [tasksResultTool.title]: wrapHandler(tasksResultTool.handler),\r\n          [tasksListTool.title]: wrapHandler(tasksListTool.handler),\r\n          [tasksCancelTool.title]: wrapHandler(tasksCancelTool.handler),\r\n          [testTaskTool.title]: wrapHandler(testTaskTool.handler),\r\n          [tasksTailTool.title]: wrapHandler(tasksTailTool.handler),\r\n        };\r\n\r\n        const handlerFn = toolMap[toolName];\r\n        const result = await handlerFn(args);\r\n\r\n        // If the tool returned a structured task object (SEP-1686), forward\r\n        // it directly as the JSON-RPC `result` so callers receive typed task\r\n        // metadata. Otherwise normalize into a ToolResponse for backward\r\n        // compatibility with tools that return raw values or errors.\r\n        let rpcResult: unknown;\r\n        if (\r\n          isRecord(result) &&\r\n          Object.prototype.hasOwnProperty.call(result, \"task\")\r\n        ) {\r\n          rpcResult = result;\r\n        } else {\r\n          rpcResult = normalizeToToolResponse(result);\r\n        }\r\n\r\n        const rpc = {\r\n          jsonrpc: \"2.0\",\r\n          id: parsed[\"id\"] ?? null,\r\n          result: rpcResult,\r\n        };\r\n        return new Response(JSON.stringify(rpc), {\r\n          status: 200,\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n        });\r\n      } catch (e) {\r\n        const msg = e instanceof Error ? e.message : String(e);\r\n        const rpc = {\r\n          jsonrpc: \"2.0\",\r\n          id: parsed[\"id\"] ?? null,\r\n          error: { code: -32000, message: msg },\r\n        };\r\n        return new Response(JSON.stringify(rpc), {\r\n          status: 500,\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  // When forwarding to the MCP handler, recreate a Request with the same\r\n  // body and headers so the handler can consume it normally.\r\n  const forwardedHeaders = new Headers(request.headers as HeadersInit);\r\n  // Ensure the handler sees both JSON and SSE acceptable so it will\r\n  // produce a JSON response for tools/list while remaining compatible\r\n  // with streaming transports.\r\n  forwardedHeaders.set(\"accept\", \"application/json, text/event-stream\");\r\n\r\n  const method = (request.method || \"GET\").toUpperCase();\r\n  const hasBodyMethod = [\"POST\", \"PUT\", \"PATCH\", \"DELETE\"].includes(method);\r\n\r\n  // For streaming transports (GET/HEAD) forward the original `NextRequest`\r\n  // to allow streaming. If the MCP handler rejects GET (405), fall back to a\r\n  // POST `tools/list` JSON-RPC call and return the result as an SSE event.\r\n  if (method === \"GET\" || method === \"HEAD\") {\r\n    // Diagnostic logging to understand 405 responses in this environment\r\n    console.debug(\"[mcp] forwarding GET/HEAD to handler\", {\r\n      method: request.method,\r\n      url: request.url,\r\n      accept: forwardedHeaders.get(\"accept\"),\r\n    });\r\n\r\n    try {\r\n      const res = await handlerForRequest(request);\r\n\r\n      if (res && res.status === 405) {\r\n        console.debug(\r\n          \"[mcp] handler returned 405 for GET/HEAD ‚Äî attempting POST fallback\",\r\n        );\r\n\r\n        const rpc = JSON.stringify({\r\n          jsonrpc: \"2.0\",\r\n          id: 1,\r\n          method: \"tools/list\",\r\n          params: {},\r\n        });\r\n        const forwardedPostHeaders = new Headers(forwardedHeaders);\r\n        forwardedPostHeaders.set(\"content-type\", \"application/json\");\r\n        forwardedPostHeaders.set(\r\n          \"accept\",\r\n          \"application/json, text/event-stream\",\r\n        );\r\n\r\n        const postResp = await handlerForRequest(\r\n          new Request(request.url, {\r\n            method: \"POST\",\r\n            headers: forwardedPostHeaders,\r\n            body: rpc,\r\n          }),\r\n        );\r\n\r\n        const postCt = postResp.headers.get(\"content-type\") || \"\";\r\n        if (postCt.includes(\"text/event-stream\")) {\r\n          return postResp;\r\n        }\r\n\r\n        const json = await postResp.text();\r\n        const stream = new ReadableStream({\r\n          start(controller) {\r\n            const sse = `event: message\\ndata: ${json}\\n\\n`;\r\n            controller.enqueue(new TextEncoder().encode(sse));\r\n            controller.close();\r\n          },\r\n        });\r\n\r\n        return new Response(stream, {\r\n          status: 200,\r\n          headers: {\r\n            \"Content-Type\": \"text/event-stream\",\r\n            \"Cache-Control\": \"no-cache\",\r\n          },\r\n        });\r\n      }\r\n\r\n      return res;\r\n    } catch (err) {\r\n      console.error(\"[mcp] handler threw while handling GET/HEAD:\", err);\r\n      const msg = err instanceof Error ? err.message : String(err);\r\n      const rpc = {\r\n        jsonrpc: \"2.0\",\r\n        id: null,\r\n        error: { code: -32000, message: `Handler error: ${msg}` },\r\n      };\r\n      return new Response(JSON.stringify(rpc), {\r\n        status: 500,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      });\r\n    }\r\n  }\r\n\r\n  // For non-GET methods, reconstruct a Request with the same body so the MCP handler can read it.\r\n  const forwardedReq = new Request(request.url, {\r\n    method,\r\n    headers: forwardedHeaders,\r\n    body: hasBodyMethod ? (bodyText ?? undefined) : undefined,\r\n  });\r\n\r\n  return handlerForRequest(forwardedReq);\r\n}\r\n\r\nexport {\r\n  authenticatedHandler as GET,\r\n  authenticatedHandler as POST,\r\n  authenticatedHandler as PUT,\r\n  authenticatedHandler as PATCH,\r\n  authenticatedHandler as DELETE,\r\n  authenticatedHandler as HEAD,\r\n  authenticatedHandler as OPTIONS,\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\components\\FeatureCard.tsx","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":25,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":25,"endColumn":28},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":25,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":25,"endColumn":28}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ReactElement, cloneElement, SVGProps } from \"react\";\r\n\r\ninterface FeatureCardProps {\r\n  icon: ReactElement<SVGProps<SVGSVGElement>>;\r\n  title: string;\r\n  description: string;\r\n  iconColor: string;\r\n  className?: string;\r\n}\r\n\r\nconst colorMap = {\r\n  green: { bg: \"bg-green-900\", text: \"text-green-400\" },\r\n  blue: { bg: \"bg-blue-900\", text: \"text-blue-400\" },\r\n  purple: { bg: \"bg-purple-900\", text: \"text-purple-400\" },\r\n  orange: { bg: \"bg-orange-900\", text: \"text-orange-400\" },\r\n  red: { bg: \"bg-red-900\", text: \"text-red-400\" },\r\n  indigo: { bg: \"bg-indigo-900\", text: \"text-indigo-400\" },\r\n  yellow: { bg: \"bg-yellow-900\", text: \"text-yellow-400\" },\r\n  cyan: { bg: \"bg-cyan-900\", text: \"text-cyan-400\" },\r\n  pink: { bg: \"bg-pink-900\", text: \"text-pink-400\" },\r\n  teal: { bg: \"bg-teal-900\", text: \"text-teal-400\" },\r\n  violet: { bg: \"bg-violet-900\", text: \"text-violet-400\" },\r\n};\r\n\r\nexport function FeatureCard({\r\n  icon,\r\n  title,\r\n  description,\r\n  iconColor,\r\n  className = \"\",\r\n}: FeatureCardProps) {\r\n  const colors = colorMap[iconColor as keyof typeof colorMap] || colorMap.blue;\r\n\r\n  return (\r\n    <div\r\n      className={`rounded-xl border border-slate-700 bg-slate-800 p-6 shadow-sm ${className}`}\r\n    >\r\n      <div className=\"mb-4 flex items-center\">\r\n        <div\r\n          className={`mr-4 flex h-12 w-12 items-center justify-center rounded-lg ${colors.bg}`}\r\n        >\r\n          {cloneElement(icon, { className: `h-6 w-6 ${colors.text}` })}\r\n        </div>\r\n        <h3 className=\"text-xl font-semibold text-white\">{title}</h3>\r\n      </div>\r\n      <p className=\"text-slate-400\">{description}</p>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\components\\InfoCard.tsx","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":9,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":9,"endColumn":25},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":9,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":9,"endColumn":25}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ReactNode } from \"react\";\r\n\r\ninterface InfoCardProps {\r\n  title: string;\r\n  children: ReactNode;\r\n  className?: string;\r\n}\r\n\r\nexport function InfoCard({ title, children, className = \"\" }: InfoCardProps) {\r\n  return (\r\n    <div\r\n      className={`rounded-xl border border-slate-700 bg-slate-800 p-6 ${className}`}\r\n    >\r\n      <h3 className=\"mb-4 text-xl font-semibold text-white\">{title}</h3>\r\n      {children}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\components\\SectionHeader.tsx","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":7,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":7,"endColumn":30},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":7,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":7,"endColumn":30}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ReactNode } from \"react\";\r\n\r\ninterface SectionHeaderProps {\r\n  children: ReactNode;\r\n}\r\n\r\nexport function SectionHeader({ children }: SectionHeaderProps) {\r\n  return (\r\n    <h2 className=\"text-center text-3xl font-bold text-white\">{children}</h2>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\components\\ToolCard.tsx","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":26,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":26,"endColumn":25},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":26,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":26,"endColumn":25}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ReactElement, cloneElement, SVGProps } from \"react\";\r\n\r\ninterface ToolCardProps {\r\n  icon: ReactElement<SVGProps<SVGSVGElement>>;\r\n  title: string;\r\n  description: string;\r\n  codeExample: string;\r\n  iconColor: string;\r\n  className?: string;\r\n}\r\n\r\nconst colorMap = {\r\n  green: { bg: \"bg-green-900\", text: \"text-green-400\" },\r\n  blue: { bg: \"bg-blue-900\", text: \"text-blue-400\" },\r\n  purple: { bg: \"bg-purple-900\", text: \"text-purple-400\" },\r\n  orange: { bg: \"bg-orange-900\", text: \"text-orange-400\" },\r\n  red: { bg: \"bg-red-900\", text: \"text-red-400\" },\r\n  indigo: { bg: \"bg-indigo-900\", text: \"text-indigo-400\" },\r\n  yellow: { bg: \"bg-yellow-900\", text: \"text-yellow-400\" },\r\n  cyan: { bg: \"bg-cyan-900\", text: \"text-cyan-400\" },\r\n  pink: { bg: \"bg-pink-900\", text: \"text-pink-400\" },\r\n  teal: { bg: \"bg-teal-900\", text: \"text-teal-400\" },\r\n  violet: { bg: \"bg-violet-900\", text: \"text-violet-400\" },\r\n};\r\n\r\nexport function ToolCard({\r\n  icon,\r\n  title,\r\n  description,\r\n  codeExample,\r\n  iconColor,\r\n  className = \"\",\r\n}: ToolCardProps) {\r\n  const colors = colorMap[iconColor as keyof typeof colorMap] || colorMap.blue;\r\n\r\n  return (\r\n    <div\r\n      className={`rounded-xl border border-slate-700 bg-slate-800 p-6 shadow-sm ${className}`}\r\n    >\r\n      <div className=\"mb-4 flex items-center\">\r\n        <div\r\n          className={`mr-4 flex h-12 w-12 items-center justify-center rounded-lg ${colors.bg}`}\r\n        >\r\n          {cloneElement(icon, { className: `h-6 w-6 ${colors.text}` })}\r\n        </div>\r\n        <h3 className=\"text-lg font-semibold text-white\">{title}</h3>\r\n      </div>\r\n      <p className=\"mb-4 text-sm text-slate-400\">{description}</p>\r\n      <code className=\"block rounded bg-slate-700 p-2 font-mono text-xs text-slate-200\">\r\n        {codeExample}\r\n      </code>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\components\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":28,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":28,"endColumn":35},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":28,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":28,"endColumn":35}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Metadata } from \"next\";\r\nimport { Geist, Geist_Mono } from \"next/font/google\";\r\nimport \"./globals.css\";\r\n\r\nconst geistSans = Geist({\r\n  variable: \"--font-geist-sans\",\r\n  subsets: [\"latin\"],\r\n});\r\n\r\nconst geistMono = Geist_Mono({\r\n  variable: \"--font-geist-mono\",\r\n  subsets: [\"latin\"],\r\n});\r\n\r\nexport const metadata: Metadata = {\r\n  title: \"Zeroheight MCP Server\",\r\n  description:\r\n    \"A powerful Model Context Protocol server that scrapes, indexes, and provides intelligent querying capabilities for Zeroheight design system documentation.\",\r\n  icons: {\r\n    icon: [\r\n      { url: \"/favicon.svg\", type: \"image/svg+xml\" },\r\n      { url: \"/favicon-16x16.svg\", type: \"image/svg+xml\", sizes: \"16x16\" },\r\n    ],\r\n    shortcut: \"/favicon.svg\",\r\n  },\r\n};\r\n\r\nexport default function RootLayout({\r\n  children,\r\n}: Readonly<{\r\n  children: React.ReactNode;\r\n}>) {\r\n  return (\r\n    <html lang=\"en\">\r\n      <body\r\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\r\n      >\r\n        {children}\r\n      </body>\r\n    </html>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\navigation-menu.tsx","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":14,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":14,"endColumn":39},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":14,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":14,"endColumn":39}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Menu } from \"@base-ui/react/menu\";\r\n\r\nconst { Root, Trigger, Portal, Positioner, Popup, Item } = Menu;\r\n\r\ninterface NavigationMenuProps {\r\n  activeSection: string;\r\n  navigationOptions: { value: string; label: string }[];\r\n  onSectionChange: (value: string) => void;\r\n  onScrollToSection: (value: string) => void;\r\n}\r\n\r\nexport default function NavigationMenu({\r\n  activeSection,\r\n  navigationOptions,\r\n  onSectionChange,\r\n  onScrollToSection,\r\n}: NavigationMenuProps) {\r\n  return (\r\n    <Root highlightItemOnHover={false} loopFocus={false}>\r\n      <Trigger className=\"flex w-full items-center justify-between rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm text-slate-300 transition-colors hover:border-cyan-400 hover:bg-slate-900 hover:text-white focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2 focus:ring-offset-slate-900\">\r\n        {navigationOptions.find((option) => option.value === activeSection)\r\n          ?.label || \"Navigate...\"}\r\n        <svg\r\n          className=\"h-4 w-4\"\r\n          fill=\"none\"\r\n          stroke=\"currentColor\"\r\n          viewBox=\"0 0 24 24\"\r\n        >\r\n          <path\r\n            strokeLinecap=\"round\"\r\n            strokeLinejoin=\"round\"\r\n            strokeWidth={2}\r\n            d=\"M19 9l-7 7-7-7\"\r\n          />\r\n        </svg>\r\n      </Trigger>\r\n      <Portal>\r\n        <Positioner className={\"z-50\"}>\r\n          <Popup className=\"mt-2 w-48 rounded-lg border border-slate-600 bg-slate-800 p-1 shadow-lg\">\r\n            {navigationOptions.map((option) => (\r\n              <Item\r\n                key={option.value}\r\n                autoFocus={option.value === activeSection}\r\n                className={`cursor-pointer rounded px-3 py-2 text-sm transition-colors hover:bg-slate-700 hover:text-white ${\r\n                  activeSection === option.value\r\n                    ? \"bg-cyan-400 text-slate-800\"\r\n                    : \"text-slate-300\"\r\n                }`}\r\n                onClick={() => {\r\n                  onSectionChange(option.value);\r\n                  onScrollToSection(option.value);\r\n                }}\r\n              >\r\n                {option.label}\r\n              </Item>\r\n            ))}\r\n          </Popup>\r\n        </Positioner>\r\n      </Portal>\r\n    </Root>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\app\\page.tsx","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":43,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":43,"endColumn":29},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":43,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":43,"endColumn":29},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":48,"column":29,"nodeType":"ArrowFunctionExpression","messageId":"missingReturnType","endLine":48,"endColumn":31},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":97,"column":47,"nodeType":"ArrowFunctionExpression","messageId":"missingReturnType","endLine":97,"endColumn":49}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { useEffect, useState } from \"react\";\r\nimport dynamic from \"next/dynamic\";\r\nimport { motion } from \"motion/react\";\r\nimport { SectionHeader, FeatureCard, ToolCard, InfoCard } from \"./components\";\r\nimport {\r\n  FaBolt,\r\n  FaMagnifyingGlass,\r\n  FaDatabase,\r\n  FaImage,\r\n  FaLock,\r\n  FaGlobe,\r\n  FaTrash,\r\n  FaFileLines,\r\n  FaBook,\r\n  FaLink,\r\n  FaKey,\r\n  FaList,\r\n  FaTerminal,\r\n  FaCamera,\r\n  FaRuler,\r\n  FaArrowRight,\r\n  FaChartBar,\r\n  FaCheck,\r\n  FaGithub,\r\n} from \"react-icons/fa6\";\r\n\r\n// Dynamically import the navigation menu to avoid SSR issues\r\nconst NavigationMenu = dynamic(() => import(\"./navigation-menu\"), {\r\n  ssr: false,\r\n  loading: () => (\r\n    <div className=\"w-48 h-10 bg-slate-800 rounded-lg animate-pulse\"></div>\r\n  ),\r\n});\r\n\r\ninterface NavigationOption {\r\n  value: string;\r\n  label: string;\r\n}\r\n\r\nexport default function Home() {\r\n  const [activeSection, setActiveSection] = useState(\"features\");\r\n  const [scrollProgress, setScrollProgress] = useState(0);\r\n\r\n  useEffect(() => {\r\n    const handleScroll = () => {\r\n      const sections = [\r\n        \"features\",\r\n        \"image-management\",\r\n        \"page-discovery\",\r\n        \"console-output\",\r\n        \"tools\",\r\n        \"tech\",\r\n        \"legal\",\r\n      ];\r\n      const scrollPosition = window.scrollY + 100; // Offset for header height\r\n\r\n      for (const section of sections) {\r\n        const element = document.getElementById(section);\r\n        if (element) {\r\n          const { offsetTop, offsetHeight } = element;\r\n          if (\r\n            scrollPosition >= offsetTop &&\r\n            scrollPosition < offsetTop + offsetHeight\r\n          ) {\r\n            setActiveSection(section);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Calculate scroll progress\r\n      const totalHeight =\r\n        document.documentElement.scrollHeight - window.innerHeight;\r\n      const progress = (window.scrollY / totalHeight) * 100;\r\n      setScrollProgress(progress);\r\n    };\r\n\r\n    window.addEventListener(\"scroll\", handleScroll);\r\n    handleScroll(); // Check initial position\r\n\r\n    return () => window.removeEventListener(\"scroll\", handleScroll);\r\n  }, []);\r\n\r\n  const navigationOptions: NavigationOption[] = [\r\n    { value: \"features\", label: \"Features\" },\r\n    { value: \"image-management\", label: \"Images\" },\r\n    { value: \"page-discovery\", label: \"Discovery\" },\r\n    { value: \"console-output\", label: \"Output\" },\r\n    { value: \"tools\", label: \"Tools\" },\r\n    { value: \"tech\", label: \"Tech Stack\" },\r\n    { value: \"legal\", label: \"Legal\" },\r\n  ];\r\n\r\n  const scrollToSection = (sectionId: string) => {\r\n    const element = document.getElementById(sectionId);\r\n    if (element) {\r\n      const headerOffset = 80; // Account for sticky header height\r\n      const elementPosition = element.offsetTop;\r\n      const offsetPosition = elementPosition - headerOffset;\r\n\r\n      window.scrollTo({\r\n        top: offsetPosition,\r\n        behavior: \"smooth\",\r\n      });\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {/* Header */}\r\n      <header className=\"sticky top-0 z-50 border-b border-slate-700 bg-slate-900/95 backdrop-blur-sm\">\r\n        {/* Scroll Progress Bar */}\r\n        <motion.div\r\n          className=\"absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-cyan-500 to-blue-500 origin-left\"\r\n          style={{ scaleX: scrollProgress / 100 }}\r\n          transition={{ duration: 0.1 }}\r\n        />\r\n\r\n        <div className=\"mx-auto max-w-7xl px-4 sm:px-6 lg:px-8\">\r\n          <div className=\"flex items-center justify-between py-6\">\r\n            <div className=\"flex items-center space-x-3\">\r\n              <div className=\"flex h-8 w-8 items-center justify-center rounded-lg bg-blue-600\">\r\n                <span className=\"text-sm font-bold text-white\">ZH</span>\r\n              </div>\r\n              <h1 className=\"text-xl font-bold text-white\">Zeroheight MCP</h1>\r\n            </div>\r\n            {/* Desktop Navigation - Horizontal on md to lg, Dropdown on xl+ */}\r\n            <nav className=\"hidden space-x-8 lg:flex\">\r\n              <button\r\n                onClick={() => scrollToSection(\"features\")}\r\n                className={`relative transform transition-all duration-500 ease-in-out hover:scale-105 ${\r\n                  activeSection === \"features\"\r\n                    ? \"border-b-2 border-cyan-400 pb-1 text-cyan-400\"\r\n                    : \"text-slate-400 hover:text-white\"\r\n                }`}\r\n              >\r\n                Features\r\n                {activeSection === \"features\" && (\r\n                  <div className=\"absolute -bottom-1 left-0 h-0.5 w-full animate-pulse bg-cyan-400\"></div>\r\n                )}\r\n              </button>\r\n              <button\r\n                onClick={() => scrollToSection(\"image-management\")}\r\n                className={`relative transform transition-all duration-500 ease-in-out hover:scale-105 ${\r\n                  activeSection === \"image-management\"\r\n                    ? \"border-b-2 border-cyan-400 pb-1 text-cyan-400\"\r\n                    : \"text-slate-400 hover:text-white\"\r\n                }`}\r\n              >\r\n                Images\r\n                {activeSection === \"image-management\" && (\r\n                  <div className=\"absolute -bottom-1 left-0 h-0.5 w-full animate-pulse bg-cyan-400\"></div>\r\n                )}\r\n              </button>\r\n              <button\r\n                onClick={() => scrollToSection(\"page-discovery\")}\r\n                className={`relative transform transition-all duration-500 ease-in-out hover:scale-105 ${\r\n                  activeSection === \"page-discovery\"\r\n                    ? \"border-b-2 border-cyan-400 pb-1 text-cyan-400\"\r\n                    : \"text-slate-400 hover:text-white\"\r\n                }`}\r\n              >\r\n                Discovery\r\n                {activeSection === \"page-discovery\" && (\r\n                  <div className=\"absolute -bottom-1 left-0 h-0.5 w-full animate-pulse bg-cyan-400\"></div>\r\n                )}\r\n              </button>\r\n              <button\r\n                onClick={() => scrollToSection(\"console-output\")}\r\n                className={`relative transform transition-all duration-500 ease-in-out hover:scale-105 ${\r\n                  activeSection === \"console-output\"\r\n                    ? \"border-b-2 border-cyan-400 pb-1 text-cyan-400\"\r\n                    : \"text-slate-400 hover:text-white\"\r\n                }`}\r\n              >\r\n                Output\r\n                {activeSection === \"console-output\" && (\r\n                  <div className=\"absolute -bottom-1 left-0 h-0.5 w-full animate-pulse bg-cyan-400\"></div>\r\n                )}\r\n              </button>\r\n              <button\r\n                onClick={() => scrollToSection(\"tools\")}\r\n                className={`relative transform transition-all duration-500 ease-in-out hover:scale-105 ${\r\n                  activeSection === \"tools\"\r\n                    ? \"border-b-2 border-cyan-400 pb-1 text-cyan-400\"\r\n                    : \"text-slate-400 hover:text-white\"\r\n                }`}\r\n              >\r\n                Tools\r\n                {activeSection === \"tools\" && (\r\n                  <div className=\"absolute -bottom-1 left-0 h-0.5 w-full animate-pulse bg-cyan-400\"></div>\r\n                )}\r\n              </button>\r\n              <button\r\n                onClick={() => scrollToSection(\"tech\")}\r\n                className={`relative transform transition-all duration-500 ease-in-out hover:scale-105 ${\r\n                  activeSection === \"tech\"\r\n                    ? \"border-b-2 border-cyan-400 pb-1 text-cyan-400\"\r\n                    : \"text-slate-400 hover:text-white\"\r\n                }`}\r\n              >\r\n                Tech Stack\r\n                {activeSection === \"tech\" && (\r\n                  <div className=\"absolute -bottom-1 left-0 h-0.5 w-full animate-pulse bg-cyan-400\"></div>\r\n                )}\r\n              </button>\r\n              <button\r\n                onClick={() => scrollToSection(\"legal\")}\r\n                className={`relative transform transition-all duration-500 ease-in-out hover:scale-105 ${\r\n                  activeSection === \"legal\"\r\n                    ? \"border-b-2 border-cyan-400 pb-1 text-cyan-400\"\r\n                    : \"text-slate-400 hover:text-white\"\r\n                }`}\r\n              >\r\n                Legal\r\n                {activeSection === \"legal\" && (\r\n                  <div className=\"absolute -bottom-1 left-0 h-0.5 w-full animate-pulse bg-cyan-400\"></div>\r\n                )}\r\n              </button>\r\n            </nav>\r\n\r\n            {/* Dropdown Menu for Large Screens */}\r\n            <div className=\"lg:hidden w-48\">\r\n              <NavigationMenu\r\n                activeSection={activeSection}\r\n                navigationOptions={navigationOptions}\r\n                onSectionChange={setActiveSection}\r\n                onScrollToSection={scrollToSection}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      {/* Hero Section - Full Width */}\r\n      <motion.section\r\n        className=\"relative overflow-hidden\"\r\n        initial={{ opacity: 0 }}\r\n        animate={{ opacity: 1 }}\r\n        transition={{ duration: 1 }}\r\n      >\r\n        <motion.div\r\n          className=\"absolute inset-0 bg-gradient-to-br from-slate-900 via-blue-900/30 to-purple-900/40\"\r\n          animate={{\r\n            backgroundPosition: [\"0% 0%\", \"100% 100%\"],\r\n          }}\r\n          transition={{\r\n            duration: 20,\r\n            repeat: Infinity,\r\n            repeatType: \"reverse\",\r\n          }}\r\n        ></motion.div>\r\n        <div className=\"absolute inset-0 bg-gradient-to-r from-blue-600/10 via-transparent to-purple-600/10\"></div>\r\n        <motion.div\r\n          className=\"absolute top-0 left-1/4 h-96 w-96 rounded-full bg-blue-500/20 blur-3xl\"\r\n          animate={{\r\n            scale: [1, 1.2, 1],\r\n            opacity: [0.2, 0.4, 0.2],\r\n          }}\r\n          transition={{\r\n            duration: 8,\r\n            repeat: Infinity,\r\n            repeatType: \"reverse\",\r\n          }}\r\n        ></motion.div>\r\n        <motion.div\r\n          className=\"absolute right-1/4 bottom-0 h-96 w-96 rounded-full bg-purple-500/20 blur-3xl\"\r\n          animate={{\r\n            scale: [1.2, 1, 1.2],\r\n            opacity: [0.3, 0.1, 0.3],\r\n          }}\r\n          transition={{\r\n            duration: 10,\r\n            repeat: Infinity,\r\n            repeatType: \"reverse\",\r\n          }}\r\n        ></motion.div>\r\n\r\n        <div className=\"relative mx-auto max-w-7xl px-4 py-24 sm:px-6 md:py-32 lg:px-8\">\r\n          <div className=\"text-center\">\r\n            <motion.h1\r\n              className=\"mb-6 text-5xl leading-tight font-bold text-white md:text-7xl\"\r\n              initial={{ y: 50, opacity: 0 }}\r\n              animate={{ y: 0, opacity: 1 }}\r\n              transition={{ duration: 0.5, delay: 0.1 }}\r\n            >\r\n              Zeroheight Design System\r\n              <motion.span\r\n                className=\"block bg-gradient-to-r from-cyan-400 via-blue-400 to-purple-400 bg-clip-text text-transparent\"\r\n                animate={{\r\n                  backgroundPosition: [\"0% 50%\", \"100% 50%\", \"0% 50%\"],\r\n                }}\r\n                transition={{\r\n                  duration: 3,\r\n                  repeat: Infinity,\r\n                  ease: \"linear\",\r\n                }}\r\n              >\r\n                MCP Server\r\n              </motion.span>\r\n            </motion.h1>\r\n            <motion.p\r\n              className=\"mx-auto mb-12 max-w-4xl text-xl leading-relaxed text-slate-300 md:text-2xl\"\r\n              initial={{ y: 30, opacity: 0 }}\r\n              animate={{ y: 0, opacity: 1 }}\r\n              transition={{ duration: 0.5, delay: 0.2 }}\r\n            >\r\n              A powerful Model Context Protocol server that scrapes, indexes,\r\n              and provides intelligent querying capabilities for Zeroheight\r\n              design system documentation. Built for design systems teams who\r\n              need programmatic access to their component libraries and design\r\n              guidelines.\r\n            </motion.p>\r\n            <motion.div\r\n              className=\"flex flex-col justify-center gap-6 sm:flex-row\"\r\n              initial={{ y: 20, opacity: 0 }}\r\n              animate={{ y: 0, opacity: 1 }}\r\n              transition={{ duration: 0.5, delay: 0.3 }}\r\n            >\r\n              <motion.div\r\n                whileHover={{ scale: 1.05 }}\r\n                whileTap={{ scale: 0.95 }}\r\n              >\r\n                <Link\r\n                  href=\"#tools\"\r\n                  className=\"transform rounded-xl bg-gradient-to-r from-cyan-500 to-blue-600 px-10 py-4 text-lg font-semibold text-white shadow-2xl transition-all duration-300 hover:from-cyan-600 hover:to-blue-700 hover:shadow-cyan-500/25 flex items-center\"\r\n                >\r\n                  Get Started\r\n                </Link>\r\n              </motion.div>\r\n              <motion.div\r\n                whileHover={{ scale: 1.05 }}\r\n                whileTap={{ scale: 0.95 }}\r\n              >\r\n                <a\r\n                  href=\"https://github.com/drexxdk/zeroheight-mcp\"\r\n                  target=\"_blank\"\r\n                  rel=\"noopener noreferrer\"\r\n                  className=\"rounded-xl border-2 border-slate-400 bg-slate-800/30 px-10 py-4 text-lg font-semibold text-slate-300 backdrop-blur-sm transition-all duration-300 hover:border-cyan-400 hover:bg-slate-700/50 hover:text-white flex items-center gap-2\"\r\n                >\r\n                  <FaGithub className=\"h-5 w-5\" />\r\n                  View on GitHub\r\n                </a>\r\n              </motion.div>\r\n            </motion.div>\r\n          </div>\r\n        </div>\r\n      </motion.section>\r\n\r\n      {/* Main Content */}\r\n      <main className=\"mx-auto flex max-w-7xl flex-col px-4 py-8 sm:px-6 lg:px-8\">\r\n        {/* Features Section */}\r\n        <motion.section\r\n          id=\"features\"\r\n          className=\"grid gap-6 py-8\"\r\n          initial={{ opacity: 0, y: 50 }}\r\n          whileInView={{ opacity: 1, y: 0 }}\r\n          transition={{ duration: 0.4 }}\r\n          viewport={{ once: true }}\r\n        >\r\n          <SectionHeader>Key Features</SectionHeader>\r\n          <motion.div\r\n            className=\"grid gap-8 md:grid-cols-2 lg:grid-cols-3\"\r\n            variants={{\r\n              hidden: { opacity: 0 },\r\n              show: {\r\n                opacity: 1,\r\n                transition: {\r\n                  staggerChildren: 0.05,\r\n                },\r\n              },\r\n            }}\r\n            initial=\"hidden\"\r\n            whileInView=\"show\"\r\n            viewport={{ once: true }}\r\n          >\r\n            <motion.div\r\n              variants={{\r\n                hidden: { opacity: 0, y: 20 },\r\n                show: { opacity: 1, y: 0 },\r\n              }}\r\n              className=\"h-full\"\r\n            >\r\n              <FeatureCard\r\n                icon={<FaBolt />}\r\n                title=\"Intelligent Scraping\"\r\n                description=\"Automatically discovers and scrapes all pages, components, and documentation from your Zeroheight design system with smart link following and content extraction.\"\r\n                iconColor=\"green\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              variants={{\r\n                hidden: { opacity: 0, y: 20 },\r\n                show: { opacity: 1, y: 0 },\r\n              }}\r\n              className=\"h-full\"\r\n            >\r\n              <FeatureCard\r\n                icon={<FaMagnifyingGlass />}\r\n                title=\"Powerful Search\"\r\n                description=\"Query your design system data with full-text search across titles, content, and URLs. Find components, patterns, and guidelines instantly.\"\r\n                iconColor=\"blue\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              variants={{\r\n                hidden: { opacity: 0, y: 20 },\r\n                show: { opacity: 1, y: 0 },\r\n              }}\r\n              className=\"h-full\"\r\n            >\r\n              <FeatureCard\r\n                icon={<FaDatabase />}\r\n                title=\"MCP Integration\"\r\n                description=\"Built on the Model Context Protocol for seamless integration with AI assistants, design tools, and development workflows.\"\r\n                iconColor=\"purple\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              variants={{\r\n                hidden: { opacity: 0, y: 20 },\r\n                show: { opacity: 1, y: 0 },\r\n              }}\r\n              className=\"h-full\"\r\n            >\r\n              <FeatureCard\r\n                icon={<FaImage />}\r\n                title=\"Image Management\"\r\n                description=\"Automatically downloads, processes, and stores design system images and assets with optimized storage and fast retrieval.\"\r\n                iconColor=\"orange\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              variants={{\r\n                hidden: { opacity: 0, y: 20 },\r\n                show: { opacity: 1, y: 0 },\r\n              }}\r\n              className=\"h-full\"\r\n            >\r\n              <FeatureCard\r\n                icon={<FaLock />}\r\n                title=\"Secure Access\"\r\n                description=\"Enterprise-grade authentication with API key validation and secure access controls for your design system data.\"\r\n                iconColor=\"red\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              variants={{\r\n                hidden: { opacity: 0, y: 20 },\r\n                show: { opacity: 1, y: 0 },\r\n              }}\r\n              className=\"h-full\"\r\n            >\r\n              <FeatureCard\r\n                icon={<FaBolt />}\r\n                title=\"High Performance\"\r\n                description=\"Optimized for speed with bulk database operations, progress tracking, and efficient caching for large design systems.\"\r\n                iconColor=\"indigo\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n          </motion.div>\r\n        </motion.section>\r\n\r\n        {/* Image Management Section */}\r\n        <motion.section\r\n          id=\"image-management\"\r\n          className=\"grid gap-6 py-8\"\r\n          initial={{ opacity: 0, y: 50 }}\r\n          whileInView={{ opacity: 1, y: 0 }}\r\n          transition={{ duration: 0.4 }}\r\n          viewport={{ once: true }}\r\n        >\r\n          <SectionHeader>Image Management</SectionHeader>\r\n          <motion.div\r\n            className=\"grid gap-8 md:grid-cols-2\"\r\n            initial={{ opacity: 0 }}\r\n            whileInView={{ opacity: 1 }}\r\n            transition={{ duration: 0.4, delay: 0.1 }}\r\n            viewport={{ once: true }}\r\n          >\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.05 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <InfoCard title=\"Supported Image Types\" className=\"h-full\">\r\n                <div className=\"grid gap-4 md:grid-cols-2\">\r\n                  <div>\r\n                    <h4 className=\"mb-2 font-medium text-green-400 flex items-center gap-2\">\r\n                      <FaCheck className=\"text-green-400\" />\r\n                      Supported\r\n                    </h4>\r\n                    <ul className=\"space-y-1 text-sm text-slate-400\">\r\n                      <li>‚Ä¢ PNG - Portable Network Graphics</li>\r\n                      <li>‚Ä¢ JPG/JPEG - Joint Photographic Experts Group</li>\r\n                      <li>‚Ä¢ WebP - Modern web image format</li>\r\n                    </ul>\r\n                  </div>\r\n                  <div>\r\n                    <h4 className=\"mb-2 font-medium text-red-400 flex items-center gap-2\">\r\n                      <FaTrash className=\"text-red-400\" />\r\n                      Filtered Out\r\n                    </h4>\r\n                    <ul className=\"space-y-1 text-sm text-slate-400\">\r\n                      <li>‚Ä¢ GIF - Graphics Interchange Format</li>\r\n                      <li>‚Ä¢ SVG - Scalable Vector Graphics</li>\r\n                    </ul>\r\n                  </div>\r\n                </div>\r\n              </InfoCard>\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.1 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <InfoCard title=\"Upload Process\" className=\"h-full\">\r\n                <p className=\"mb-4 text-slate-400\">\r\n                  Images are automatically downloaded from Zeroheight and\r\n                  uploaded to Supabase Storage buckets with intelligent\r\n                  deduplication.\r\n                </p>\r\n                <ul className=\"space-y-2 text-sm text-slate-400\">\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-blue-500\"></span>\r\n                    <span>\r\n                      Each image gets a unique path based on MD5 hash for\r\n                      efficient deduplication\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-blue-500\"></span>\r\n                    <span>\r\n                      Query results include complete Supabase storage URLs for\r\n                      direct access\r\n                    </span>\r\n                  </li>\r\n                </ul>\r\n              </InfoCard>\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.5, delay: 0.3 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <InfoCard title=\"Duplicate Prevention\" className=\"h-full\">\r\n                <p className=\"mb-4 text-slate-400\">\r\n                  MD5 hashing ensures identical images are never uploaded twice,\r\n                  minimizing storage costs.\r\n                </p>\r\n                <ul className=\"space-y-2 text-sm text-slate-400\">\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-green-500\"></span>\r\n                    <span>\r\n                      Existing images are detected and reused instead of\r\n                      re-uploading\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-green-500\"></span>\r\n                    <span>\r\n                      Storage costs are minimized through intelligent\r\n                      deduplication\r\n                    </span>\r\n                  </li>\r\n                </ul>\r\n              </InfoCard>\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.5, delay: 0.4 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <InfoCard title=\"Image Optimization\" className=\"h-full\">\r\n                <div className=\"grid gap-4 md:grid-cols-3\">\r\n                  <div className=\"text-center\">\r\n                    <div className=\"mb-2 flex justify-center\">\r\n                      <div className=\"flex h-12 w-12 items-center justify-center rounded-lg bg-cyan-600\">\r\n                        <FaCamera className=\"h-6 w-6 text-white\" />\r\n                      </div>\r\n                    </div>\r\n                    <h4 className=\"mb-1 font-medium text-cyan-400\">\r\n                      Format Conversion\r\n                    </h4>\r\n                    <p className=\"text-sm text-slate-400\">\r\n                      All images converted to JPEG format\r\n                    </p>\r\n                  </div>\r\n                  <div className=\"text-center\">\r\n                    <div className=\"mb-2 flex justify-center\">\r\n                      <div className=\"flex h-12 w-12 items-center justify-center rounded-lg bg-cyan-600\">\r\n                        <FaBolt className=\"h-6 w-6 text-white\" />\r\n                      </div>\r\n                    </div>\r\n                    <h4 className=\"mb-1 font-medium text-cyan-400\">\r\n                      Quality Reduction\r\n                    </h4>\r\n                    <p className=\"text-sm text-slate-400\">\r\n                      Reduced to 80% quality\r\n                    </p>\r\n                  </div>\r\n                  <div className=\"text-center\">\r\n                    <div className=\"mb-2 flex justify-center\">\r\n                      <div className=\"flex h-12 w-12 items-center justify-center rounded-lg bg-cyan-600\">\r\n                        <FaRuler className=\"h-6 w-6 text-white\" />\r\n                      </div>\r\n                    </div>\r\n                    <h4 className=\"mb-1 font-medium text-cyan-400\">\r\n                      Resolution Limiting\r\n                    </h4>\r\n                    <p className=\"text-sm text-slate-400\">\r\n                      Max 1920px on longest side\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </InfoCard>\r\n            </motion.div>\r\n          </motion.div>\r\n        </motion.section>\r\n\r\n        {/* Page Discovery Section */}\r\n        <motion.section\r\n          id=\"page-discovery\"\r\n          className=\"grid gap-6 py-8\"\r\n          initial={{ opacity: 0, y: 50 }}\r\n          whileInView={{ opacity: 1, y: 0 }}\r\n          transition={{ duration: 0.4 }}\r\n          viewport={{ once: true }}\r\n        >\r\n          <SectionHeader>Page Discovery and Redirect Handling</SectionHeader>\r\n          <motion.div\r\n            className=\"grid gap-8 md:grid-cols-2\"\r\n            initial={{ opacity: 0 }}\r\n            whileInView={{ opacity: 1 }}\r\n            transition={{ duration: 0.4, delay: 0.1 }}\r\n            viewport={{ once: true }}\r\n          >\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.05 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <InfoCard title=\"Page Discovery\" className=\"h-full\">\r\n                <p className=\"mb-4 text-slate-400\">\r\n                  The scraper intelligently discovers and processes pages while\r\n                  maintaining efficiency.\r\n                </p>\r\n                <ul className=\"space-y-2 text-sm text-slate-400\">\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-blue-500\"></span>\r\n                    <span>\r\n                      Starts with the configured Zeroheight project URL\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-blue-500\"></span>\r\n                    <span>\r\n                      Automatically finds all linked pages within the same\r\n                      domain\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-blue-500\"></span>\r\n                    <span>\r\n                      Discovers both direct page links and navigation links\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-blue-500\"></span>\r\n                    <span>\r\n                      Continues discovering new links as it processes each page\r\n                    </span>\r\n                  </li>\r\n                </ul>\r\n              </InfoCard>\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.1 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <InfoCard title=\"Redirect Detection\" className=\"h-full\">\r\n                <p className=\"mb-4 text-slate-400\">\r\n                  After navigating to each URL, the scraper detects redirects\r\n                  and normalizes URLs.\r\n                </p>\r\n                <ul className=\"space-y-2 text-sm text-slate-400\">\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-yellow-500\"></span>\r\n                    <span>\r\n                      Checks the final destination URL after each navigation\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-yellow-500\"></span>\r\n                    <span>\r\n                      Detects when URLs redirect to other pages (common in\r\n                      Zeroheight)\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-yellow-500\"></span>\r\n                    <span>\r\n                      Uses the final URL for storage instead of the original\r\n                      redirecting URL\r\n                    </span>\r\n                  </li>\r\n                </ul>\r\n              </InfoCard>\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.15 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <InfoCard title=\"Duplicate Prevention\" className=\"h-full\">\r\n                <p className=\"mb-4 text-slate-400\">\r\n                  Maintains a set of processed URLs to avoid re-processing the\r\n                  same content multiple times.\r\n                </p>\r\n                <ul className=\"space-y-2 text-sm text-slate-400\">\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-green-500\"></span>\r\n                    <span>\r\n                      Maintains a set of processed URLs to avoid re-processing\r\n                      the same content\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-green-500\"></span>\r\n                    <span>\r\n                      When a redirect leads to an already processed page, skips\r\n                      processing entirely\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-green-500\"></span>\r\n                    <span>\r\n                      Progress counter only increments for actually processed\r\n                      unique pages\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-green-500\"></span>\r\n                    <span>\r\n                      Database storage uses upsert operations to handle any\r\n                      remaining duplicates\r\n                    </span>\r\n                  </li>\r\n                </ul>\r\n              </InfoCard>\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.2 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <InfoCard title=\"Link Discovery Limits\" className=\"h-full\">\r\n                <p className=\"mb-4 text-slate-400\">\r\n                  When a page limit is set, the scraper stops discovering new\r\n                  links once the limit is reached.\r\n                </p>\r\n                <ul className=\"space-y-2 text-sm text-slate-400\">\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-purple-500\"></span>\r\n                    <span>\r\n                      When a page limit is set (e.g., limit: 3), stops\r\n                      discovering new links once the limit is reached\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-purple-500\"></span>\r\n                    <span>\r\n                      Prevents the processing queue from growing beyond the\r\n                      specified number of pages\r\n                    </span>\r\n                  </li>\r\n                  <li className=\"flex items-start\">\r\n                    <span className=\"mr-2 mt-1 h-1.5 w-1.5 rounded-full bg-purple-500\"></span>\r\n                    <span>\r\n                      Ensures predictable execution time and resource usage\r\n                    </span>\r\n                  </li>\r\n                </ul>\r\n              </InfoCard>\r\n            </motion.div>\r\n          </motion.div>\r\n        </motion.section>\r\n\r\n        {/* Console Output Example Section */}\r\n        <motion.section\r\n          id=\"console-output\"\r\n          className=\"grid gap-6 py-8\"\r\n          initial={{ opacity: 0, y: 50 }}\r\n          whileInView={{ opacity: 1, y: 0 }}\r\n          transition={{ duration: 0.4 }}\r\n          viewport={{ once: true }}\r\n        >\r\n          <SectionHeader>Console Output Example</SectionHeader>\r\n          <motion.div\r\n            className=\"rounded-xl border border-slate-700 bg-slate-800 p-6\"\r\n            initial={{ opacity: 0, scale: 0.95 }}\r\n            whileInView={{ opacity: 1, scale: 1 }}\r\n            transition={{ duration: 0.4, delay: 0.1 }}\r\n            viewport={{ once: true }}\r\n          >\r\n            <p className=\"mb-6 text-slate-400\">\r\n              Here&apos;s an example of the console output when running the\r\n              scraper:\r\n            </p>\r\n            <div className=\"w-full overflow-x-auto\">\r\n              <div className=\"grid\">\r\n                <pre className=\"overflow-auto whitespace-pre text-slate-200 text-sm font-mono bg-slate-900 p-4 rounded-lg break-all\">{`[dotenv@17.2.4] injecting env (5) from .env.local\r\nStarting Zeroheight project scrape...\r\nNavigating to https://example-design-system.zeroheight.com...\r\nPassword provided, checking for login form...\r\nFound password input field, entering password...\r\nPassword entered, waiting for login to process...\r\nCurrent URL after password entry: https://example-design-system.zeroheight.com/abc123def/p/example-project-home\r\nPassword input no longer visible - login appears successful\r\nFound 23 navigation links after login attempt\r\nFinal URL after loading: https://example-design-system.zeroheight.com/abc123def/p/example-project-home\r\nPage title: Example Design System\r\nContent container found: true\r\nBody text length: 51103 characters\r\nProject URL: https://example-design-system.zeroheight.com\r\nAllowed hostname: example-design-system.zeroheight.com\r\nFound 29 total raw links on page\r\nSample raw links: https://example-design-system.zeroheight.com/abc123def/p/project-home, https://example-design-system.zeroheight.com/abc123def/n/components, ...\r\nFound 0 links on main page\r\nFound 0 Zeroheight page links (/p/ pattern)\r\nSample ZH page links:\r\nCurrent page URL: https://example-design-system.zeroheight.com/abc123def/p/example-project-home\r\nTotal unique links to process: 1\r\n[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] Processing page 1/3: https://example-design-system.zeroheight.com/abc123def/p/example-project-home\r\nDiscovered new link: https://example-design-system.zeroheight.com/abc123def/p/project-home\r\nDiscovered new link: https://example-design-system.zeroheight.com/abc123def/n/components\r\nDiscovered new link: https://example-design-system.zeroheight.com/abc123def/n/patterns\r\n... (more discovered links)\r\nRedirect detected: https://example-design-system.zeroheight.com/abc123def/p/project-home -> https://example-design-system.zeroheight.com/abc123def/p/example-project-home\r\nSkipping https://example-design-system.zeroheight.com/abc123def/p/project-home - final URL https://example-design-system.zeroheight.com/abc123def/p/example-project-home already processed\r\nRedirect detected: https://example-design-system.zeroheight.com/abc123def/n/components -> https://example-design-system.zeroheight.com/abc123def/p/component-library\r\n[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] Processing page 2/3: https://example-design-system.zeroheight.com/abc123def/p/component-library\r\n... (more processing output)\r\n[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] Processing page 3/3: https://example-design-system.zeroheight.com/abc123def/p/design-tokens\r\nCollected 3 pages for bulk insertion\r\nSuccessfully inserted 3 pages\r\n[‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] Processing image 1/13: component-mockup-1.png\r\n[‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] Processing image 2/13: design-token-example.png\r\n... (image processing continues)\r\nSuccessfully inserted 2 images\r\nScraping completed successfully`}</pre>\r\n              </div>\r\n            </div>\r\n            <motion.div\r\n              className=\"mt-6 space-y-4\"\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.6, delay: 0.4 }}\r\n              viewport={{ once: true }}\r\n            >\r\n              <h4 className=\"text-lg font-semibold text-white\">\r\n                Output Explanation\r\n              </h4>\r\n              <motion.div\r\n                className=\"grid gap-3 md:grid-cols-2\"\r\n                initial={{ opacity: 0 }}\r\n                whileInView={{ opacity: 1 }}\r\n                transition={{ duration: 0.6, delay: 0.6 }}\r\n                viewport={{ once: true }}\r\n              >\r\n                <motion.div\r\n                  initial={{ opacity: 0, x: -20 }}\r\n                  whileInView={{ opacity: 1, x: 0 }}\r\n                  transition={{ duration: 0.5, delay: 0.1 }}\r\n                  viewport={{ once: true }}\r\n                >\r\n                  <h5 className=\"mb-2 font-medium text-cyan-400 flex items-center gap-2\">\r\n                    <FaLock className=\"text-cyan-400\" />\r\n                    Navigation & Authentication\r\n                  </h5>\r\n                  <p className=\"text-sm text-slate-400\">\r\n                    Shows login process and initial page loading\r\n                  </p>\r\n                </motion.div>\r\n                <motion.div\r\n                  initial={{ opacity: 0, x: -20 }}\r\n                  whileInView={{ opacity: 1, x: 0 }}\r\n                  transition={{ duration: 0.5, delay: 0.2 }}\r\n                  viewport={{ once: true }}\r\n                >\r\n                  <h5 className=\"mb-2 font-medium text-cyan-400 flex items-center gap-2\">\r\n                    <FaLink className=\"text-cyan-400\" />\r\n                    Link Discovery\r\n                  </h5>\r\n                  <p className=\"text-sm text-slate-400\">\r\n                    Lists newly discovered links as they&apos;re found\r\n                  </p>\r\n                </motion.div>\r\n                <motion.div\r\n                  initial={{ opacity: 0, x: -20 }}\r\n                  whileInView={{ opacity: 1, x: 0 }}\r\n                  transition={{ duration: 0.5, delay: 0.3 }}\r\n                  viewport={{ once: true }}\r\n                >\r\n                  <h5 className=\"mb-2 font-medium text-cyan-400 flex items-center gap-2\">\r\n                    <FaArrowRight className=\"text-cyan-400\" />\r\n                    Redirect Detection\r\n                  </h5>\r\n                  <p className=\"text-sm text-slate-400\">\r\n                    Identifies when URLs redirect and skips duplicates\r\n                  </p>\r\n                </motion.div>\r\n                <motion.div\r\n                  initial={{ opacity: 0, x: -20 }}\r\n                  whileInView={{ opacity: 1, x: 0 }}\r\n                  transition={{ duration: 0.5, delay: 0.4 }}\r\n                  viewport={{ once: true }}\r\n                >\r\n                  <h5 className=\"mb-2 font-medium text-cyan-400 flex items-center gap-2\">\r\n                    <FaChartBar className=\"text-cyan-400\" />\r\n                    Progress Tracking\r\n                  </h5>\r\n                  <p className=\"text-sm text-slate-400\">\r\n                    Visual progress bars showing page processing status\r\n                  </p>\r\n                </motion.div>\r\n                <motion.div\r\n                  initial={{ opacity: 0, x: -20 }}\r\n                  whileInView={{ opacity: 1, x: 0 }}\r\n                  transition={{ duration: 0.5, delay: 0.5 }}\r\n                  viewport={{ once: true }}\r\n                >\r\n                  <h5 className=\"mb-2 font-medium text-cyan-400 flex items-center gap-2\">\r\n                    <FaImage className=\"text-cyan-400\" />\r\n                    Image Processing\r\n                  </h5>\r\n                  <p className=\"text-sm text-slate-400\">\r\n                    Individual progress for each image being optimized and\r\n                    uploaded\r\n                  </p>\r\n                </motion.div>\r\n                <motion.div\r\n                  initial={{ opacity: 0, x: -20 }}\r\n                  whileInView={{ opacity: 1, x: 0 }}\r\n                  transition={{ duration: 0.5, delay: 0.6 }}\r\n                  viewport={{ once: true }}\r\n                >\r\n                  <h5 className=\"mb-2 font-medium text-cyan-400 flex items-center gap-2\">\r\n                    <FaCheck className=\"text-cyan-400\" />\r\n                    Final Summary\r\n                  </h5>\r\n                  <p className=\"text-sm text-slate-400\">\r\n                    Reports total pages and images processed successfully\r\n                  </p>\r\n                </motion.div>\r\n              </motion.div>\r\n            </motion.div>\r\n          </motion.div>\r\n        </motion.section>\r\n        <motion.section\r\n          id=\"tools\"\r\n          className=\"grid gap-6 py-8\"\r\n          initial={{ opacity: 0, y: 50 }}\r\n          whileInView={{ opacity: 1, y: 0 }}\r\n          transition={{ duration: 0.4 }}\r\n          viewport={{ once: true }}\r\n        >\r\n          <SectionHeader>MCP Tools</SectionHeader>\r\n          <motion.div\r\n            className=\"grid gap-8 md:grid-cols-2 lg:grid-cols-3\"\r\n            initial={{ opacity: 0 }}\r\n            whileInView={{ opacity: 1 }}\r\n            transition={{ duration: 0.4, delay: 0.1 }}\r\n            viewport={{ once: true }}\r\n          >\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.05 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaGlobe />}\r\n                title=\"Scrape Zeroheight Project\"\r\n                description=\"Automatically discovers and scrapes all pages from your Zeroheight design system, including content and images. Uses upsert logic for safe re-running without clearing existing data.\"\r\n                codeExample='\"Scrape the Zeroheight design system\"'\r\n                iconColor=\"blue\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.07 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaMagnifyingGlass />}\r\n                title=\"Query Zeroheight Data\"\r\n                description=\"Search and retrieve cached design system data with full-text search. Returns complete Supabase storage URLs for images.\"\r\n                codeExample='\"Find pages about buttons\"'\r\n                iconColor=\"green\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.09 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaTrash />}\r\n                title=\"Clear Zeroheight Data\"\r\n                description=\"Remove all cached Zeroheight data and images from the database. Requires explicit API key confirmation for safety.\"\r\n                codeExample='\"Clear all cached Zeroheight data\"'\r\n                iconColor=\"red\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.11 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaFileLines />}\r\n                title=\"Execute SQL\"\r\n                description=\"Execute raw SQL queries directly on the Supabase database for advanced data operations and analysis.\"\r\n                codeExample='\"Run SQL query: SELECT COUNT(*) FROM pages\"'\r\n                iconColor=\"yellow\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.13 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaDatabase />}\r\n                title=\"List Tables\"\r\n                description=\"List all tables in the database schemas to understand the data structure.\"\r\n                codeExample='\"Show me all database tables\"'\r\n                iconColor=\"cyan\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.15 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaBook />}\r\n                title=\"Get Database Schema\"\r\n                description=\"Retrieve TypeScript type definitions for the complete database schema.\"\r\n                codeExample='\"Get the database schema types\"'\r\n                iconColor=\"purple\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.17 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaLink />}\r\n                title=\"Get Project URL\"\r\n                description=\"Retrieve the API URL for your Supabase project.\"\r\n                codeExample='\"What&apos;s the Supabase project URL?\"'\r\n                iconColor=\"indigo\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.19 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaKey />}\r\n                title=\"Get Publishable API Keys\"\r\n                description=\"Get all publishable API keys for your project, including legacy anon keys and modern keys.\"\r\n                codeExample='\"Show me the API keys\"'\r\n                iconColor=\"pink\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.21 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaList />}\r\n                title=\"List Migrations\"\r\n                description=\"List all database migrations in chronological order.\"\r\n                codeExample='\"List all database migrations\"'\r\n                iconColor=\"orange\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.23 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaTerminal />}\r\n                title=\"Get Logs\"\r\n                description=\"Retrieve recent logs from the Supabase project database.\"\r\n                codeExample='\"Show me the recent logs\"'\r\n                iconColor=\"teal\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              initial={{ opacity: 0, y: 30 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.3, delay: 0.25 }}\r\n              viewport={{ once: true }}\r\n              className=\"h-full\"\r\n            >\r\n              <ToolCard\r\n                icon={<FaBook />}\r\n                title=\"Get Database Types\"\r\n                description=\"Retrieve TypeScript type definitions for the database schema.\"\r\n                codeExample='\"Get the database type definitions\"'\r\n                iconColor=\"violet\"\r\n                className=\"h-full\"\r\n              />\r\n            </motion.div>\r\n          </motion.div>\r\n        </motion.section>\r\n\r\n        {/* Tech Stack Section */}\r\n        <motion.section\r\n          id=\"tech\"\r\n          className=\"grid gap-6 py-8\"\r\n          initial={{ opacity: 0, y: 50 }}\r\n          whileInView={{ opacity: 1, y: 0 }}\r\n          transition={{ duration: 0.4 }}\r\n          viewport={{ once: true }}\r\n        >\r\n          <SectionHeader>Technology Stack</SectionHeader>\r\n          <motion.div\r\n            className=\"grid gap-8 md:grid-cols-2\"\r\n            initial={{ opacity: 0 }}\r\n            whileInView={{ opacity: 1 }}\r\n            transition={{ duration: 0.4, delay: 0.1 }}\r\n            viewport={{ once: true }}\r\n          >\r\n            <motion.div\r\n              className=\"h-full rounded-xl border border-slate-700 bg-slate-800 p-6 shadow-sm\"\r\n              initial={{ opacity: 0, x: -30 }}\r\n              whileInView={{ opacity: 1, x: 0 }}\r\n              transition={{ duration: 0.4, delay: 0.05 }}\r\n              viewport={{ once: true }}\r\n            >\r\n              <h3 className=\"mb-4 text-xl font-semibold text-white\">\r\n                Backend & Infrastructure\r\n              </h3>\r\n              <ul className=\"space-y-2 text-slate-400\">\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-blue-500\"></span>\r\n                  Next.js 16 with App Router\r\n                </li>\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-blue-500\"></span>\r\n                  TypeScript for type safety\r\n                </li>\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-blue-500\"></span>\r\n                  Supabase PostgreSQL database\r\n                </li>\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-blue-500\"></span>\r\n                  Supabase Storage for assets\r\n                </li>\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-blue-500\"></span>\r\n                  MCP (Model Context Protocol)\r\n                </li>\r\n              </ul>\r\n            </motion.div>\r\n\r\n            <motion.div\r\n              className=\"h-full rounded-xl border border-slate-700 bg-slate-800 p-6 shadow-sm\"\r\n              initial={{ opacity: 0, x: 30 }}\r\n              whileInView={{ opacity: 1, x: 0 }}\r\n              transition={{ duration: 0.4, delay: 0.1 }}\r\n              viewport={{ once: true }}\r\n            >\r\n              <h3 className=\"mb-4 text-xl font-semibold text-white\">\r\n                Scraping & Processing\r\n              </h3>\r\n              <ul className=\"space-y-2 text-slate-400\">\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-green-500\"></span>\r\n                  Puppeteer for web scraping\r\n                </li>\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-green-500\"></span>\r\n                  Intelligent link discovery\r\n                </li>\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-green-500\"></span>\r\n                  Bulk database operations\r\n                </li>\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-green-500\"></span>\r\n                  Progress tracking & logging\r\n                </li>\r\n                <li className=\"flex items-center\">\r\n                  <span className=\"mr-3 h-2 w-2 rounded-full bg-green-500\"></span>\r\n                  Image processing & storage\r\n                </li>\r\n              </ul>\r\n            </motion.div>\r\n          </motion.div>\r\n        </motion.section>\r\n\r\n        {/* Legal Compliance Section */}\r\n        <motion.section\r\n          id=\"legal\"\r\n          className=\"grid gap-6 py-8\"\r\n          initial={{ opacity: 0, y: 50 }}\r\n          whileInView={{ opacity: 1, y: 0 }}\r\n          transition={{ duration: 0.4 }}\r\n          viewport={{ once: true }}\r\n        >\r\n          <SectionHeader>Terms & Conditions</SectionHeader>\r\n          <motion.div\r\n            className=\"space-y-4 rounded-xl border border-slate-700 bg-slate-800/50 p-8 text-slate-300\"\r\n            initial={{ opacity: 0, scale: 0.95 }}\r\n            whileInView={{ opacity: 1, scale: 1 }}\r\n            transition={{ duration: 0.4, delay: 0.1 }}\r\n            viewport={{ once: true }}\r\n          >\r\n            <p>\r\n              This Zeroheight MCP Server operates in full compliance with\r\n              applicable laws and regulations. All data scraping and processing\r\n              activities respect user privacy and data protection requirements.\r\n            </p>\r\n            <p>\r\n              Zeroheight&apos;s{\" \"}\r\n              <a\r\n                href=\"https://terms.zeroheight.com/\"\r\n                target=\"_blank\"\r\n                rel=\"noopener noreferrer\"\r\n                className=\"text-cyan-400 underline hover:text-cyan-300\"\r\n              >\r\n                Terms of Service\r\n              </a>{\" \"}\r\n              do not prohibit scraping of projects where you maintain proper\r\n              authentication and access permissions. This tool operates solely\r\n              within the bounds of authorized access that you already possess.\r\n            </p>\r\n            <motion.div\r\n              className=\"grid gap-4 md:grid-cols-2\"\r\n              initial={{ opacity: 0 }}\r\n              whileInView={{ opacity: 1 }}\r\n              transition={{ duration: 0.4, delay: 0.2 }}\r\n              viewport={{ once: true }}\r\n            >\r\n              <motion.div\r\n                className=\"rounded-lg bg-slate-700/50 p-4\"\r\n                initial={{ opacity: 0, y: 20 }}\r\n                whileInView={{ opacity: 1, y: 0 }}\r\n                transition={{ duration: 0.3, delay: 0.05 }}\r\n                viewport={{ once: true }}\r\n              >\r\n                <h4 className=\"mb-2 font-semibold text-white flex items-center gap-2\">\r\n                  <FaCheck className=\"text-green-400\" />\r\n                  Authorized Access Only\r\n                </h4>\r\n                <p className=\"text-sm\">\r\n                  All operations require valid authentication and respect\r\n                  existing access permissions.\r\n                </p>\r\n              </motion.div>\r\n              <motion.div\r\n                className=\"rounded-lg bg-slate-700/50 p-4\"\r\n                initial={{ opacity: 0, y: 20 }}\r\n                whileInView={{ opacity: 1, y: 0 }}\r\n                transition={{ duration: 0.3, delay: 0.1 }}\r\n                viewport={{ once: true }}\r\n              >\r\n                <h4 className=\"mb-2 font-semibold text-white flex items-center gap-2\">\r\n                  <FaCheck className=\"text-green-400\" />\r\n                  Data Privacy\r\n                </h4>\r\n                <p className=\"text-sm\">\r\n                  No personal data collection or unauthorized data sharing\r\n                  occurs.\r\n                </p>\r\n              </motion.div>\r\n              <motion.div\r\n                className=\"rounded-lg bg-slate-700/50 p-4\"\r\n                initial={{ opacity: 0, y: 20 }}\r\n                whileInView={{ opacity: 1, y: 0 }}\r\n                transition={{ duration: 0.3, delay: 0.15 }}\r\n                viewport={{ once: true }}\r\n              >\r\n                <h4 className=\"mb-2 font-semibold text-white flex items-center gap-2\">\r\n                  <FaCheck className=\"text-green-400\" />\r\n                  Rate Limiting\r\n                </h4>\r\n                <p className=\"text-sm\">\r\n                  Built-in rate limiting prevents excessive API calls and server\r\n                  strain.\r\n                </p>\r\n              </motion.div>\r\n              <motion.div\r\n                className=\"rounded-lg bg-slate-700/50 p-4\"\r\n                initial={{ opacity: 0, y: 20 }}\r\n                whileInView={{ opacity: 1, y: 0 }}\r\n                transition={{ duration: 0.3, delay: 0.2 }}\r\n                viewport={{ once: true }}\r\n              >\r\n                <h4 className=\"mb-2 font-semibold text-white flex items-center gap-2\">\r\n                  <FaCheck className=\"text-green-400\" />\r\n                  Audit Trail\r\n                </h4>\r\n                <p className=\"text-sm\">\r\n                  All operations are logged for transparency and debugging\r\n                  purposes.\r\n                </p>\r\n              </motion.div>\r\n            </motion.div>\r\n          </motion.div>\r\n        </motion.section>\r\n\r\n        {/* CTA Section */}\r\n\r\n        <motion.section\r\n          className=\"py-8\"\r\n          initial={{ opacity: 0, y: 50 }}\r\n          whileInView={{ opacity: 1, y: 0 }}\r\n          transition={{ duration: 0.4 }}\r\n          viewport={{ once: true }}\r\n        >\r\n          <motion.div\r\n            className=\"rounded-xl border border-slate-700 bg-slate-800 p-8 text-center shadow-sm\"\r\n            whileHover={{ scale: 1.02 }}\r\n            transition={{ duration: 0.3 }}\r\n          >\r\n            <motion.h2\r\n              className=\"mb-4 text-2xl font-bold text-white\"\r\n              initial={{ opacity: 0 }}\r\n              whileInView={{ opacity: 1 }}\r\n              transition={{ duration: 0.4, delay: 0.1 }}\r\n              viewport={{ once: true }}\r\n            >\r\n              Ready to enhance your design system workflow?\r\n            </motion.h2>\r\n            <motion.p\r\n              className=\"mx-auto mb-6 max-w-2xl text-slate-400\"\r\n              initial={{ opacity: 0 }}\r\n              whileInView={{ opacity: 1 }}\r\n              transition={{ duration: 0.4, delay: 0.2 }}\r\n              viewport={{ once: true }}\r\n            >\r\n              Integrate Zeroheight MCP Server into your development pipeline and\r\n              give your team programmatic access to design system documentation,\r\n              components, and guidelines.\r\n            </motion.p>\r\n            <motion.div\r\n              className=\"flex flex-col justify-center gap-4 sm:flex-row\"\r\n              initial={{ opacity: 0, y: 20 }}\r\n              whileInView={{ opacity: 1, y: 0 }}\r\n              transition={{ duration: 0.4, delay: 0.3 }}\r\n              viewport={{ once: true }}\r\n            >\r\n              <motion.div\r\n                whileHover={{ scale: 1.05 }}\r\n                whileTap={{ scale: 0.95 }}\r\n              >\r\n                <Link\r\n                  href=\"/api/mcp\"\r\n                  className=\"rounded-lg bg-blue-600 px-8 py-3 font-medium text-white transition-colors hover:bg-blue-700 flex items-center\"\r\n                >\r\n                  Try the API\r\n                </Link>\r\n              </motion.div>\r\n              <motion.div\r\n                whileHover={{ scale: 1.05 }}\r\n                whileTap={{ scale: 0.95 }}\r\n              >\r\n                <a\r\n                  href=\"https://modelcontextprotocol.io\"\r\n                  target=\"_blank\"\r\n                  rel=\"noopener noreferrer\"\r\n                  className=\"rounded-lg border border-slate-600 px-8 py-3 font-medium text-slate-300 transition-colors hover:border-slate-500 flex items-center\"\r\n                >\r\n                  Learn about MCP\r\n                </a>\r\n              </motion.div>\r\n            </motion.div>\r\n          </motion.div>\r\n        </motion.section>\r\n      </main>\r\n\r\n      {/* Back to Top Button */}\r\n      <motion.button\r\n        className=\"fixed bottom-8 right-8 z-40 rounded-full bg-cyan-600 p-3 text-white shadow-lg transition-colors hover:bg-cyan-700\"\r\n        onClick={() => window.scrollTo({ top: 0, behavior: \"smooth\" })}\r\n        initial={{ opacity: 0, scale: 0 }}\r\n        animate={{\r\n          opacity: scrollProgress > 20 ? 1 : 0,\r\n          scale: scrollProgress > 20 ? 1 : 0,\r\n        }}\r\n        transition={{ duration: 0.3 }}\r\n        whileHover={{ scale: 1.1 }}\r\n        whileTap={{ scale: 0.9 }}\r\n      >\r\n        <FaArrowRight className=\"h-5 w-5 rotate-[-90deg]\" />\r\n      </motion.button>\r\n\r\n      {/* Footer */}\r\n      <footer className=\"px-8 py-4 border-t border-slate-700/50\">\r\n        <p className=\"text-slate-300 text-center\">\r\n          ¬© Zeroheight MCP {new Date().getFullYear()}\r\n        </p>\r\n      </footer>\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\database.schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\database.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\database\\clear-all-data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\database\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\database\\query-data.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":32,"column":34,"nodeType":"ArrowFunctionExpression","messageId":"missingReturnType","endLine":32,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from \"zod\";\r\nimport { createErrorResponse } from \"@/utils/toolResponses\";\r\nimport { getClient } from \"@/utils/common/supabaseClients\";\r\nimport {\r\n  IMAGE_BUCKET,\r\n  NEXT_PUBLIC_SUPABASE_URL,\r\n  SCRAPER_QUERY_DEFAULT_LIMIT,\r\n} from \"@/utils/config\";\r\nimport { PageData } from \"@/tools/scraper/utils/shared\";\r\nimport type { ToolDefinition } from \"@/tools/toolTypes\";\r\nimport type { QueryDataResult } from \"./types\";\r\n\r\nconst queryDataInput = z.object({\r\n  search: z\r\n    .string()\r\n    .optional()\r\n    .describe(\"Search term to find in page titles or content\"),\r\n  url: z.string().optional().describe(\"Specific page URL to retrieve\"),\r\n  includeImages: z\r\n    .boolean()\r\n    .optional()\r\n    .default(true)\r\n    .describe(\"Whether to include image data in the response\"),\r\n  limit: z\r\n    .number()\r\n    .optional()\r\n    .default(SCRAPER_QUERY_DEFAULT_LIMIT)\r\n    .describe(\"Maximum number of results to return\"),\r\n});\r\n\r\n// Get the Supabase project URL for constructing storage URLs\r\nconst getSupabaseProjectUrl = () => {\r\n  const supabaseUrl = NEXT_PUBLIC_SUPABASE_URL;\r\n  if (!supabaseUrl) {\r\n    console.warn(\"NEXT_PUBLIC_SUPABASE_URL not found, using fallback\");\r\n    return \"https://qyoexslrsblaphbcvjdk.supabase.co\";\r\n  }\r\n  return supabaseUrl;\r\n};\r\n\r\nexport const queryDataTool: ToolDefinition<\r\n  typeof queryDataInput,\r\n  QueryDataResult | ReturnType<typeof createErrorResponse>\r\n> = {\r\n  title: \"DATABASE_query-data\",\r\n  description:\r\n    \"Query the cached Zeroheight data from the database. Supports searching by title, content, or URL, and can include image data with full Supabase storage URLs.\",\r\n  inputSchema: queryDataInput,\r\n  outputSchema: z.object({\r\n    pages: z.array(\r\n      z.object({\r\n        url: z.string().nullable(),\r\n        title: z.string().nullable(),\r\n        content: z.string().nullable(),\r\n        images: z.record(z.string(), z.string()),\r\n      }),\r\n    ),\r\n  }),\r\n  handler: async ({\r\n    search,\r\n    url,\r\n    includeImages,\r\n    limit,\r\n  }: z.infer<typeof queryDataInput>) => {\r\n    const { client: supabase } = getClient();\r\n    if (!supabase) {\r\n      return createErrorResponse({\r\n        message: \"Error: Supabase client not configured\",\r\n      });\r\n    }\r\n\r\n    // Set defaults\r\n    const effectiveIncludeImages = includeImages ?? true;\r\n    const effectiveLimit = limit ?? SCRAPER_QUERY_DEFAULT_LIMIT;\r\n\r\n    let pages: PageData[] = [];\r\n\r\n    const pagesTable = \"pages\";\r\n\r\n    if (search) {\r\n      // Use separate queries to avoid complex OR conditions that can cause parsing issues\r\n      const titleQuery = supabase\r\n        .from(pagesTable)\r\n        .select(\"id, title, url, content, images (original_url, storage_path)\")\r\n        .ilike(\"title\", `%${search}%`);\r\n      const contentQuery = supabase\r\n        .from(pagesTable)\r\n        .select(\"id, title, url, content, images (original_url, storage_path)\")\r\n        .ilike(\"content\", `%${search}%`);\r\n\r\n      const [titleResult, contentResult] = await Promise.all([\r\n        titleQuery,\r\n        contentQuery,\r\n      ]);\r\n\r\n      if (titleResult.error) {\r\n        console.error(\"Error querying titles:\", titleResult.error);\r\n        return createErrorResponse({\r\n          message: \"Error querying data: \" + titleResult.error.message,\r\n        });\r\n      }\r\n      if (contentResult.error) {\r\n        console.error(\"Error querying content:\", contentResult.error);\r\n        return createErrorResponse({\r\n          message: \"Error querying data: \" + contentResult.error.message,\r\n        });\r\n      }\r\n\r\n      // Combine and deduplicate results\r\n      const allPages = [\r\n        ...(titleResult.data || []),\r\n        ...(contentResult.data || []),\r\n      ];\r\n      pages = allPages.filter(\r\n        (page, index, self) =>\r\n          index === self.findIndex((p) => p.id === page.id),\r\n      );\r\n    } else if (url) {\r\n      // Query by URL\r\n      const { data: urlPages, error: urlError } = await supabase\r\n        .from(pagesTable)\r\n        .select(\"id, title, url, content, images (original_url, storage_path)\")\r\n        .eq(\"url\", url)\r\n        .limit(effectiveLimit);\r\n\r\n      if (urlError) {\r\n        console.error(\"Error querying by URL:\", urlError);\r\n        return createErrorResponse({\r\n          message: \"Error querying data: \" + urlError.message,\r\n        });\r\n      }\r\n\r\n      pages = urlPages || [];\r\n    } else {\r\n      // Get all pages with limit\r\n      const { data: allPages, error: allError } = await supabase\r\n        .from(pagesTable)\r\n        .select(\"id, title, url, content, images (original_url, storage_path)\")\r\n        .limit(effectiveLimit);\r\n\r\n      if (allError) {\r\n        console.error(\"Error querying all pages:\", allError);\r\n        return createErrorResponse({\r\n          message: \"Error querying data: \" + allError.message,\r\n        });\r\n      }\r\n\r\n      pages = allPages || [];\r\n    }\r\n\r\n    const result = pages.map((page) => {\r\n      const supabaseUrl = getSupabaseProjectUrl();\r\n      return {\r\n        url: page.url,\r\n        title: page.title,\r\n        content: page.content,\r\n        images:\r\n          effectiveIncludeImages && page.images\r\n            ? Object.fromEntries(\r\n                page.images.map((img) => [\r\n                  img.original_url,\r\n                  `${supabaseUrl}/storage/v1/object/public/${IMAGE_BUCKET}/${img.storage_path}`,\r\n                ]),\r\n              )\r\n            : {},\r\n      };\r\n    });\r\n\r\n    // Return a domain-shaped result so callers can rely on typed output.\r\n    const out: QueryDataResult = { pages: result };\r\n    return out;\r\n  },\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\database\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\development\\getDatabaseSchema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\development\\getDatabaseTypes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\development\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\scrape.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":53,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":53,"endColumn":29},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":53,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":53,"endColumn":29},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":117,"column":5,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":117,"endColumn":34},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":126,"column":5,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":126,"endColumn":26},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":549,"column":35,"nodeType":"ArrowFunctionExpression","messageId":"missingReturnType","endLine":549,"endColumn":37},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":572,"column":37,"nodeType":"ArrowFunctionExpression","messageId":"missingReturnType","endLine":572,"endColumn":39},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":698,"column":40,"nodeType":"ArrowFunctionExpression","messageId":"missingReturnType","endLine":698,"endColumn":42}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from \"zod\";\r\nimport type { Page } from \"puppeteer\";\r\nimport { launchBrowser, attachDefaultInterception } from \"./utils/puppeteer\";\r\nimport { createErrorResponse } from \"@/utils/toolResponses\";\r\nimport { JobCancelled } from \"@/utils/common/errors\";\r\nimport {\r\n  getClient,\r\n  checkProgressInvariant,\r\n} from \"@/utils/common/supabaseClients\";\r\nimport { createProgressHelpers } from \"./utils/shared\";\r\nimport type { PagesType, ImagesType } from \"@/database.types\";\r\nimport type { OverallProgress } from \"./utils/processPageAndImages\";\r\nimport { extractPageData } from \"./utils/pageExtraction\";\r\nimport type { ExtractedImage } from \"./utils/pageExtraction\";\r\nimport { processPageAndImages } from \"./utils/processPageAndImages\";\r\nimport prefetchSeeds, { normalizeUrl } from \"./utils/prefetch\";\r\nimport { SCRAPER_DEBUG } from \"@/utils/config\";\r\nimport {\r\n  SCRAPER_CONCURRENCY,\r\n  SCRAPER_IDLE_TIMEOUT_MS,\r\n  SCRAPER_SEED_PREFETCH_CONCURRENCY,\r\n  ZEROHEIGHT_PROJECT_URL,\r\n} from \"@/utils/config\";\r\nimport {\r\n  SCRAPER_VIEWPORT_WIDTH,\r\n  SCRAPER_VIEWPORT_HEIGHT,\r\n  SCRAPER_NAV_WAITUNTIL,\r\n  SCRAPER_NAV_TIMEOUT_MS,\r\n  SCRAPER_MONITOR_POLL_MS,\r\n  SCRAPER_MONITOR_IDLE_POLL_MS,\r\n} from \"@/utils/config\";\r\nimport {\r\n  bulkUpsertPagesAndImages,\r\n  formatSummaryBox,\r\n  SummaryParams,\r\n} from \"./utils/bulkUpsert\";\r\nimport {\r\n  createJobInDb,\r\n  appendJobLog,\r\n  finishJob,\r\n  getJobFromDb,\r\n} from \"../tasks/utils/jobStore\";\r\nimport { mapStatusToSep, SERVER_SUGGESTED_TTL_MS } from \"../tasks/utils\";\r\nimport { tryLogin } from \"@/utils/common/scraperHelpers\";\r\nimport type { TasksGetResult } from \"../tasks/types\";\r\n\r\nexport type ScrapeResult = {\r\n  debug?: { seedUrl: string };\r\n  progress: OverallProgress;\r\n};\r\n\r\n// Primary scraper (previously V2) - coordinator-based queue, deterministic totals, parallel workers\r\nexport async function scrape({\r\n  rootUrl,\r\n  password,\r\n  pageUrls,\r\n  logger,\r\n  shouldCancel,\r\n}: {\r\n  rootUrl: string;\r\n  password?: string;\r\n  pageUrls?: string[];\r\n  logger?: (s: string) => void;\r\n  shouldCancel?: () => boolean | Promise<boolean>;\r\n}) {\r\n  try {\r\n    const concurrency = SCRAPER_CONCURRENCY;\r\n    const idleTimeout = SCRAPER_IDLE_TIMEOUT_MS;\r\n    const browser = await launchBrowser();\r\n    const queue: string[] = [];\r\n    const inQueue = new Set<string>();\r\n    const processed = new Set<string>();\r\n    const redirects = new Map<string, string>();\r\n    let inProgressCount = 0;\r\n    let lastActivity = Date.now();\r\n\r\n    const progress: OverallProgress = {\r\n      current: 0,\r\n      total: 0,\r\n      pagesProcessed: 0,\r\n      imagesProcessed: 0,\r\n    };\r\n\r\n    // Collectors for bulk upsert\r\n    const pagesToUpsert: Array<Pick<PagesType, \"url\" | \"title\" | \"content\">> =\r\n      [];\r\n    const pendingImageRecords: Array<{\r\n      pageUrl: string;\r\n      original_url: ImagesType[\"original_url\"];\r\n      storage_path: ImagesType[\"storage_path\"];\r\n    }> = [];\r\n    const imagesStats = { processed: 0, uploaded: 0, skipped: 0, failed: 0 };\r\n    let pagesFailed = 0;\r\n    const uniqueAllImageUrls = new Set<string>();\r\n    const uniqueUnsupportedImageUrls = new Set<string>();\r\n    const uniqueAllowedImageUrls = new Set<string>();\r\n\r\n    const processedPages: Array<{\r\n      url: PagesType[\"url\"];\r\n      title: PagesType[\"title\"];\r\n      content: PagesType[\"content\"];\r\n      images: Array<{ src: string; alt: string }>;\r\n    }> = [];\r\n\r\n    type PreExtracted = {\r\n      title: string;\r\n      content: string;\r\n      supportedImages: ExtractedImage[];\r\n      normalizedImages: Array<{ src: string; alt: string }>;\r\n      pageLinks: string[];\r\n    };\r\n\r\n    const preExtractedMap: Map<string, PreExtracted> = new Map();\r\n\r\n    const waiters: Array<(val: string | null) => void> = [];\r\n\r\n    function formatLinkForConsole(u: string) {\r\n      try {\r\n        const parsed = new URL(u);\r\n        return `${parsed.pathname}${parsed.search}` || \"/\";\r\n      } catch {\r\n        return u;\r\n      }\r\n    }\r\n\r\n    function enqueueLinks(links: string[]) {\r\n      const added: string[] = [];\r\n      for (const l of links) {\r\n        const effective = redirects.get(l) ?? l;\r\n        if (!processed.has(effective) && !inQueue.has(effective)) {\r\n          inQueue.add(effective);\r\n          queue.push(effective);\r\n          added.push(effective);\r\n        }\r\n      }\r\n      if (added.length) {\r\n        progress.total += added.length;\r\n        lastActivity = Date.now();\r\n        while (waiters.length && queue.length) {\r\n          const w = waiters.shift()!;\r\n          const item = queue.shift()!;\r\n          inQueue.delete(item);\r\n          inProgressCount++;\r\n          progress.current++;\r\n          w(item);\r\n        }\r\n      }\r\n    }\r\n    function getNextLink(): Promise<string | null> {\r\n      if (queue.length > 0) {\r\n        const item = queue.shift()!;\r\n        inQueue.delete(item);\r\n        inProgressCount++;\r\n        progress.current++;\r\n        return Promise.resolve(item);\r\n      }\r\n      return new Promise((res) => waiters.push(res));\r\n    }\r\n    const { logProgress } = createProgressHelpers({\r\n      progress,\r\n      checkProgressInvariant,\r\n      logger,\r\n    });\r\n\r\n    const restrictToSeeds = !!(pageUrls && pageUrls.length > 0);\r\n\r\n    const { client: db } = getClient();\r\n    const imagesTable = \"images\";\r\n    const loggedInHostnames = new Set<string>();\r\n    let allExistingImageUrls = new Set<string>();\r\n    try {\r\n      const { data: allExistingImages } = await db!\r\n        .from(imagesTable)\r\n        .select(\"original_url\");\r\n      allExistingImageUrls = new Set(\r\n        (allExistingImages || []).map((img: Record<string, unknown>) => {\r\n          let normalizedUrl = \"\";\r\n          const original = img[\"original_url\"];\r\n          if (typeof original === \"string\") normalizedUrl = original;\r\n          try {\r\n            const u = new URL(normalizedUrl);\r\n            normalizedUrl = `${u.protocol}//${u.hostname}${u.pathname}`;\r\n          } catch (e) {\r\n            console.debug(\"normalize URL failed:\", e);\r\n          }\r\n          return normalizedUrl;\r\n        }),\r\n      );\r\n      if (logger)\r\n        logger(\r\n          `Found ${allExistingImageUrls.size} existing images in database`,\r\n        );\r\n    } catch (e) {\r\n      if (logger) logger(`Failed to load existing images: ${String(e)}`);\r\n      allExistingImageUrls = new Set<string>();\r\n    }\r\n\r\n    if (pageUrls && pageUrls.length > 0) {\r\n      const normalized = pageUrls.map((p) =>\r\n        normalizeUrl({ u: p, base: rootUrl }),\r\n      );\r\n      const { preExtractedMap: seedMap } = await prefetchSeeds({\r\n        browser,\r\n        rootUrl,\r\n        seeds: normalized,\r\n        password,\r\n        concurrency: SCRAPER_SEED_PREFETCH_CONCURRENCY,\r\n        logger,\r\n      });\r\n\r\n      for (const [k, v] of seedMap) preExtractedMap.set(k, v as PreExtracted);\r\n\r\n      // If we provided a password and prefetchSeeds ran, assume we've logged\r\n      // into the project hostname so workers don't repeatedly try to login.\r\n      if (password) loggedInHostnames.add(new URL(rootUrl).hostname);\r\n\r\n      enqueueLinks(normalized);\r\n      logProgress(\"‚öë\", `Seeded ${normalized.length} initial links`);\r\n    } else {\r\n      const p = await browser.newPage();\r\n      await p.setViewport({\r\n        width: SCRAPER_VIEWPORT_WIDTH,\r\n        height: SCRAPER_VIEWPORT_HEIGHT,\r\n      });\r\n      // attach default interception rules (blocks fonts/styles/ext images etc.)\r\n      try {\r\n        await attachDefaultInterception(p).catch(() => {});\r\n      } catch (e) {\r\n        console.warn(\"Failed to prefetch seeds:\", e);\r\n      }\r\n      await p.goto(rootUrl, {\r\n        waitUntil: SCRAPER_NAV_WAITUNTIL,\r\n        timeout: SCRAPER_NAV_TIMEOUT_MS,\r\n      });\r\n      if (password) {\r\n        try {\r\n          await tryLogin({ page: p, password });\r\n          loggedInHostnames.add(new URL(rootUrl).hostname);\r\n          if (logger) logger(\"Login attempt complete on root page\");\r\n        } catch (e) {\r\n          if (logger) logger(`Login attempt failed: ${String(e)}`);\r\n        }\r\n      }\r\n\r\n      const hostname = new URL(rootUrl).hostname;\r\n      const fallbackRoot: {\r\n        pageLinks: string[];\r\n        normalizedImages: ExtractedImage[];\r\n        supportedImages: ExtractedImage[];\r\n        title: string;\r\n        content: string;\r\n      } = {\r\n        pageLinks: [],\r\n        normalizedImages: [],\r\n        supportedImages: [],\r\n        title: \"\",\r\n        content: \"\",\r\n      };\r\n      const extracted = await extractPageData({\r\n        page: p,\r\n        pageUrl: rootUrl,\r\n        allowedHostname: hostname,\r\n      }).catch(() => fallbackRoot);\r\n\r\n      const anchors: string[] = await p\r\n        .$$eval(\"a[href]\", (links) =>\r\n          links.map((a) => (a as HTMLAnchorElement).href).filter(Boolean),\r\n        )\r\n        .catch(() => []);\r\n\r\n      const initialSet = new Set<string>();\r\n      initialSet.add(normalizeUrl({ u: rootUrl }));\r\n      for (const a of anchors)\r\n        initialSet.add(normalizeUrl({ u: a, base: rootUrl }));\r\n      for (const a of extracted.pageLinks || [])\r\n        initialSet.add(normalizeUrl({ u: a, base: rootUrl }));\r\n      const initial = Array.from(initialSet);\r\n      if (logger) {\r\n        logger(`Seeded ${initial.length} initial links from root`);\r\n      }\r\n      enqueueLinks(initial);\r\n      try {\r\n        await p.close();\r\n      } catch (e) {\r\n        console.debug(\"Error reading image urls from DB:\", e);\r\n      }\r\n    }\r\n\r\n    const workers: Promise<void>[] = [];\r\n    for (let i = 0; i < concurrency; i++) {\r\n      workers.push(\r\n        (async () => {\r\n          const page: Page = await browser.newPage();\r\n          await page.setViewport({\r\n            width: SCRAPER_VIEWPORT_WIDTH,\r\n            height: SCRAPER_VIEWPORT_HEIGHT,\r\n          });\r\n          try {\r\n            await attachDefaultInterception(page).catch(() => {});\r\n          } catch (e) {\r\n            console.debug(\"URL parse failed while normalizing seed:\", e);\r\n          }\r\n          try {\r\n            while (true) {\r\n              if (shouldCancel && (await Promise.resolve(shouldCancel())))\r\n                throw new JobCancelled();\r\n              const link = await getNextLink();\r\n              if (!link) break;\r\n              logProgress(\"üîé\", `Starting ${formatLinkForConsole(link)}`);\r\n\r\n              try {\r\n                await page.goto(link, {\r\n                  waitUntil: SCRAPER_NAV_WAITUNTIL,\r\n                  timeout: SCRAPER_NAV_TIMEOUT_MS,\r\n                });\r\n                if (password) {\r\n                  const host = new URL(rootUrl).hostname;\r\n                  if (!loggedInHostnames.has(host)) {\r\n                    try {\r\n                      await tryLogin({ page, password });\r\n                      loggedInHostnames.add(host);\r\n                      if (logger)\r\n                        logger(\r\n                          `Login attempt complete on ${formatLinkForConsole(link)}`,\r\n                        );\r\n                    } catch (e) {\r\n                      if (logger)\r\n                        logger(\r\n                          `Login attempt failed on ${formatLinkForConsole(link)}: ${String(e)}`,\r\n                        );\r\n                    }\r\n                  }\r\n                }\r\n\r\n                const finalRaw = page.url();\r\n                const final = normalizeUrl({ u: finalRaw, base: rootUrl });\r\n                let processingLink = link;\r\n                if (final && final !== link) {\r\n                  redirects.set(link, final);\r\n                  processingLink = final;\r\n                }\r\n\r\n                const hostname = new URL(rootUrl).hostname;\r\n\r\n                // If the final (resolved) URL is on a different hostname than the\r\n                // project root, skip it. This prevents the scraper from creating\r\n                // page rows for external domains (e.g. terms.zeroheight.com).\r\n                try {\r\n                  const procHost = new URL(processingLink).hostname;\r\n                  if (procHost !== hostname) {\r\n                    if (logger)\r\n                      logger(\r\n                        `Skipping external host ${processingLink} (allowed: ${hostname})`,\r\n                      );\r\n                    // mark as processed so we don't retry it\r\n                    processed.add(processingLink);\r\n                    if (processingLink !== link) processed.add(link);\r\n                    // update activity counters and continue to next link\r\n                    progress.pagesProcessed++;\r\n                    inProgressCount = Math.max(0, inProgressCount - 1);\r\n                    lastActivity = Date.now();\r\n                    continue;\r\n                  }\r\n                } catch {\r\n                  // if URL parsing fails, fall through and let later logic handle it\r\n                }\r\n                const preExtractedLocal = preExtractedMap;\r\n                let title: string;\r\n                let content: string;\r\n                let supportedImages: ExtractedImage[];\r\n                let normalizedImages: Array<{ src: string; alt: string }>;\r\n                let pageLinks: string[];\r\n                if (\r\n                  preExtractedLocal &&\r\n                  preExtractedLocal.has(processingLink)\r\n                ) {\r\n                  const e = preExtractedLocal.get(processingLink)!;\r\n                  title = e.title;\r\n                  content = e.content;\r\n                  supportedImages = e.supportedImages || [];\r\n                  normalizedImages = e.normalizedImages || [];\r\n                  pageLinks = e.pageLinks || [];\r\n                } else {\r\n                  const fallback: {\r\n                    pageLinks: string[];\r\n                    normalizedImages: ExtractedImage[];\r\n                    supportedImages: ExtractedImage[];\r\n                    title: string;\r\n                    content: string;\r\n                  } = {\r\n                    pageLinks: [],\r\n                    normalizedImages: [],\r\n                    supportedImages: [],\r\n                    title: \"\",\r\n                    content: \"\",\r\n                  };\r\n                  const extracted = await extractPageData({\r\n                    page,\r\n                    pageUrl: processingLink,\r\n                    allowedHostname: hostname,\r\n                  }).catch(() => fallback);\r\n                  title = extracted.title;\r\n                  content = extracted.content;\r\n                  supportedImages = extracted.supportedImages || [];\r\n                  normalizedImages = extracted.normalizedImages || [];\r\n                  pageLinks = extracted.pageLinks || [];\r\n                }\r\n\r\n                if (supportedImages.length > 0) {\r\n                  progress.total += supportedImages.length;\r\n                  checkProgressInvariant({\r\n                    overallProgress: progress,\r\n                    context: \"reserve images for page-v2\",\r\n                  });\r\n                  lastActivity = Date.now();\r\n                }\r\n\r\n                const { storage } = getClient();\r\n\r\n                const {\r\n                  pageUpsert,\r\n                  processedPageEntry,\r\n                  imgStats,\r\n                  pageLinks: returnedPageLinks,\r\n                  normalizedImages: retNorm,\r\n                  supportedImages: retSupported,\r\n                } = await processPageAndImages({\r\n                  page,\r\n                  link: processingLink,\r\n                  allowedHostname: hostname,\r\n                  storage,\r\n                  overallProgress: progress,\r\n                  allExistingImageUrls,\r\n                  pendingImageRecords,\r\n                  logProgress,\r\n                  shouldCancel: undefined,\r\n                  checkProgressInvariant: (p: OverallProgress, ctx: string) =>\r\n                    checkProgressInvariant({\r\n                      overallProgress: p,\r\n                      context: ctx,\r\n                    }),\r\n                  preExtracted: {\r\n                    title,\r\n                    content,\r\n                    supportedImages,\r\n                    normalizedImages,\r\n                    pageLinks,\r\n                  },\r\n                });\r\n\r\n                const rawLinks = returnedPageLinks || pageLinks || [];\r\n                const allowed = rawLinks\r\n                  .map((h) => normalizeUrl({ u: h, base: rootUrl }))\r\n                  .filter((h) => {\r\n                    try {\r\n                      return new URL(h).hostname === hostname;\r\n                    } catch {\r\n                      return false;\r\n                    }\r\n                  });\r\n                logProgress(\r\n                  \"üîó\",\r\n                  `Discovered ${allowed.length} links on ${formatLinkForConsole(processingLink)}`,\r\n                );\r\n                if (!restrictToSeeds) enqueueLinks(allowed);\r\n\r\n                for (const img of retNorm || [])\r\n                  uniqueAllImageUrls.add(img.src);\r\n                for (const img of retNorm || []) {\r\n                  if (\r\n                    (retSupported || []).find(\r\n                      (s: { src: string }) => s.src === img.src,\r\n                    )\r\n                  )\r\n                    uniqueAllowedImageUrls.add(img.src);\r\n                  else uniqueUnsupportedImageUrls.add(img.src);\r\n                }\r\n\r\n                pagesToUpsert.push(pageUpsert);\r\n                processedPages.push(processedPageEntry);\r\n                imagesStats.processed += imgStats.processed || 0;\r\n                imagesStats.uploaded += imgStats.uploaded || 0;\r\n                imagesStats.skipped += imgStats.skipped || 0;\r\n                imagesStats.failed += imgStats.failed || 0;\r\n\r\n                progress.pagesProcessed++;\r\n                processed.add(processingLink);\r\n                if (processingLink !== link) processed.add(link);\r\n                logProgress(\r\n                  \"‚úÖ\",\r\n                  `Processed ${formatLinkForConsole(processingLink)}`,\r\n                );\r\n              } catch (e) {\r\n                pagesFailed++;\r\n                if (logger)\r\n                  logger(\r\n                    `Error processing ${formatLinkForConsole(link)}: ${String(e)}`,\r\n                  );\r\n              } finally {\r\n                inProgressCount = Math.max(0, inProgressCount - 1);\r\n                lastActivity = Date.now();\r\n              }\r\n            }\r\n          } finally {\r\n            try {\r\n              await page.close();\r\n            } catch (e) {\r\n              console.debug(\"Error in prefetch iteration:\", e);\r\n            }\r\n          }\r\n        })(),\r\n      );\r\n    }\r\n\r\n    while (true) {\r\n      if (shouldCancel && (await Promise.resolve(shouldCancel()))) {\r\n        while (waiters.length) {\r\n          const w = waiters.shift()!;\r\n          w(null);\r\n        }\r\n        throw new JobCancelled();\r\n      }\r\n\r\n      if (queue.length === 0 && inProgressCount === 0) {\r\n        await new Promise((r) =>\r\n          setTimeout(r, Math.min(SCRAPER_MONITOR_IDLE_POLL_MS, idleTimeout)),\r\n        );\r\n        if (\r\n          queue.length === 0 &&\r\n          inProgressCount === 0 &&\r\n          Date.now() - lastActivity >= idleTimeout\r\n        )\r\n          break;\r\n      }\r\n      await new Promise((r) => setTimeout(r, SCRAPER_MONITOR_POLL_MS));\r\n    }\r\n\r\n    while (waiters.length) {\r\n      const w = waiters.shift()!;\r\n      w(null);\r\n    }\r\n\r\n    await Promise.all(workers);\r\n\r\n    let bulkLines: string[] | undefined;\r\n    let printedBox = false;\r\n    try {\r\n      const { client: db } = getClient();\r\n      const printer = (s: string) => {\r\n        if (logger) logger(s);\r\n        else console.log(s);\r\n      };\r\n      const res = await bulkUpsertPagesAndImages({\r\n        db: db!,\r\n        pagesToUpsert,\r\n        pendingImageRecords,\r\n        uniqueAllowedImageUrls,\r\n        uniqueAllImageUrls,\r\n        uniqueUnsupportedImageUrls,\r\n        allExistingImageUrls,\r\n        imagesStats,\r\n        pagesFailed: pagesFailed,\r\n        providedCount: pageUrls && pageUrls.length > 0 ? pageUrls.length : 0,\r\n      });\r\n      bulkLines = res.lines;\r\n      if (bulkLines && bulkLines.length) printer(bulkLines.join(\"\\n\"));\r\n      printedBox = true;\r\n    } catch (e) {\r\n      console.warn(\"V2 bulkUpsert failed:\", e);\r\n    } finally {\r\n      if (!printedBox) {\r\n        const printer = (s: string) => {\r\n          if (logger) logger(s);\r\n          else console.log(s);\r\n        };\r\n        try {\r\n          const { client: db } = getClient();\r\n          const res = await bulkUpsertPagesAndImages({\r\n            db: db!,\r\n            pagesToUpsert,\r\n            pendingImageRecords,\r\n            uniqueAllowedImageUrls,\r\n            uniqueAllImageUrls,\r\n            uniqueUnsupportedImageUrls,\r\n            allExistingImageUrls,\r\n            imagesStats,\r\n            pagesFailed: pagesFailed,\r\n            providedCount:\r\n              pageUrls && pageUrls.length > 0 ? pageUrls.length : 0,\r\n            dryRun: true,\r\n          });\r\n          if (res.lines && res.lines.length) printer(res.lines.join(\"\\n\"));\r\n        } catch {\r\n          const uniquePageMap = new Map<\r\n            string,\r\n            (typeof pagesToUpsert)[number]\r\n          >();\r\n          for (const p of pagesToUpsert) uniquePageMap.set(p.url, p);\r\n          const totalUniquePages = uniquePageMap.size;\r\n          const providedCountVal =\r\n            pageUrls && pageUrls.length > 0 ? pageUrls.length : 0;\r\n          const insertedCountVal = totalUniquePages;\r\n          const updatedCountVal = 0;\r\n          const skippedCountVal =\r\n            providedCountVal > 0\r\n              ? Math.max(0, providedCountVal - totalUniquePages)\r\n              : 0;\r\n\r\n          const params: SummaryParams = {\r\n            providedCount: providedCountVal,\r\n            pagesAnalyzed:\r\n              providedCountVal > 0 ? providedCountVal : totalUniquePages,\r\n            insertedCount: insertedCountVal,\r\n            updatedCount: updatedCountVal,\r\n            skippedCount: skippedCountVal,\r\n            pagesFailed: pagesFailed,\r\n            uniqueTotalImages: uniqueAllImageUrls.size,\r\n            uniqueUnsupported: uniqueUnsupportedImageUrls.size,\r\n            uniqueAllowed: uniqueAllowedImageUrls.size,\r\n            imagesUploadedCount: imagesStats.uploaded,\r\n            uniqueSkipped: Array.from(uniqueAllowedImageUrls).filter((u) =>\r\n              allExistingImageUrls.has(u),\r\n            ).length,\r\n            imagesFailed: imagesStats.failed,\r\n            imagesDbInsertedCount: pendingImageRecords.length,\r\n            imagesAlreadyAssociatedCount: Array.from(\r\n              uniqueAllowedImageUrls,\r\n            ).filter((u) => allExistingImageUrls.has(u)).length,\r\n          };\r\n          const boxed = formatSummaryBox({ p: params });\r\n          if (boxed && boxed.length) printer(boxed.join(\"\\n\"));\r\n        }\r\n      }\r\n    }\r\n\r\n    await browser.close();\r\n\r\n    const result: ScrapeResult = { debug: { seedUrl: rootUrl }, progress };\r\n    return result;\r\n  } catch (err) {\r\n    if (err instanceof JobCancelled)\r\n      return { message: \"Job cancelled\" } as unknown;\r\n    return createErrorResponse({\r\n      message: String(err instanceof Error ? err.message : err),\r\n    });\r\n  }\r\n}\r\n\r\nimport type { ToolDefinition } from \"@/tools/toolTypes\";\r\nimport type { ToolResponse } from \"@/utils/toolResponses\";\r\nimport { isRecord, getProp } from \"../../utils/common/typeGuards\";\r\n\r\nconst scrapeInput = z.object({\r\n  pageUrls: z.array(z.string()).optional(),\r\n  password: z.string().optional(),\r\n});\r\n\r\nexport const scrapeTool: ToolDefinition<\r\n  typeof scrapeInput,\r\n  ToolResponse | ScrapeResult | TasksGetResult | { message: string }\r\n> = {\r\n  title: \"SCRAPER_scrape\",\r\n  description:\r\n    \"Start an asynchronous scraping job for the configured Zeroheight project. Seeds from the project root or provided page URLs; extracts pages and records page content and remote image URLs to the database as a background job.\",\r\n  inputSchema: scrapeInput,\r\n  outputSchema: z.object({\r\n    task: z.object({\r\n      taskId: z.string(),\r\n      status: z.string(),\r\n      statusMessage: z.string().nullable().optional(),\r\n      createdAt: z.string().nullable().optional(),\r\n      lastUpdatedAt: z.string().nullable().optional(),\r\n      ttl: z.number().optional(),\r\n      pollInterval: z.number().optional(),\r\n    }),\r\n  }),\r\n  handler: async ({ pageUrls, password }: z.infer<typeof scrapeInput>) => {\r\n    const projectUrl = ZEROHEIGHT_PROJECT_URL;\r\n    if (!projectUrl)\r\n      return createErrorResponse({ message: \"ZEROHEIGHT_PROJECT_URL not set\" });\r\n\r\n    let jobId: string;\r\n    try {\r\n      const created = await createJobInDb({\r\n        name: \"scrape\",\r\n        args: { pageUrls: pageUrls || null },\r\n      });\r\n      if (created) jobId = created;\r\n      else\r\n        jobId =\r\n          Date.now().toString(36) + Math.random().toString(36).slice(2, 8);\r\n    } catch (err) {\r\n      console.warn(\"createJobInDb failed:\", err);\r\n      jobId = Date.now().toString(36) + Math.random().toString(36).slice(2, 8);\r\n    }\r\n\r\n    (async () => {\r\n      const logger = async (s: string) => {\r\n        try {\r\n          await appendJobLog({\r\n            jobId,\r\n            line: `[${new Date().toISOString()}] ${s}`,\r\n          });\r\n        } catch (e) {\r\n          console.debug(\"Error during some scrape step:\", e);\r\n        }\r\n        if (SCRAPER_DEBUG) console.log(`[debug] ${s}`);\r\n        else console.log(s);\r\n      };\r\n\r\n      try {\r\n        const res = await scrape({\r\n          rootUrl: projectUrl,\r\n          password,\r\n          pageUrls: pageUrls || undefined,\r\n          logger: (msg: string) => {\r\n            void logger(msg);\r\n          },\r\n          shouldCancel: async () => {\r\n            try {\r\n              const j = await getJobFromDb({ jobId });\r\n              return !!(\r\n                j &&\r\n                (j.status === \"cancelled\" || j.status === \"failed\")\r\n              );\r\n            } catch {\r\n              return false;\r\n            }\r\n          },\r\n        });\r\n        let structuredResult: unknown = res;\r\n        if (\r\n          isRecord(res) &&\r\n          Object.prototype.hasOwnProperty.call(res, \"progress\")\r\n        ) {\r\n          const p = getProp(res, \"progress\");\r\n          structuredResult = p ?? res;\r\n        }\r\n        await finishJob({ jobId, success: true, result: structuredResult });\r\n      } catch (e) {\r\n        const errMsg = e instanceof Error ? e.message : String(e);\r\n        if (e instanceof JobCancelled) {\r\n          await appendJobLog({ jobId, line: \"Job cancelled by request\" });\r\n          await finishJob({ jobId, success: false });\r\n        } else {\r\n          await appendJobLog({ jobId, line: `Error: ${errMsg}` });\r\n          await finishJob({\r\n            jobId,\r\n            success: false,\r\n            result: undefined,\r\n            errorMsg: errMsg,\r\n          });\r\n        }\r\n      }\r\n    })();\r\n\r\n    const startedAt = new Date().toISOString();\r\n    const taskResponse = {\r\n      task: {\r\n        taskId: jobId,\r\n        status: mapStatusToSep({ status: \"working\" }),\r\n        statusMessage: \"Scraping is now in progress.\",\r\n        createdAt: startedAt,\r\n        lastUpdatedAt: null,\r\n        ttl: SERVER_SUGGESTED_TTL_MS,\r\n        pollInterval: 5000,\r\n      },\r\n    };\r\n    // Return the structured `task` object directly; MCP registration will\r\n    // normalize this domain-shaped result into a `ToolResponse` for JSON-RPC\r\n    // consumers.\r\n    const out: TasksGetResult = taskResponse;\r\n    return out;\r\n  },\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\bulkUpsert.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\concurrency.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":11,"column":3,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":11,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { SCRAPER_DEFAULT_CONCURRENCY } from \"@/utils/config\";\r\n\r\nexport async function mapWithConcurrency<T, R>(\r\n  items: T[],\r\n  mapper: (item: T, index: number) => Promise<R>,\r\n  concurrency = SCRAPER_DEFAULT_CONCURRENCY,\r\n): Promise<R[]> {\r\n  const results: R[] = new Array(items.length);\r\n  let nextIndex = 0;\r\n\r\n  async function worker() {\r\n    while (true) {\r\n      const idx = nextIndex;\r\n      if (idx >= items.length) return;\r\n      nextIndex++;\r\n      results[idx] = await mapper(items[idx], idx);\r\n    }\r\n  }\r\n\r\n  const workers = Array.from(\r\n    { length: Math.min(concurrency, items.length) },\r\n    () => worker(),\r\n  );\r\n  await Promise.all(workers);\r\n  return results;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\imageHelpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\imagePipeline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\pageExtraction.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\pageProcessors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\pendingRecords.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\prefetch.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":20,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":20,"endColumn":29},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":20,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":20,"endColumn":29},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":42,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":42,"endColumn":36},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":42,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":42,"endColumn":36}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Browser, Page as PuppeteerPage } from \"puppeteer\";\r\nimport { isRecord } from \"@/utils/common/typeGuards\";\r\nimport { extractPageData } from \"./pageExtraction\";\r\nimport { tryLogin } from \"@/utils/common/scraperHelpers\";\r\nimport { mapWithConcurrency } from \"./concurrency\";\r\nimport {\r\n  SCRAPER_SEED_PREFETCH_CONCURRENCY,\r\n  SCRAPER_PREFETCH_WAIT_MS,\r\n  SCRAPER_PREFETCH_SCROLL_STEP_MS,\r\n  SCRAPER_PREFETCH_FINAL_WAIT_MS,\r\n  SCRAPER_PREFETCH_SCROLL_STEP_PX,\r\n  SCRAPER_VIEWPORT_WIDTH,\r\n  SCRAPER_VIEWPORT_HEIGHT,\r\n  SCRAPER_NAV_WAITUNTIL,\r\n  SCRAPER_NAV_TIMEOUT_MS,\r\n  SCRAPER_MAX_ATTEMPTS,\r\n  SCRAPER_RETRY_BASE_MS,\r\n} from \"@/utils/config\";\r\n\r\nexport function normalizeUrl({ u, base }: { u: string; base?: string }) {\r\n  try {\r\n    const parsed = new URL(u, base || undefined);\r\n    parsed.hash = \"\";\r\n    const path =\r\n      parsed.pathname.endsWith(\"/\") && parsed.pathname !== \"/\"\r\n        ? parsed.pathname.slice(0, -1)\r\n        : parsed.pathname;\r\n    return `${parsed.protocol}//${parsed.hostname}${path}${parsed.search}`;\r\n  } catch {\r\n    return u;\r\n  }\r\n}\r\n\r\nexport type PreExtracted = {\r\n  title: string;\r\n  content: string;\r\n  supportedImages: Array<{ src: string; alt: string }>;\r\n  normalizedImages: Array<{ src: string; alt: string }>;\r\n  pageLinks: string[];\r\n};\r\n\r\nexport async function prefetchSeeds(options: {\r\n  browser: Browser;\r\n  rootUrl: string;\r\n  seeds: string[];\r\n  password?: string;\r\n  concurrency?: number;\r\n  logger?: (s: string) => void;\r\n}) {\r\n  const { browser, rootUrl, seeds, password, concurrency, logger } = options;\r\n  const hostname = new URL(rootUrl).hostname;\r\n  const normSeeds = seeds.map((s) => normalizeUrl({ u: s, base: rootUrl }));\r\n  const preExtractedMap = new Map<string, PreExtracted>();\r\n\r\n  // If a password is provided, attempt a root login once and reuse cookies.\r\n  let cookies: Array<Parameters<PuppeteerPage[\"setCookie\"]>[0]> = [];\r\n  if (password) {\r\n    try {\r\n      const p = await browser.newPage();\r\n      await p.setViewport({\r\n        width: SCRAPER_VIEWPORT_WIDTH,\r\n        height: SCRAPER_VIEWPORT_HEIGHT,\r\n      });\r\n      await p.goto(rootUrl, {\r\n        waitUntil: SCRAPER_NAV_WAITUNTIL,\r\n        timeout: SCRAPER_NAV_TIMEOUT_MS,\r\n      });\r\n      try {\r\n        await tryLogin({ page: p, password });\r\n        if (logger) logger(\"Root login attempt complete\");\r\n      } catch (e) {\r\n        if (logger) logger(`Root login attempt failed: ${String(e)}`);\r\n      }\r\n      try {\r\n        // Collect cookies to set on seed pages to reuse session\r\n        const raw = await p.cookies();\r\n        cookies = raw.map((c) => {\r\n          let sameSite: string | undefined = undefined;\r\n          const ss = isRecord(c) ? c[\"sameSite\"] : undefined;\r\n          if (typeof ss === \"string\") sameSite = ss;\r\n          return {\r\n            name: c.name,\r\n            value: c.value,\r\n            domain: c.domain,\r\n            path: c.path,\r\n            expires: c.expires,\r\n            httpOnly: c.httpOnly,\r\n            secure: c.secure,\r\n            sameSite,\r\n          } as Parameters<PuppeteerPage[\"setCookie\"]>[0];\r\n        });\r\n      } catch (e) {\r\n        console.debug(\"prefetch seed parsing failed:\", e);\r\n      }\r\n      try {\r\n        await p.close();\r\n      } catch (e) {\r\n        console.debug(\"prefetch optional parse failed:\", e);\r\n      }\r\n    } catch (e) {\r\n      if (logger) logger(`Root prefetch/login failed: ${String(e)}`);\r\n    }\r\n  }\r\n\r\n  const workConcurrency = concurrency ?? SCRAPER_SEED_PREFETCH_CONCURRENCY;\r\n\r\n  await mapWithConcurrency(\r\n    normSeeds,\r\n    async (u) => {\r\n      let attempts = 0;\r\n      while (attempts < SCRAPER_MAX_ATTEMPTS) {\r\n        attempts++;\r\n        try {\r\n          const p = await browser.newPage();\r\n          await p.setViewport({\r\n            width: SCRAPER_VIEWPORT_WIDTH,\r\n            height: SCRAPER_VIEWPORT_HEIGHT,\r\n          });\r\n          try {\r\n            // If we collected cookies from the root login, set them on the page\r\n            if (cookies && cookies.length > 0) {\r\n              try {\r\n                // Puppeteer's setCookie expects CookieParam; spread basic fields\r\n                await p.setCookie(...cookies);\r\n              } catch (e) {\r\n                console.debug(\"prefetch loop item parse failed:\", e);\r\n              }\r\n            }\r\n            await p.goto(u, {\r\n              waitUntil: SCRAPER_NAV_WAITUNTIL,\r\n              timeout: SCRAPER_NAV_TIMEOUT_MS,\r\n            });\r\n            if (password) {\r\n              try {\r\n                await tryLogin({ page: p, password });\r\n                if (logger) logger(`Login attempt complete on seed ${u}`);\r\n              } catch (e) {\r\n                if (logger)\r\n                  logger(`Login attempt failed on seed ${u}: ${String(e)}`);\r\n              }\r\n            }\r\n\r\n            // Small wait + gentle scroll to surface lazy-loaded content\r\n            await new Promise((r) => setTimeout(r, SCRAPER_PREFETCH_WAIT_MS));\r\n            try {\r\n              const stepPx = SCRAPER_PREFETCH_SCROLL_STEP_PX;\r\n              const stepMs = SCRAPER_PREFETCH_SCROLL_STEP_MS;\r\n              const finalWait = SCRAPER_PREFETCH_FINAL_WAIT_MS;\r\n              await p.evaluate(\r\n                async (\r\n                  stepPxArg: number,\r\n                  stepMsArg: number,\r\n                  finalWaitArg: number,\r\n                  fallbackArg: number,\r\n                ) => {\r\n                  const step = stepPxArg || window.innerHeight || fallbackArg;\r\n                  let pos = 0;\r\n                  const max =\r\n                    document.body.scrollHeight ||\r\n                    document.documentElement.scrollHeight;\r\n                  while (pos < max) {\r\n                    window.scrollBy(0, step);\r\n                    await new Promise((rr) => setTimeout(rr, stepMsArg));\r\n                    pos += step;\r\n                  }\r\n                  await new Promise((rr) => setTimeout(rr, finalWaitArg));\r\n                  window.scrollTo(0, 0);\r\n                },\r\n                stepPx,\r\n                stepMs,\r\n                finalWait,\r\n                SCRAPER_PREFETCH_SCROLL_STEP_PX,\r\n              );\r\n            } catch (e) {\r\n              console.debug(\"prefetch inner error:\", e);\r\n            }\r\n\r\n            const fallback: PreExtracted = {\r\n              pageLinks: [],\r\n              normalizedImages: [],\r\n              supportedImages: [],\r\n              title: \"\",\r\n              content: \"\",\r\n            };\r\n            const extracted = await extractPageData({\r\n              page: p,\r\n              pageUrl: u,\r\n              allowedHostname: hostname,\r\n            }).catch(() => fallback);\r\n\r\n            preExtractedMap.set(u, extracted);\r\n          } finally {\r\n            try {\r\n              await p.close();\r\n            } catch (e) {\r\n              console.debug(\"prefetch finalizer error:\", e);\r\n            }\r\n          }\r\n          break; // success\r\n        } catch (err) {\r\n          if (attempts >= SCRAPER_MAX_ATTEMPTS) {\r\n            if (logger) logger(`Seed prefetch failed for ${u}: ${String(err)}`);\r\n          } else {\r\n            // small backoff\r\n            await new Promise((r) =>\r\n              setTimeout(r, SCRAPER_RETRY_BASE_MS * attempts),\r\n            );\r\n          }\r\n        }\r\n      }\r\n    },\r\n    workConcurrency,\r\n  );\r\n\r\n  return { preExtractedMap, normalizedSeeds: normSeeds };\r\n}\r\n\r\nexport default prefetchSeeds;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\processPageAndImages.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\puppeteer.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":89,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":89,"endColumn":48},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":89,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":89,"endColumn":48}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import puppeteer, { HTTPRequest, Page, Browser } from \"puppeteer\";\r\n\r\ntype BlockOptions = {\r\n  allow?: Set<string>;\r\n  block?: Set<string>;\r\n  onRequest?: (\r\n    req: HTTPRequest,\r\n    decision: \"blocked\" | \"continued\",\r\n    reason?: string,\r\n  ) => void;\r\n};\r\n\r\nexport function getBlockReason(\r\n  reqUrl: string,\r\n  rType: string,\r\n  allowSetLocal: Set<string>,\r\n  blockSetLocal: Set<string>,\r\n): string | null {\r\n  const rTypeLower = rType.toLowerCase();\r\n  if (allowSetLocal.has(rTypeLower)) return null;\r\n  const urlLower = reqUrl.toLowerCase();\r\n  let parsedHost = \"\";\r\n  let parsedPathLower = \"\";\r\n  try {\r\n    const p = new URL(reqUrl);\r\n    parsedHost = p.hostname.toLowerCase();\r\n    parsedPathLower = p.pathname.toLowerCase();\r\n  } catch {\r\n    parsedHost = \"\";\r\n    parsedPathLower = \"\";\r\n  }\r\n\r\n  if (rTypeLower === \"stylesheet\" || rTypeLower === \"font\")\r\n    return \"blocked-resource-type\";\r\n\r\n  const imageExtRe = /\\.(svg|gif|ico)(?:[?#]|$)/i;\r\n  const fontExtRe = /\\.(woff2?|ttf|otf|eot)(?:[?#]|$)/i;\r\n  try {\r\n    if (imageExtRe.test(parsedPathLower) || fontExtRe.test(parsedPathLower))\r\n      return \"blocked-ext\";\r\n  } catch (e) {\r\n    console.debug(\"extension regex test failed:\", e);\r\n  }\r\n\r\n  if (urlLower.startsWith(\"data:\")) {\r\n    const m = urlLower.match(/^data:([^;,]+)[;,]/);\r\n    const mime = m ? m[1] : \"\";\r\n    if (\r\n      mime.startsWith(\"image/svg\") ||\r\n      mime === \"image/gif\" ||\r\n      mime === \"image/x-icon\" ||\r\n      mime === \"image/vnd.microsoft.icon\" ||\r\n      mime.startsWith(\"font/\") ||\r\n      mime.includes(\"woff\") ||\r\n      mime.includes(\"truetype\") ||\r\n      mime.includes(\"opentype\")\r\n    ) {\r\n      return \"blocked-data-uri\";\r\n    }\r\n  }\r\n\r\n  if (blockSetLocal.has(rTypeLower)) return \"blocked-by-inspector\";\r\n\r\n  // host-based\r\n  if (\r\n    parsedHost === \"fast.appcues.com\" ||\r\n    parsedHost.endsWith(\".fast.appcues.com\")\r\n  )\r\n    return \"blocked-appcues-fast\";\r\n  if (parsedHost === \"snap.licdn.com\") return \"blocked-licdn-snap\";\r\n  if (parsedHost === \"sentry.io\" || parsedHost.endsWith(\".sentry.io\"))\r\n    return \"blocked-sentry\";\r\n  if (\r\n    parsedHost === \"api.zeroheight.com\" ||\r\n    parsedHost.endsWith(\".api.zeroheight.com\")\r\n  )\r\n    return \"blocked-zeroheight-api\";\r\n\r\n  return null;\r\n}\r\n\r\nexport async function launchBrowser(): Promise<Browser> {\r\n  return puppeteer.launch({\r\n    headless: true,\r\n    args: [\"--no-sandbox\", \"--disable-setuid-sandbox\"],\r\n  });\r\n}\r\n\r\nexport async function attachDefaultInterception(\r\n  page: Page,\r\n  opts?: BlockOptions,\r\n) {\r\n  const allowSet = opts?.allow ?? new Set<string>();\r\n  const blockSet = opts?.block ?? new Set<string>();\r\n  try {\r\n    await page.setRequestInterception(true);\r\n  } catch (e) {\r\n    console.debug(\"page.setRequestInterception not supported:\", e);\r\n  }\r\n\r\n  page.on(\"request\", (req: HTTPRequest) => {\r\n    const reason = getBlockReason(\r\n      req.url(),\r\n      req.resourceType(),\r\n      allowSet,\r\n      blockSet,\r\n    );\r\n    if (reason) {\r\n      opts?.onRequest?.(req, \"blocked\", reason);\r\n      void req.abort().catch((e) => console.debug(\"req.abort error:\", e));\r\n      return;\r\n    }\r\n    opts?.onRequest?.(req, \"continued\");\r\n    void req.continue().catch((e) => console.debug(\"req.continue error:\", e));\r\n  });\r\n\r\n  page.on(\"requestfailed\", (req) =>\r\n    console.debug(\"request failed:\", req.url()),\r\n  );\r\n  page.on(\"response\", () => {\r\n    // noop: consumers may attach their own handlers if they want details\r\n  });\r\n}\r\nexport const puppeteerHelper = { launchBrowser, attachDefaultInterception };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\retryHelpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\shared.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\storageHelper.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\scraper\\utils\\uploadHelpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\cancel.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\get.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\list.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\result.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\tail.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\utils\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\utils\\jobStore.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":13,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":13,"endColumn":36},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":13,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":13,"endColumn":36},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":91,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":91,"endColumn":40},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":91,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":91,"endColumn":40},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":174,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":174,"endColumn":35},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":174,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":174,"endColumn":35},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":212,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":212,"endColumn":32},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":212,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":212,"endColumn":32},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":260,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":260,"endColumn":43},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":260,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":260,"endColumn":43},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":274,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":274,"endColumn":36},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":274,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":274,"endColumn":36},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":285,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":285,"endColumn":42},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":285,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":285,"endColumn":42},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":303,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":303,"endColumn":35},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":303,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":303,"endColumn":35}],"suppressedMessages":[],"errorCount":16,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { TasksType } from \"@/database.types\";\r\nimport type { Json } from \"@/database.schema\";\r\nimport { getSupabaseAdminClient } from \"@/utils/common\";\r\nimport {\r\n  JOBID_RANDOM_START,\r\n  JOBID_RANDOM_LEN,\r\n  TESTRUNID_RANDOM_LEN,\r\n} from \"@/utils/config\";\r\nimport { isRecord, isJson, getProp } from \"../../../utils/common/typeGuards\";\r\n\r\nexport type JobRecord = TasksType;\r\n\r\nexport async function createJobInDb({\r\n  name,\r\n  args,\r\n}: {\r\n  name: string;\r\n  args?: Record<string, unknown> | null;\r\n}) {\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) {\r\n    console.error(\"createJobInDb: admin supabase client not available\");\r\n    return null;\r\n  }\r\n\r\n  const id =\r\n    Date.now().toString(36) +\r\n    Math.random()\r\n      .toString(36)\r\n      .slice(JOBID_RANDOM_START, JOBID_RANDOM_START + JOBID_RANDOM_LEN);\r\n  // Ensure `args` is JSON-serializable and compatible with the DB `Json` type.\r\n  let argsPayload: Json | null = null;\r\n  if (args) {\r\n    try {\r\n      const parsed = JSON.parse(JSON.stringify(args));\r\n      // Validate JSON-serializability before assigning to `Json`.\r\n      // Use the runtime guard to avoid an unchecked `as Json` cast.\r\n      // If it isn't serializable, fall back to `null`.\r\n      if (isJson(parsed)) argsPayload = parsed;\r\n      else argsPayload = null;\r\n    } catch {\r\n      argsPayload = null;\r\n    }\r\n  }\r\n  const payload = {\r\n    id,\r\n    name,\r\n    // SEP-1686: initial state should be `working` (the request is being processed)\r\n    status: \"working\",\r\n    args: argsPayload,\r\n  };\r\n\r\n  try {\r\n    const { error } = await supabase.from(\"tasks\").insert([payload]);\r\n    if (error) {\r\n      const errObj = error;\r\n      const details =\r\n        isRecord(errObj) && \"details\" in errObj\r\n          ? String(errObj[\"details\"])\r\n          : undefined;\r\n      const hint =\r\n        isRecord(errObj) && \"hint\" in errObj\r\n          ? String(errObj[\"hint\"])\r\n          : undefined;\r\n      const code =\r\n        isRecord(errObj) && \"code\" in errObj\r\n          ? String(errObj[\"code\"])\r\n          : undefined;\r\n      let msg: string;\r\n      if (isRecord(errObj) && typeof getProp(errObj, \"message\") === \"string\") {\r\n        msg = String(getProp(errObj, \"message\"));\r\n      } else {\r\n        msg = String(error);\r\n      }\r\n      console.error(\"createJobInDb supabase error:\", {\r\n        message: msg,\r\n        details,\r\n        hint,\r\n        code,\r\n      });\r\n      return null;\r\n    }\r\n    // ignore returned row data; we use our generated `id` value as the job id\r\n  } catch (e) {\r\n    console.error(\"createJobInDb unexpected error:\", String(e));\r\n    return null;\r\n  }\r\n  return id;\r\n}\r\n\r\nexport async function createTestJobInDb({\r\n  name,\r\n  args,\r\n  testRunId = Date.now().toString(36) +\r\n    Math.random()\r\n      .toString(36)\r\n      .slice(JOBID_RANDOM_START, JOBID_RANDOM_START + TESTRUNID_RANDOM_LEN),\r\n}: {\r\n  name: string;\r\n  args?: Record<string, unknown> | null;\r\n  testRunId?: string;\r\n}) {\r\n  const merged: Record<string, unknown> = {\r\n    ...(args || {}),\r\n    __testRunId: testRunId,\r\n  };\r\n  const id = await createJobInDb({ name, args: merged });\r\n  if (!id) {\r\n    console.error(\r\n      \"createTestJobInDb: failed to create job in DB (createJobInDb returned null)\",\r\n    );\r\n  }\r\n  return id;\r\n}\r\n\r\nexport async function claimNextJob(): Promise<JobRecord | null> {\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) return null;\r\n\r\n  try {\r\n    const { data: rows, error } = await supabase\r\n      .from(\"tasks\")\r\n      .select(\"*\")\r\n      // pick next task that is in the SEP 'working' state but hasn't started yet\r\n      .eq(\"status\", \"working\")\r\n      .order(\"created_at\", { ascending: true })\r\n      .limit(1);\r\n    if (error || !rows || rows.length === 0) return null;\r\n    const job = rows[0] as JobRecord;\r\n    const { error: updErr } = await supabase\r\n      .from(\"tasks\")\r\n      .update({ started_at: new Date().toISOString() })\r\n      .eq(\"id\", job.id);\r\n    if (updErr) {\r\n      console.error(\"claimNextJob update error:\", updErr);\r\n      return null;\r\n    }\r\n    return {\r\n      ...(job as JobRecord),\r\n      // maintain SEP `working` status; mark started_at locally\r\n      status: \"working\",\r\n      started_at: new Date().toISOString(),\r\n    } as JobRecord;\r\n  } catch (e) {\r\n    console.error(\"claimNextJob error:\", e);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function claimJobById({\r\n  jobId,\r\n}: {\r\n  jobId: string;\r\n}): Promise<JobRecord | null> {\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) return null;\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"tasks\")\r\n      // set started_at when claiming a specific job; keep SEP `working` status\r\n      .update({ started_at: new Date().toISOString() })\r\n      .eq(\"id\", jobId)\r\n      .eq(\"status\", \"working\")\r\n      .select()\r\n      .maybeSingle();\r\n    if (error || !data) return null;\r\n    return { ...(data as JobRecord), status: \"running\" } as JobRecord;\r\n  } catch (e) {\r\n    console.error(\"claimJobById error:\", e);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function appendJobLog({\r\n  jobId,\r\n  line,\r\n}: {\r\n  jobId: string;\r\n  line: string;\r\n}) {\r\n  if (!jobId) {\r\n    console.warn(\"appendJobLog called with empty jobId - skipping\");\r\n    return;\r\n  }\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) return;\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"tasks\")\r\n      .select(\"logs\")\r\n      .eq(\"id\", jobId)\r\n      .maybeSingle();\r\n    if (error) {\r\n      console.warn(\"appendJobLog select error:\", error);\r\n      return;\r\n    }\r\n    let current = \"\";\r\n    if (data && isRecord(data) && typeof getProp(data, \"logs\") === \"string\") {\r\n      current = String(getProp(data, \"logs\"));\r\n    }\r\n    const updated = current + (current ? \"\\n\" : \"\") + line;\r\n    const { error: updateErr } = await supabase\r\n      .from(\"tasks\")\r\n      .update({ logs: updated })\r\n      .eq(\"id\", jobId);\r\n    if (updateErr) console.warn(\"appendJobLog update error:\", updateErr);\r\n  } catch (e) {\r\n    console.warn(`appendJobLog failed for jobId=${jobId}: ${String(e)}`);\r\n  }\r\n}\r\n\r\nexport async function finishJob({\r\n  jobId,\r\n  success,\r\n  result,\r\n  errorMsg,\r\n}: {\r\n  jobId: string;\r\n  success: boolean;\r\n  result?: unknown;\r\n  errorMsg?: string;\r\n}) {\r\n  const body: Record<string, unknown> = { success };\r\n  if (errorMsg) body.error = errorMsg;\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) return;\r\n  const payload: Record<string, unknown> = {\r\n    finished_at: new Date().toISOString(),\r\n    status: success ? \"completed\" : \"failed\",\r\n  };\r\n  if (errorMsg) payload.error = errorMsg;\r\n  if (typeof result !== \"undefined\") payload.result = result;\r\n\r\n  try {\r\n    const { data: existingData, error: readError } = await supabase\r\n      .from(\"tasks\")\r\n      .select(\"status\")\r\n      .eq(\"id\", jobId)\r\n      .maybeSingle();\r\n    if (readError) {\r\n      console.warn(\"finishJob read error:\", readError);\r\n      return;\r\n    }\r\n    if (\r\n      existingData &&\r\n      (existingData as { status?: string }).status === \"cancelled\"\r\n    ) {\r\n      return;\r\n    }\r\n    const { error } = await supabase\r\n      .from(\"tasks\")\r\n      .update(payload)\r\n      .eq(\"id\", jobId);\r\n    if (error) console.warn(\"finishJob update error:\", error);\r\n  } catch (e) {\r\n    console.warn(\"finishJob failed:\", e);\r\n  }\r\n}\r\n\r\nexport async function markJobCancelledInDb({ jobId }: { jobId: string }) {\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) return;\r\n  try {\r\n    const { error } = await supabase\r\n      .from(\"tasks\")\r\n      .update({ status: \"cancelled\", finished_at: new Date().toISOString() })\r\n      .eq(\"id\", jobId);\r\n    if (error) console.warn(\"markJobCancelledInDb error:\", error);\r\n  } catch (e) {\r\n    console.warn(\"markJobCancelledInDb failed:\", e);\r\n  }\r\n}\r\n\r\nexport async function deleteJobInDb({ jobId }: { jobId: string }) {\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) return;\r\n  try {\r\n    const { error } = await supabase.from(\"tasks\").delete().eq(\"id\", jobId);\r\n    if (error) console.warn(\"deleteJobInDb error:\", error);\r\n  } catch (e) {\r\n    console.warn(\"deleteJobInDb failed:\", e);\r\n  }\r\n}\r\n\r\nexport async function deleteJobsByTestRun({\r\n  testRunId,\r\n}: {\r\n  testRunId: string;\r\n}) {\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) return;\r\n  try {\r\n    const { error } = await supabase\r\n      .from(\"tasks\")\r\n      .delete()\r\n      .contains(\"args\", { __testRunId: testRunId });\r\n    if (error) console.warn(\"deleteJobsByTestRun error:\", error);\r\n  } catch (e) {\r\n    console.warn(\"deleteJobsByTestRun failed:\", e);\r\n  }\r\n}\r\n\r\nexport async function getJobFromDb({ jobId }: { jobId: string }) {\r\n  const supabase = getSupabaseAdminClient();\r\n  if (!supabase) return null;\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"tasks\")\r\n      .select(\"*\")\r\n      .eq(\"id\", jobId)\r\n      .maybeSingle();\r\n    if (error) {\r\n      console.error(\"getJobFromDb error:\", error);\r\n      return null;\r\n    }\r\n    return data as JobRecord | null;\r\n  } catch (e) {\r\n    console.error(\"getJobFromDb failed:\", e);\r\n    return null;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\utils\\status.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":1,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":1,"endColumn":31},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":1,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":1,"endColumn":31}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export function mapStatusToSep({ status }: { status: string }) {\r\n  if (status === \"running\") return \"working\";\r\n  return status;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\utils\\terminal.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\tasks\\utils\\ttl.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\tools\\toolTypes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\common.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\common\\dbHelpers.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":6,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":43},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":6,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":6,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { SupabaseClient } from \"@supabase/supabase-js\";\r\nimport type { Database } from \"../../database.schema\";\r\nimport type { PagesType, ImagesType } from \"../../database.types\";\r\nimport { isRecord } from \"@/utils/common/typeGuards\";\r\n\r\nexport async function commitPagesAndImages(options: {\r\n  client: SupabaseClient<Database>;\r\n  pagesToUpsert: Array<Pick<PagesType, \"url\" | \"title\" | \"content\">>;\r\n  pendingImageRecords: Array<{\r\n    pageUrl: string;\r\n    original_url: ImagesType[\"original_url\"];\r\n    storage_path: ImagesType[\"storage_path\"];\r\n  }>;\r\n}) {\r\n  const { client: supabase, pagesToUpsert, pendingImageRecords } = options;\r\n  // Deduplicate pages\r\n  const pageMap = new Map<\r\n    string,\r\n    Pick<PagesType, \"url\" | \"title\" | \"content\">\r\n  >();\r\n  for (const p of pagesToUpsert) pageMap.set(p.url, p);\r\n  const uniquePages = Array.from(pageMap.values());\r\n\r\n  let upsertedPages: Array<{ id?: number; url?: string }> | null = null;\r\n  try {\r\n    const pagesTable = \"pages\";\r\n    // Manual retry loop to avoid typing issues with Postgrest builders\r\n    let attempts = 0;\r\n    let upsertResult: {\r\n      data?: Array<{ id?: number; url?: string }> | null;\r\n      error?: unknown | null;\r\n    } = { data: null, error: null };\r\n    while (attempts < 3) {\r\n      try {\r\n        // Await the Postgrest response directly\r\n        const res = await supabase\r\n          .from(pagesTable)\r\n          .upsert(uniquePages, { onConflict: \"url\" })\r\n          .select(\"id, url\");\r\n        upsertResult = res;\r\n        if (!res.error) break;\r\n      } catch (err) {\r\n        upsertResult = { error: err, data: null };\r\n      }\r\n      attempts++;\r\n      if (attempts < 3) await new Promise((r) => setTimeout(r, 500));\r\n    }\r\n\r\n    if (upsertResult.error) {\r\n      console.error(\"Error bulk upserting pages:\", upsertResult.error);\r\n    }\r\n    upsertedPages = upsertResult.data || null;\r\n  } catch (e) {\r\n    console.error(\"Unexpected error upserting pages:\", e);\r\n  }\r\n\r\n  const urlToId = new Map<string, number>();\r\n  (upsertedPages || []).forEach((p) => {\r\n    if (p && p.url && p.id) urlToId.set(p.url, p.id);\r\n  });\r\n\r\n  const imagesToInsert: Array<{\r\n    page_id: number;\r\n    original_url: ImagesType[\"original_url\"];\r\n    storage_path: ImagesType[\"storage_path\"];\r\n  }> = [];\r\n  for (const r of pendingImageRecords) {\r\n    const page_id = urlToId.get(r.pageUrl);\r\n    if (!page_id) continue;\r\n    imagesToInsert.push({\r\n      page_id,\r\n      original_url: r.original_url,\r\n      storage_path: r.storage_path,\r\n    });\r\n  }\r\n\r\n  if (imagesToInsert.length > 0) {\r\n    try {\r\n      const imagesTable = \"images\";\r\n      // Manual retry for image inserts\r\n      let attempts = 0;\r\n      let insertResult: { error?: unknown | null } = { error: null };\r\n      while (attempts < 3) {\r\n        try {\r\n          const res = await supabase.from(imagesTable).insert(imagesToInsert);\r\n          insertResult = res;\r\n          if (!res.error) break;\r\n        } catch (err) {\r\n          insertResult = { error: err };\r\n        }\r\n        attempts++;\r\n        if (attempts < 3) await new Promise((r) => setTimeout(r, 500));\r\n      }\r\n      let insertImagesError: unknown | null = null;\r\n      if (isRecord(insertResult))\r\n        insertImagesError = insertResult.error ?? null;\r\n      if (insertImagesError) {\r\n        console.error(\"Error bulk inserting images:\", insertImagesError);\r\n      }\r\n    } catch (e) {\r\n      console.error(\"Unexpected error inserting images:\", e);\r\n    }\r\n  }\r\n\r\n  return {\r\n    pagesUpserted: upsertedPages?.length || 0,\r\n    imagesInserted: imagesToInsert.length,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\common\\errors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\common\\progress.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":25,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":25,"endColumn":38},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":25,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":25,"endColumn":38},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":36,"column":3,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":36,"endColumn":23},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":46,"column":3,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":46,"endColumn":23}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export type Progress = {\r\n  current: number;\r\n  total: number;\r\n  pagesProcessed?: number;\r\n  imagesProcessed?: number;\r\n};\r\n\r\nexport function createProgressBar({\r\n  current,\r\n  total,\r\n  width = 20,\r\n}: {\r\n  current: number;\r\n  total: number;\r\n  width?: number;\r\n}): string {\r\n  // Guard against division by zero\r\n  const safeTotal = total <= 0 ? 1 : total;\r\n  const filledBars = Math.min(Math.round((current / safeTotal) * width), width);\r\n  const emptyBars = width - filledBars;\r\n  const progressBar = \"‚ñà\".repeat(filledBars) + \"‚ñë\".repeat(emptyBars);\r\n  return `[${progressBar}]`;\r\n}\r\n\r\nexport function createProgressHelpers(options: {\r\n  progress: Progress;\r\n  checkProgressInvariant: (opts: {\r\n    overallProgress: Progress;\r\n    context?: string;\r\n  }) => void;\r\n  logger?: (msg: string) => void;\r\n}) {\r\n  const { progress, checkProgressInvariant, logger } = options;\r\n  const out = logger ?? ((msg: string) => console.log(msg));\r\n\r\n  function logProgress(icon: string, message: string) {\r\n    const progressBar = createProgressBar({\r\n      current: progress.current,\r\n      total: progress.total,\r\n    });\r\n    out(\r\n      `${progressBar} [${progress.current}/${progress.total}] ${icon} ${message}`,\r\n    );\r\n  }\r\n\r\n  function markAttempt(reason: string, icon: string, message: string) {\r\n    progress.current++;\r\n    checkProgressInvariant({ overallProgress: progress, context: reason });\r\n    logProgress(icon, message);\r\n  }\r\n\r\n  return { logProgress, markAttempt };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\common\\scraperHelpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\common\\supabaseClients.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":7,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":7,"endColumn":26},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":7,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":7,"endColumn":26},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":114,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":114,"endColumn":39},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":114,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":114,"endColumn":39}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3237,3240],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3237,3240],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getSupabaseClient, getSupabaseAdminClient } from \"../common\";\r\nimport { isRecord, getProp } from \"@/utils/common/typeGuards\";\r\nimport { IMAGE_BUCKET } from \"../config\";\r\n\r\n// Provide a single wrapper that exposes the regular client and a storage helper\r\n// which will prefer admin capabilities when an admin client is available.\r\nexport function getClient() {\r\n  const client = getSupabaseClient();\r\n  const admin = getSupabaseAdminClient();\r\n\r\n  const storage = {\r\n    // upload a buffer to the configured bucket; prefer admin client when available\r\n    upload: async (filename: string, file: Buffer) => {\r\n      const svc = admin ?? client!;\r\n      return await svc.storage.from(IMAGE_BUCKET).upload(filename, file, {\r\n        cacheControl: \"3600\",\r\n        upsert: true,\r\n        contentType: \"image/webp\",\r\n      });\r\n    },\r\n    // list/create buckets are only available with admin privileges\r\n    listBuckets: admin\r\n      ? async () => {\r\n          const res = await admin.storage.listBuckets();\r\n          if (isRecord(res)) {\r\n            const data = getProp(res, \"data\");\r\n            const errorRaw = getProp(res, \"error\");\r\n            const dataOut = Array.isArray(data)\r\n              ? data\r\n                  .filter(\r\n                    (it: unknown): it is Record<string, unknown> =>\r\n                      isRecord(it) && typeof getProp(it, \"name\") === \"string\",\r\n                  )\r\n                  .map((it) => ({ name: String(getProp(it, \"name\")) }))\r\n              : null;\r\n            const errorOut =\r\n              isRecord(errorRaw) &&\r\n              typeof getProp(errorRaw, \"message\") === \"string\"\r\n                ? { message: String(getProp(errorRaw, \"message\")) }\r\n                : errorRaw\r\n                  ? { message: String(errorRaw) }\r\n                  : null;\r\n            return { data: dataOut, error: errorOut };\r\n          }\r\n          return { data: null, error: { message: String(res) } };\r\n        }\r\n      : undefined,\r\n    // createBucket uses admin-only storage API. The runtime shape of `opts`\r\n    // is compatible with the client but the exact param type depends on\r\n    // the Supabase client types; cast with a narrow, documented shape and\r\n    // use an eslint exception for the explicit any used in the call.\r\n    createBucket: admin\r\n      ? async (\r\n          name: string,\r\n          opts?: {\r\n            public?: boolean;\r\n            allowedMimeTypes?: string[] | null;\r\n            fileSizeLimit?: number | null;\r\n          },\r\n        ) => {\r\n          // Access the runtime `createBucket` function safely and call it.\r\n          const maybeStorage = admin.storage;\r\n          if (\r\n            isRecord(maybeStorage) &&\r\n            typeof maybeStorage[\"createBucket\"] === \"function\"\r\n          ) {\r\n            const maybeCreate = getProp(maybeStorage, \"createBucket\");\r\n            let res: unknown;\r\n            if (typeof maybeCreate === \"function\") {\r\n              // Call the runtime function; narrow the call site with a typed invocation\r\n              // (we avoid assuming the exact client signature at compile time)\r\n              // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n              res = await (maybeCreate as (...a: any[]) => Promise<unknown>)(\r\n                name,\r\n                opts,\r\n              );\r\n            } else {\r\n              return {\r\n                data: undefined,\r\n                error: { message: \"createBucket not available\" },\r\n              };\r\n            }\r\n            if (isRecord(res)) {\r\n              const dataRaw = getProp(res, \"data\");\r\n              const errorRaw = getProp(res, \"error\");\r\n              const dataOut =\r\n                isRecord(dataRaw) &&\r\n                typeof getProp(dataRaw, \"name\") === \"string\"\r\n                  ? { name: String(getProp(dataRaw, \"name\")) }\r\n                  : null;\r\n              const errorOut =\r\n                isRecord(errorRaw) &&\r\n                typeof getProp(errorRaw, \"message\") === \"string\"\r\n                  ? { message: String(getProp(errorRaw, \"message\")) }\r\n                  : errorRaw\r\n                    ? { message: String(errorRaw) }\r\n                    : null;\r\n              return { data: dataOut, error: errorOut };\r\n            }\r\n            return { data: undefined, error: { message: String(res) } };\r\n          }\r\n          return {\r\n            data: undefined,\r\n            error: { message: \"createBucket not available\" },\r\n          };\r\n        }\r\n      : undefined,\r\n  };\r\n\r\n  return { client, storage };\r\n}\r\n\r\n// Simple runtime invariant check for progress tracking\r\nexport function checkProgressInvariant({\r\n  overallProgress,\r\n  context,\r\n}: {\r\n  overallProgress: { current: number; total: number };\r\n  context?: string;\r\n}) {\r\n  if (overallProgress.current > overallProgress.total) {\r\n    console.warn(\r\n      `‚ö†Ô∏è Progress invariant violated${context ? ` (${context})` : \"\"}: current (${overallProgress.current}) > total (${overallProgress.total})`,\r\n    );\r\n  }\r\n  if (overallProgress.current < 0) {\r\n    console.warn(\r\n      `‚ö†Ô∏è Progress invariant violated${context ? ` (${context})` : \"\"}: current is negative (${overallProgress.current})`,\r\n    );\r\n  }\r\n  if (overallProgress.total < 0) {\r\n    console.warn(\r\n      `‚ö†Ô∏è Progress invariant violated${context ? ` (${context})` : \"\"}: total is negative (${overallProgress.total})`,\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\common\\typeGuards.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\image-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\server\\apiHelpers.ts","messages":[{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":35,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":35,"endColumn":31},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":35,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":35,"endColumn":31},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":45,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":45,"endColumn":22},{"ruleId":"@typescript-eslint/explicit-function-return-type","severity":2,"message":"Missing return type on function.","line":53,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":53,"endColumn":35},{"ruleId":"@typescript-eslint/explicit-module-boundary-types","severity":2,"message":"Missing return type on function.","line":53,"column":8,"nodeType":"FunctionDeclaration","messageId":"missingReturnType","endLine":53,"endColumn":35}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from \"fs\";\r\nimport path from \"path\";\r\nimport { NextRequest } from \"next/server\";\r\nimport { isRecord } from \"../common/typeGuards\";\r\n\r\ntype Bucket = { tokens: number; lastRefill: number };\r\n\r\nconst RATE_LIMIT_WINDOW_MS = 60_000; // 1 minute\r\nimport { SERVER_RATE_LIMIT_TOKENS } from \"@/utils/config\";\r\nconst RATE_LIMIT_TOKENS = SERVER_RATE_LIMIT_TOKENS;\r\n\r\nconst buckets = new Map<string, Bucket>();\r\n\r\nfunction getBucket(key: string): Bucket {\r\n  const now = Date.now();\r\n  let b = buckets.get(key);\r\n  if (!b) {\r\n    b = { tokens: RATE_LIMIT_TOKENS, lastRefill: now };\r\n    buckets.set(key, b);\r\n    return b;\r\n  }\r\n  const elapsed = now - b.lastRefill;\r\n  if (elapsed > 0) {\r\n    const refill = Math.floor(\r\n      (elapsed / RATE_LIMIT_WINDOW_MS) * RATE_LIMIT_TOKENS,\r\n    );\r\n    if (refill > 0) {\r\n      b.tokens = Math.min(RATE_LIMIT_TOKENS, b.tokens + refill);\r\n      b.lastRefill = now;\r\n    }\r\n  }\r\n  return b;\r\n}\r\n\r\nexport function checkRateLimit({ apiKey }: { apiKey: string }) {\r\n  const bucket = getBucket(apiKey || \"anon\");\r\n  if (bucket.tokens <= 0) return false;\r\n  bucket.tokens -= 1;\r\n  return true;\r\n}\r\n\r\nconst LOG_DIR = path.resolve(process.cwd(), \"logs\");\r\nconst AUDIT_LOG = path.join(LOG_DIR, \"api-audit.log\");\r\n\r\nfunction ensureLogDir() {\r\n  try {\r\n    if (!fs.existsSync(LOG_DIR)) fs.mkdirSync(LOG_DIR, { recursive: true });\r\n  } catch {\r\n    // ignore\r\n  }\r\n}\r\n\r\nexport async function auditRequest({\r\n  req,\r\n  route,\r\n  details,\r\n  bodyProvided,\r\n}: {\r\n  req: NextRequest;\r\n  route: string;\r\n  details?: Record<string, unknown>;\r\n  bodyProvided?: string | Record<string, unknown>;\r\n}) {\r\n  try {\r\n    ensureLogDir();\r\n    const now = new Date().toISOString();\r\n    const key = req.headers.get(\"x-server-api-key\") || \"\";\r\n    const masked = key ? `${key.slice(0, 4)}...${key.slice(-4)}` : \"\";\r\n    const ip =\r\n      req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"\";\r\n    // use provided body if present (so callers can avoid double-read)\r\n    let body: string | Record<string, unknown> | undefined;\r\n    if (bodyProvided === undefined) {\r\n      try {\r\n        const txt = await req.text();\r\n        if (txt) {\r\n          try {\r\n            body = JSON.parse(txt);\r\n          } catch {\r\n            body = txt;\r\n          }\r\n        }\r\n      } catch {\r\n        body = undefined;\r\n      }\r\n    } else if (typeof bodyProvided === \"string\") {\r\n      body = bodyProvided;\r\n    } else if (isRecord(bodyProvided)) {\r\n      body = bodyProvided;\r\n    } else {\r\n      body = undefined;\r\n    }\r\n\r\n    const entry = {\r\n      ts: now,\r\n      route,\r\n      method: req.method,\r\n      apiKey: masked,\r\n      ip,\r\n      details: details || {},\r\n      body,\r\n    };\r\n    fs.appendFileSync(AUDIT_LOG, JSON.stringify(entry) + \"\\n\");\r\n  } catch (err) {\r\n    // don't let auditing break the request flow\r\n    // console.error allowed here for server-side visibility\r\n    console.error(\"auditRequest error\", err);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\src\\utils\\toolResponses.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\draxx\\repos\\zeroheight-mcp\\tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]